Imports Danone.MilkSystem.Business
Imports System.Data
Imports System.Math
Imports System.Net.Mail
Imports System.IO


Partial Class frm_central_pedido
    Inherits Page

    Private customPage As RK.PageTools.CustomPage


    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        customPage = MenuTools.getInitialContext(HttpContext.Current, "frm_central_pedido.aspx")
        If Not Page.IsPostBack Then
            loadDetails()
        End If

    End Sub

    Private Sub loadDetails()

        Try
 
            If Not (Request("id_central_pedido") Is Nothing) Then
                Dim parametroMilk As New Parametro
                ViewState.Item("nr_politica_parcelas") = parametroMilk.nr_politica_parcelas 'fase 3

                ViewState.Item("id_central_pedido") = Request("id_central_pedido")
                'fran 08/2014 fase 3 i
                ViewState.Item("ReabrirPedido") = "N"
                If Not (Request("tela") Is Nothing) Then
                    ViewState.Item("tela") = Request("tela").ToString
                    If ViewState.Item("tela").ToString.Equals("lst_central_pedido_reabrir.aspx") Then
                        ViewState.Item("ReabrirPedido") = "S"
                        btn_adicionar_pagto_fornecedor.Visible = True

                    End If
                Else
                    ViewState.Item("tela") = String.Empty
                End If
                'fran 08/2014 fase 3 f

                'carrega cotações
                loadData()
            Else
                ViewState.Item("id_central_pedido") = "0"
            End If


        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try


    End Sub
    Private Sub loadData()


        Try

            Dim liestabelecimento As Integer
            Dim pedido As New Pedido()
            pedido.id_central_pedido = Convert.ToInt32(ViewState.Item("id_central_pedido"))
            Dim dspedido As DataSet = pedido.getPedidoByFilters
            With dspedido.Tables(0).Rows(0)
                lbl_total_pedido.Text = FormatCurrency(.Item("nr_total_pedido").ToString, 2)
                lbl_id_central_pedido.Text = .Item("id_central_pedido")
                lbl_cotacao.Text = .Item("id_central_cotacao").ToString
                lbl_dt_pedido.Text = DateTime.Parse(.Item("dt_pedido")).ToString("dd/MM/yyyy")
                lbl_estabelecimento.Text = .Item("ds_estabelecimento")
                'fran fase 3 i
                If .Item("st_pedido_indireto").Equals("S") Then
                    ViewState.Item("pedidoindireto") = "S"
                    img_pedido_indireto.ImageUrl = "~/img/ico_chk_true.gif"
                Else
                    ViewState.Item("pedidoindireto") = "N"
                    img_pedido_indireto.ImageUrl = "~/img/ico_chk_false.gif"
                End If
                'fran fase 3 f
                'fran dezembro/2018 i mais solidos
                If .Item("st_evento_compras").Equals("S") Then
                    chk_compras_evento.Checked = True
                    img_compras_evento.ImageUrl = "~/img/ico_chk_true.gif"
                Else
                    chk_compras_evento.Checked = False
                    img_compras_evento.ImageUrl = "~/img/ico_chk_false.gif"

                End If
                'fran dezembro/2018 f mais solidos

                lbl_propriedade.Text = String.Concat(.Item("id_propriedade").ToString, " - ", .Item("nm_propriedade").ToString)
                lbl_up.Text = .Item("nr_unid_producao").ToString
                lbl_nm_cidade.Text = .Item("nm_cidade")
                lbl_cd_uf.Text = .Item("cd_uf")
                lbl_ds_contato.Text = .Item("ds_contato")
                lbl_ds_email.Text = .Item("ds_email")
                lbl_ds_telefone.Text = .Item("ds_telefone_1")
                lbl_ds_fax.Text = .Item("ds_telefone_fax")
                lbl_nm_produtor.Text = String.Concat(.Item("cd_produtor"), " - ", .Item("nm_produtor"))
                lbl_situacao_pedido.Text = .Item("nm_situacao_pedido").ToString
                ViewState.Item("id_situacao_pedido") = .Item("id_situacao_pedido") 'fran 01/05/2005 chamado 812
                ViewState.Item("id_fornecedor") = .Item("id_fornecedor")
                ViewState.Item("id_produtor") = .Item("id_pessoa")
                ViewState.Item("id_propriedade") = .Item("id_propriedade")
                ViewState.Item("nm_estabelecimento") = .Item("nm_estabelecimento") 'fran 14/05/2010 chamado 816
                liestabelecimento = .Item("id_estabelecimento") 'fran 10/2018 
                If .Item("nm_abreviado_fornecedor").ToString.Equals(String.Empty) Then
                    lbl_parceiro.Text = .Item("ds_fornecedor")
                Else
                    lbl_parceiro.Text = .Item("ds_abreviado_fornecedor")
                End If
                'fran fase 3 - se reaberto  i
                If .Item("id_situacao_pedido") = 4 Then
                    ViewState.Item("ReabrirPedido") = "S"
                    tr_atualizar_parcelamento.Visible = True 'fran 08/2015 se é pedido reaberto visualiza atualçização de parcelamento
                Else
                    ViewState.Item("ReabrirPedido") = "N"
                    tr_atualizar_parcelamento.Visible = False 'fran 08/2015 se não é pedido reaberto não visualiza atualçização de parcelamento
                End If
                'fran fase 3 - se reaberto  f 

                'fran 30/07/2010 i chamado 682
                ViewState.Item("id_grupo") = .Item("id_grupo")
                If .Item("id_grupo") = "3" Then 'se transportador
                    lbl_label_parceiro.Text = "Parceiro de Frete:"
                    lbl_titulo.Visible = True
                    tr_entregas.Visible = False
                    tr_entregas_grid.Visible = False
                    'fran 26/08/2010 i chamado 946 - Deve visualizar grid desconto ao produtor
                    'tr_desc_produtor.Visible = False
                    'tr_desc_produtor_grid.Visible = False
                    'fran 26/08/2010 f
                    lk_email_produtor.Visible = False
                    img_notificacao.Visible = False
                    lk_email_parceiro.Text = "Email Parceiro Frete"
                End If
                'fran 30/07/2010 f chamado 682

                'fran 25/03/2012 i themis
                If .Item("st_transferencia_volume") = "S" Then
                    tr_transferencia.Visible = True
                    lbl_transferencia.Text = "SIM"
                    Dim unidprod As New UnidadeProducao(.Item("id_unid_producao_origem"))
                    lbl_propriedadeup_origem.Text = String.Concat(.Item("id_propriedade_origem").ToString, "-", unidprod.nr_unid_producao)
                    lbl_pedido_origem.Text = .Item("id_central_pedido_origem").ToString
                    grdDescProdutor.Columns.Item(6).Visible = True
                    grdDescProdutor.Columns.Item(7).Visible = True
                    grdDescProdutor.Columns.Item(8).Visible = True
                    gridPagtoForn.Columns.Item(7).Visible = True
                    gridPagtoForn.Columns.Item(8).Visible = True
                    gridPagtoForn.Columns.Item(9).Visible = True

                Else
                    tr_transferencia.Visible = False
                    'grdDescProdutor.Columns.Item(5).Visible = False fran themis 15/05/2012 - para demonstrar se ja foi efetivado calculo
                    grdDescProdutor.Columns.Item(7).Visible = False
                    grdDescProdutor.Columns.Item(8).Visible = False
                    'gridPagtoForn.Columns.Item(7).Visible = False fran themis 15/05/2012 - para demonstrar que ja foi exportado
                    gridPagtoForn.Columns.Item(8).Visible = False
                    gridPagtoForn.Columns.Item(9).Visible = False

                End If


            End With

            'fran programa mais solido 10/2018 
            '****************************************************************************************
            'MAIS SOLIDOS
            '***************************************************************************************
            'se tem grid produtor
            If ViewState.Item("pedidoindireto").ToString.Equals("N") Then
                ViewState.Item("id_propriedade_titular") = 0
                ViewState.Item("id_poupanca_parametro") = 0
                ViewState.Item("ms_dt_referencia_ini") = String.Empty
                ViewState.Item("ms_dt_referencia_fim") = String.Empty
                ViewState.Item("ms_dt_referencia") = String.Empty
                ViewState.Item("maissolidossaldodisponivel") = String.Empty
                ViewState.Item("maissolidospremiado") = False

                Dim poupancaparametro As New PoupancaParametro
                poupancaparametro.id_estabelecimento = liestabelecimento
                poupancaparametro.situacao = "2|3" 'ultimo fechado ou liberado
                Dim dspoupancaparametro As DataSet = poupancaparametro.getPoupancaParametrobySituacao()
                'busca o ulytimo periodo do programa liberado ou finalizado para buscar premiacao
                If dspoupancaparametro.Tables(0).Rows.Count > 0 Then
                    ViewState.Item("ms_dt_referencia_ini") = CDate(dspoupancaparametro.Tables(0).Rows(0).Item("dt_referencia_ini"))
                    ViewState.Item("ms_dt_referencia_fim") = CDate(dspoupancaparametro.Tables(0).Rows(0).Item("dt_referencia_fim"))
                    ViewState.Item("ms_dt_referencia") = CDate(DateAdd(DateInterval.Month, 1, ViewState.Item("ms_dt_referencia_fim")))

                    'se a data do pedido for menor que a referencia apos o termino do periodo de pounpanca (outubro), nao deve exibir nada do mais solidos
                    If (CDate(lbl_dt_pedido.Text) < CDate(ViewState.Item("ms_dt_referencia").ToString)) Or (CDate(lbl_dt_pedido.Text) >= DateAdd(DateInterval.Month, 10, CDate(ViewState.Item("ms_dt_referencia").ToString))) Then
                        tr_maissolidos.Visible = False
                        grdDescProdutor.Columns.Item(5).Visible = False
                        chk_utilizarmaissolidos.Visible = False
                    Else
                        Dim maissolidos As New Poupanca()
                        maissolidos.id_pessoa = Convert.ToInt32(ViewState.Item("id_produtor"))
                        maissolidos.dt_referencia = ViewState.Item("ms_dt_referencia").ToString
                        'VERIFICA SE O PRODUTOR TEM PREMIACAO 
                        'Busca os dados do premio do produtor se encontrar. Caso o produtor seja de grupo de relacionamento, busca o programa pela propriedade titular
                        Dim dsmaissolidospremio As DataSet = maissolidos.getMaisSolidosProdutorPremiado
                        If (dsmaissolidospremio.Tables(0).Rows.Count > 0) Then
                            ViewState.Item("maissolidospremiado") = True
                            tr_maissolidos.Visible = True
                            chk_utilizarmaissolidos.Visible = True
                            grdDescProdutor.Columns.Item(5).Visible = True

                            With dsmaissolidospremio.Tables(0).Rows(0)
                                ViewState.Item("id_propriedade_titular") = .Item("id_propriedade_titular")
                                If IsDBNull(ViewState.Item("id_propriedade_titular")) Then
                                    ViewState.Item("id_propriedade_titular") = 0
                                End If
                                If ViewState.Item("id_propriedade_titular") = 0 Then
                                    lbl_ms_propriedade_titular.Text = String.Empty
                                Else
                                    lbl_ms_propriedade_titular.Text = ViewState.Item("id_propriedade_titular")
                                End If
                                lbl_ms_valor_premio.Text = FormatCurrency(.Item("nr_valor_premio"), 2)
                                'ViewState.Item("nr_ordem") = .Item("nr_ordem")
                                'ViewState.Item("nr_categoria") = .Item("nr_categoria")
                                ViewState.Item("id_poupanca_parametro") = .Item("id_poupanca_parametro")
                            End With

                            'BUSCAR O SALDO DISPONIVEL DO PROGRAMA MAIS SOLIDO
                            If CInt(ViewState.Item("id_propriedade_titular")) > 0 Then
                                maissolidos.id_propriedade_titular = ViewState.Item("id_propriedade_titular")
                                maissolidos.id_pessoa = 0
                            Else
                                maissolidos.id_pessoa = Convert.ToInt32(ViewState.Item("id_produtor"))
                                maissolidos.id_propriedade_titular = 0
                            End If
                            maissolidos.id_poupanca_parametro = ViewState.Item("id_poupanca_parametro")
                            Dim lnrmssaldodisponivel As Decimal = maissolidos.getMaisSolidosProdutorSaldoDisponivel
                            lbl_ms_valor_disponivel.Text = FormatCurrency(lnrmssaldodisponivel, 2)
                            ViewState.Item("maissolidossaldodisponivel") = lnrmssaldodisponivel
                            'se o valor disponivel é zero ou seja 
                            If lnrmssaldodisponivel = 0 Then
                                chk_utilizarmaissolidos.Visible = False
                            Else
                                chk_utilizarmaissolidos.Visible = True
                            End If

                        Else 'se nao encontrou parametro de poupanca
                            tr_maissolidos.Visible = False
                            chk_utilizarmaissolidos.Visible = False
                            grdDescProdutor.Columns.Item(5).Visible = False
                        End If

                    End If
                Else
                    tr_maissolidos.Visible = False
                    chk_utilizarmaissolidos.Visible = False
                    grdDescProdutor.Columns.Item(5).Visible = False
                End If
            Else
                tr_maissolidos.Visible = False
                chk_utilizarmaissolidos.Visible = False
                grdDescProdutor.Columns.Item(5).Visible = False
            End If

            'fran programa mais solido 10/2018 f

            'fran fase 2 melhoria i
            pedido.id_propriedade = Convert.ToInt32(ViewState.Item("id_propriedade").ToString)
            lbl_total_pedidos_em_aberto.Text = FormatCurrency(pedido.getTotalPedidosAbertos, 2)
            'fran fase 2 melhoria f

            'se situcao for  3(finaloizado) ou 2 Cancelado
            'não deixa mais atualizar dados do pedido
            'If CInt(dspedido.Tables(0).Rows(0).Item("id_situacao_pedido").ToString) = 3 Or CInt(dspedido.Tables(0).Rows(0).Item("id_situacao_pedido").ToString) = 2 Then
            If CInt(dspedido.Tables(0).Rows(0).Item("id_situacao_pedido").ToString) = 3 Or CInt(dspedido.Tables(0).Rows(0).Item("id_situacao_pedido").ToString) = 2 Or CInt(dspedido.Tables(0).Rows(0).Item("id_situacao_pedido").ToString) = 5 Or CInt(dspedido.Tables(0).Rows(0).Item("id_situacao_pedido").ToString) = 7 Then
                lk_gerar_pedido.Enabled = False
                'gridItens.Columns.Item(9).Visible = False 'fran 30/06/2010 i deve exibir ICMS
                'gridEntrega.Columns.Item(10).Visible = False

                'fran 5/04/2012 i themis transfvolume
                'gridPagtoForn.Columns.Item(6).Visible = False
                'grdDescProdutor.Columns.Item(5).Visible = False
                gridPagtoForn.Columns.Item(10).Visible = False
                grdDescProdutor.Columns.Item(9).Visible = False
                'fran 5/04/2012 f

                'fran 26/08/2010 i chamado 946 - Deve visualizar grid desconto ao produtor
                If ViewState.Item("id_grupo") = "3" Then
                    lk_email_parceiro.Enabled = False
                    lk_email_produtor.Enabled = False
                Else
                    'fran 26/08/2010 f chamado 946 - Deve visualizar grid desconto ao produtor
                    lk_email_parceiro.Enabled = True
                    lk_email_produtor.Enabled = True

                End If

                'If CInt(dspedido.Tables(0).Rows(0).Item("id_situacao_pedido").ToString) = 2 Then 'se cancelado
                If (CInt(dspedido.Tables(0).Rows(0).Item("id_situacao_pedido").ToString) = 2 Or CInt(dspedido.Tables(0).Rows(0).Item("id_situacao_pedido").ToString) = 7 Or CInt(dspedido.Tables(0).Rows(0).Item("id_situacao_pedido").ToString) = 5) Then
                    gridEntrega.Columns.Item(5).Visible = False
                    lk_email_parceiro.Enabled = False
                    lk_email_produtor.Enabled = False
                End If

                btn_incluir_parcelas_fornecedor.Enabled = False  'fran fase 3 08/2014 i
                btn_incluir_parcelas_produtor.Enabled = False  'fran fase 3 08/2014 i

                'fran dezembro/2018 i mais solidos
                'se estiver finalizado so visualiza
                chk_compras_evento.Visible = False
                img_compras_evento.Visible = True
                'fran dezembro/2018 f

            Else
                'fran fase 3 08/2014 i
                If ViewState.Item("ReabrirPedido").ToString.Equals("S") Then 'se está reabrindo pedido
                    'gridPagtoForn.Columns.Item(6).Visible = False 'fornecedor tb deve participar da reabertura
                    'gridPagtoForn.Columns.Item(9).Visible = False
                    'lk_email_parceiro.Enabled = False
                    loadParcelasProdutorFornecedorPedidoReaberto()
                Else
                    'Carrega parcelas se pedido nao estiver finalizado nem estiver reabrindo pedido
                    loadParcelasProdutorFornecedor() 'fran 11/2014 fase 3 melhorias i so carrega parcelas se não estiver finalizado

                End If
                'fran fase 3 08/2014 f

                'fran dezembro/2018 i mais solidos
                'se nao estiver finalizado ou cancelado deixa editar
                chk_compras_evento.Visible = True
                img_compras_evento.Visible = False
                'fran dezembro/2018 f

            End If

            loadGridItens()
            loadGridEntrega()
            loadGridPagtoFornecedor()
            'fran fase 3 09/2014 i
            If ViewState.Item("pedidoindireto").ToString.Equals("N") Then
                loadGridDescontoProdutor()
            Else
                gridPagtoForn.Columns.Item(7).Visible = False 'Exportação

                tr_desc_produtor.Visible = False
                tr_desc_produtor_grid.Visible = False
                lk_email_produtor.Visible = False
                tr_desc_produtor_incluir.Visible = False

            End If
            'fran fase 3 09/2014 f

            loadGridObservacao() 'fran 08/2014 i


        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try


    End Sub




    Protected Sub lk_voltar_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles lk_voltar.Click

        'fran 08/2014 fase 3 i
        'Response.Redirect("lst_central_pedido.aspx")

        Select Case ViewState.Item("tela").ToString
            Case String.Empty
                Response.Redirect("lst_central_pedido.aspx")
            Case "frm_central_solicitar_cotacao.aspx"
                Response.Redirect("frm_central_solicitar_cotacao.aspx?id_central_cotacao=" + lbl_cotacao.Text)

            Case "lst_central_pedido_reabrir.aspx"
                Response.Redirect("lst_central_pedido_reabrir.aspx")
        End Select
        'fran 08/2014 fase 3 f


    End Sub


    Protected Overrides Sub Finalize()
        MyBase.Finalize()
    End Sub

    Protected Sub lk_voltarFooter_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles lk_voltarFooter.Click
        'Response.Redirect("lst_central_pedido.aspx")
        'fran 08/2014 fase 3 i
        'Response.Redirect("lst_central_pedido.aspx")

        Select Case ViewState.Item("tela").ToString
            Case String.Empty
                Response.Redirect("lst_central_pedido.aspx")
            Case "frm_central_solicitar_cotacao.aspx"
                Response.Redirect("frm_central_solicitar_cotacao.aspx?id_central_cotacao=" + lbl_cotacao.Text)

            Case "lsl_central_pedido_reabrir.aspx"
                Response.Redirect("lst_central_pedido_reabrir.aspx")
        End Select
        'fran 08/2014 fase 3 f


    End Sub



    'fran 07/05/2010 i chamado 828
    'Protected Sub lk_novo_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles lk_novo.Click
    '   Response.Redirect("frm_central_pedido.aspx")
    '
    '
    'End Sub

    Protected Sub gridItens_PageIndexChanging(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewPageEventArgs) Handles gridItens.PageIndexChanging
        gridItens.PageIndex = e.NewPageIndex
        loadData()

    End Sub
    Protected Sub gridItens_RowCommand(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewCommandEventArgs) Handles gridItens.RowCommand
        Select Case e.CommandName.ToString().ToLower()
            Case "cotacoes"
                Dim lbl_id_central_pedido_item As Label = CType(gridItens.Rows.Item(e.CommandArgument.ToString).FindControl("lbl_id_central_pedido_item"), Label)
                Dim lbl_item As Label = CType(gridItens.Rows.Item(e.CommandArgument.ToString).FindControl("lbl_item"), Label)
                Dim lbl_st_parcelamento As Label = CType(gridItens.Rows.Item(e.CommandArgument.ToString).FindControl("lbl_st_parcelamento"), Label) 'fran fase 3
                Dim lbl_nr_quantidade As Label = CType(gridItens.Rows.Item(e.CommandArgument.ToString).FindControl("lbl_nr_quantidade"), Label)
                Dim cd_item As DataControlFieldCell = CType(gridItens.Rows.Item(e.CommandArgument.ToString).Cells(1), DataControlFieldCell)
                Dim nm_item As DataControlFieldCell = CType(gridItens.Rows.Item(e.CommandArgument.ToString).Cells(2), DataControlFieldCell)
                ViewState.Item("id_central_pedido_item") = lbl_id_central_pedido_item.Text
                ViewState.Item("lbl_detalhe_item") = String.Concat(cd_item.Text, " - ", nm_item.Text)
                ViewState.Item("id_item") = lbl_item.Text
                ViewState.Item("nr_quantidade_item") = lbl_nr_quantidade.Text
                ViewState.Item("st_parcelamento") = lbl_st_parcelamento.Text 'fran fase 3

                'fran 10/02/2010 i chamado 687
                'fran chamado 998 i
                'If UCase(lbl_situacao_pedido.Text.Trim) = "FINALIZADO" Then
                If UCase(lbl_situacao_pedido.Text.Trim) = "FINALIZADO" Or UCase(lbl_situacao_pedido.Text.Trim) = "CANCELADO" Then
                    'fran chamado 998 f
                    btn_adicionar_cotacao.Enabled = False
                    btn_adicionar_desconto_prod.Enabled = False
                    btn_adicionar_pagto_fornecedor.Enabled = False
                    'fran 10/02/2010 f chamado 687
                Else
                    btn_adicionar_cotacao.Enabled = True
                    btn_adicionar_desconto_prod.Enabled = True
                    btn_adicionar_pagto_fornecedor.Enabled = True

                    'fran fase 3 08/2014 i
                    If ViewState.Item("ReabrirPedido").ToString.Equals("S") Then 'se está reabrindo pedido
                        loadParcelasProdutorFornecedorPedidoReaberto()
                        lbl_nm_item.Text = ViewState.Item("lbl_detalhe_item").ToString 'Fran 25/08/2015
                        btn_atualizar_parcelamento.Enabled = True
                        If ViewState.Item("st_parcelamento").ToString.Equals("N") Then 'Se parcelamento é a vista
                            btn_adicionar_desconto_prod.Enabled = False 'Não deve informar mais parcelas se o parcelamento é a vista. Deve atualizar combo
                        Else
                            btn_adicionar_desconto_prod.Enabled = True
                        End If
                    Else
                        'Carrega parcelas se pedido nao estiver finalizado nem estiver reabrindo pedido
                        loadParcelasProdutorFornecedor() 'fran 11/2014 fase 3 melhorias i so carrega parcelas se não estiver finalizado
                    End If
                    'fran fase 3 08/2014 f

                End If
                loadGridItens()
                loadGridEntrega()
                loadGridPagtoFornecedor()
                loadGridDescontoProdutor()
                loadGridObservacao() 'fran 08/2014 i



        End Select



    End Sub
    Protected Sub gridItens_RowCreated(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewRowEventArgs) Handles gridItens.RowCreated
        If (e.Row.RowType = DataControlRowType.DataRow) Then
            Try
                Dim btn_detalhe_item As ImageButton = CType(e.Row.FindControl("btn_detalhe_item"), ImageButton)
                btn_detalhe_item.CommandArgument = e.Row.RowIndex.ToString
            Catch ex As Exception
                messageControl.Alert(ex.Message)
            End Try

        End If
        If e.Row.RowType = DataControlRowType.DataRow AndAlso (e.Row.RowState = (DataControlRowState.Alternate Or DataControlRowState.Edit) OrElse e.Row.RowState = (DataControlRowState.Normal Or DataControlRowState.Edit)) Then

            Try
                If Not (ViewState.Item("label_tipo_medida") Is Nothing) Then
                    Dim cbo_tipo_medida As DropDownList = CType(e.Row.FindControl("cbo_tipo_medida"), DropDownList)

                    If Not (ViewState.Item("label_tipo_medida").ToString.Equals(String.Empty)) Then
                        cbo_tipo_medida.SelectedValue = cbo_tipo_medida.Items.FindByText(ViewState.Item("label_tipo_medida").Trim.ToString).Value
                        ViewState.Item("label_tipo_medida") = Nothing

                    End If
                End If

            Catch ex As Exception
                messageControl.Alert(ex.Message)
            End Try

        End If

    End Sub
    Protected Sub gridItens_RowDataBound(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewRowEventArgs) Handles gridItens.RowDataBound
        Try
            If e.Row.RowType = DataControlRowType.DataRow Then

                If (e.Row.RowState = (DataControlRowState.Alternate Or DataControlRowState.Edit) OrElse e.Row.RowState = (DataControlRowState.Normal Or DataControlRowState.Edit)) Then
                    Dim txt_nr_quantidade As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(e.Row.FindControl("txt_nr_quantidade"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)

                    If CDbl(txt_nr_quantidade.Text) = 0 Then
                        txt_nr_quantidade.Text = String.Empty
                    End If

                Else
                    Dim lbl_nr_parcelas As Label = CType(e.Row.FindControl("lbl_nr_parcelas"), Label)
                    Dim lbl_ds_tipo_medida As Label = CType(e.Row.FindControl("lbl_ds_tipo_medida"), Label)
                    Dim lbl_nr_quantidade As Label = CType(e.Row.FindControl("lbl_nr_quantidade"), Label)
                    Dim lbl_id_central_pedido_item As Label = CType(e.Row.FindControl("lbl_id_central_pedido_item"), Label)
                    If lbl_ds_tipo_medida.Text = "G" Then
                        lbl_ds_tipo_medida.Text = "Granel"
                    End If
                    If lbl_ds_tipo_medida.Text = "S" Then
                        lbl_ds_tipo_medida.Text = "Sacaria"
                    End If

                    If CLng(lbl_id_central_pedido_item.Text) = CLng(ViewState.Item("id_central_pedido_item")) Then
                        e.Row.ForeColor = Drawing.Color.Red
                        'fran 8/02/2010 i
                        lbl_ds_tipo_medida.ForeColor = Drawing.Color.Red
                        lbl_nr_quantidade.ForeColor = Drawing.Color.Red
                        'fran 8/02/2010 f
                        lbl_nr_parcelas.ForeColor = Drawing.Color.Red 'fran 25/08/2015
                    Else
                        e.Row.ForeColor = System.Drawing.Color.FromName("#333333")
                        'fran 8/02/2010 i
                        lbl_ds_tipo_medida.ForeColor = System.Drawing.Color.FromName("#333333")
                        lbl_nr_quantidade.ForeColor = System.Drawing.Color.FromName("#333333")
                        'fran 8/02/2010 f
                        lbl_nr_parcelas.ForeColor = System.Drawing.Color.FromName("#333333") 'fran 25/08/2015
                    End If

                    ' Adriana 16/06/2010 - chamado 872 - i
                    If lbl_nr_parcelas.Text = "0" Then
                        lbl_nr_parcelas.Text = "À vista"
                    End If
                    ' Adriana 16/06/2010 - chamado 872 - f

                End If
            End If


        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub
    Private Sub loadGridItens()



        Dim itens As New PedidoItem
        itens.id_central_pedido = ViewState.Item("id_central_pedido").ToString
        Dim dsItens As DataSet = itens.getPedidoItensByFilters()

        If (dsItens.Tables(0).Rows.Count > 0) Then
            gridItens.Visible = True
            gridItens.DataSource = Helper.getDataView(dsItens.Tables(0), ViewState.Item("sortExpression"))
            gridItens.DataBind()
        Else
            gridItens.Visible = False
        End If

    End Sub
    Private Sub loadGridEntrega()
        Try

            If ViewState.Item("id_central_pedido_item") Is Nothing Then
                ViewState.Item("id_central_pedido_item") = 0
            End If
            'Carrega os dados do Grid
            Dim entrega As New PedidoEntrega
            If CLng(ViewState.Item("id_central_pedido_item")) > 0 Then
                entrega.id_central_pedido_item = Convert.ToInt32(ViewState.Item("id_central_pedido_item"))
                lbl_detalhe_item.Text = ViewState.Item("lbl_detalhe_item").ToString

                Dim dsCotFornecedor As DataSet = entrega.getPedidoEntregaByFilters()

                If (dsCotFornecedor.Tables(0).Rows.Count > 0) Then
                    gridEntrega.Visible = True
                    gridEntrega.DataSource = Helper.getDataView(dsCotFornecedor.Tables(0), "nr_parcela")
                    gridEntrega.DataBind()
                Else
                    Dim dr As DataRow = dsCotFornecedor.Tables(0).NewRow()
                    dsCotFornecedor.Tables(0).Rows.InsertAt(dr, 0)
                    gridEntrega.Visible = True
                    gridEntrega.DataSource = Helper.getDataView(dsCotFornecedor.Tables(0), "")
                    gridEntrega.DataBind()
                    gridEntrega.Rows(0).Cells.Clear()
                    gridEntrega.Rows(0).Cells.Add(New TableCell())
                    gridEntrega.Rows(0).Attributes.CssStyle.Add("text-align", "center")
                    gridEntrega.Rows(0).Cells(0).Text = "Não existe ainda nenhuma entrega informada para o Item selecionado!"
                    gridEntrega.Rows(0).Cells(0).ColumnSpan = 11

                End If
            Else
                entrega.id_central_pedido_item = -1
                Dim dsentrega As DataSet = entrega.getPedidoEntregaByFilters()
                Dim dr As DataRow = dsentrega.Tables(0).NewRow()
                dsentrega.Tables(0).Rows.InsertAt(dr, 0)
                gridEntrega.Visible = True
                gridEntrega.DataSource = Helper.getDataView(dsentrega.Tables(0), "")
                gridEntrega.DataBind()
                gridEntrega.Rows(0).Cells.Clear()
                gridEntrega.Rows(0).Cells.Add(New TableCell())
                gridEntrega.Rows(0).Attributes.CssStyle.Add("text-align", "center")
                gridEntrega.Rows(0).Cells(0).Text = "Selecione o detalhe do item para visualizar suas entregas."
                gridEntrega.Rows(0).Cells(0).ColumnSpan = 11
            End If


        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub
    Private Sub loadGridObservacao() 'fran 08/2014 fase 3


        Try

            If ViewState.Item("id_central_pedido") Is Nothing Then
                ViewState.Item("id_central_pedido") = 0
            End If
            'Carrega os dados do Grid
            Dim obs As New PedidoObservacao
            If CLng(ViewState.Item("id_central_pedido")) > 0 Then
                obs.id_central_pedido = Convert.ToInt32(ViewState.Item("id_central_pedido"))

                Dim dsObs As DataSet = obs.getPedidoObservacaoByFilters()

                If (dsObs.Tables(0).Rows.Count > 0) Then
                    gridObs.Visible = True
                    gridObs.DataSource = Helper.getDataView(dsObs.Tables(0), "dt_criacao")
                    gridObs.DataBind()
                Else
                    Dim dr As DataRow = dsObs.Tables(0).NewRow()
                    dsObs.Tables(0).Rows.InsertAt(dr, 0)
                    gridObs.Visible = True
                    gridObs.DataSource = Helper.getDataView(dsObs.Tables(0), "")
                    gridObs.DataBind()
                    gridObs.Rows(0).Cells.Clear()
                    gridObs.Rows(0).Cells.Add(New TableCell())
                    gridObs.Rows(0).Attributes.CssStyle.Add("text-align", "center")
                    gridObs.Rows(0).Cells(0).Text = "Não existe ainda nenhuma observação informada para o Pedido!"
                    gridObs.Rows(0).Cells(0).ColumnSpan = 4

                End If
            Else
                obs.id_central_pedido = -1
                Dim dsobs As DataSet = obs.getPedidoObservacaoByFilters()
                Dim dr As DataRow = dsobs.Tables(0).NewRow()
                dsobs.Tables(0).Rows.InsertAt(dr, 0)
                gridObs.Visible = True
                gridObs.DataSource = Helper.getDataView(dsobs.Tables(0), "")
                gridObs.DataBind()
                gridObs.Rows(0).Cells.Clear()
                gridObs.Rows(0).Cells.Add(New TableCell())
                gridObs.Rows(0).Attributes.CssStyle.Add("text-align", "center")
                gridObs.Rows(0).Cells(0).Text = "Não existe ainda nenhuma observação informada para o Pedido!"
                gridObs.Rows(0).Cells(0).ColumnSpan = 4
            End If


        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub
    Private Sub loadGridPagtoFornecedor()
        Try

            If ViewState.Item("id_central_pedido_item") Is Nothing Then
                ViewState.Item("id_central_pedido_item") = 0
            End If
            'Carrega os dados do Grid
            Dim pagto As New PedidoPagtoFornecedor
            If CLng(ViewState.Item("id_central_pedido_item")) > 0 Then
                pagto.id_central_pedido_item = Convert.ToInt32(ViewState.Item("id_central_pedido_item"))
                pagto.id_situacao = 1 'chamado 860 item 7 fran 19/10/2010
                Dim dsPagFornecedor As DataSet = pagto.getPedidoPagtoFornecedorByFilters()

                If (dsPagFornecedor.Tables(0).Rows.Count > 0) Then
                    gridPagtoForn.Visible = True
                    gridPagtoForn.DataSource = Helper.getDataView(dsPagFornecedor.Tables(0), "nr_nota_fiscal,dt_pagto,nr_parcela")
                    gridPagtoForn.DataBind()
                Else
                    Dim dr As DataRow = dsPagFornecedor.Tables(0).NewRow()
                    dsPagFornecedor.Tables(0).Rows.InsertAt(dr, 0)
                    gridPagtoForn.Visible = True
                    gridPagtoForn.DataSource = Helper.getDataView(dsPagFornecedor.Tables(0), "")
                    gridPagtoForn.DataBind()
                    gridPagtoForn.Rows(0).Cells.Clear()
                    gridPagtoForn.Rows(0).Cells.Add(New TableCell())
                    gridPagtoForn.Rows(0).Attributes.CssStyle.Add("text-align", "center")
                    gridPagtoForn.Rows(0).Cells(0).Text = "Não existe ainda nenhum pagamento ao fornecedor informado para o Item selecionado!"
                    gridPagtoForn.Rows(0).Cells(0).ColumnSpan = 12

                End If
            Else
                pagto.id_central_pedido_item = -1
                Dim dspagto As DataSet = pagto.getPedidoPagtoFornecedorByFilters()
                Dim dr As DataRow = dspagto.Tables(0).NewRow()
                dspagto.Tables(0).Rows.InsertAt(dr, 0)
                gridPagtoForn.Visible = True
                gridPagtoForn.DataSource = Helper.getDataView(dspagto.Tables(0), "")
                gridPagtoForn.DataBind()
                gridPagtoForn.Rows(0).Cells.Clear()
                gridPagtoForn.Rows(0).Cells.Add(New TableCell())
                gridPagtoForn.Rows(0).Attributes.CssStyle.Add("text-align", "center")
                gridPagtoForn.Rows(0).Cells(0).Text = "Selecione o detalhe do item para visualizar suas entregas."
                gridPagtoForn.Rows(0).Cells(0).ColumnSpan = 12
            End If


        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub
    Private Sub loadGridDescontoProdutor()


        Try
            If ViewState.Item("pedidoindireto") = "N" Then 'fran fase 3

                If ViewState.Item("id_central_pedido_item") Is Nothing Then
                    ViewState.Item("id_central_pedido_item") = 0
                End If
                'Carrega os dados do Grid
                Dim desconto As New PedidoDescontoProdutor
                If CLng(ViewState.Item("id_central_pedido_item")) > 0 Then
                    desconto.id_central_pedido_item = Convert.ToInt32(ViewState.Item("id_central_pedido_item"))

                    Dim dsDescProdutor As DataSet = desconto.getPedidoDescontoProdutorByFilters

                    If (dsDescProdutor.Tables(0).Rows.Count > 0) Then
                        grdDescProdutor.Visible = True
                        grdDescProdutor.DataSource = Helper.getDataView(dsDescProdutor.Tables(0), "nr_parcela")
                        grdDescProdutor.DataBind()
                    Else
                        Dim dr As DataRow = dsDescProdutor.Tables(0).NewRow()
                        dsDescProdutor.Tables(0).Rows.InsertAt(dr, 0)
                        grdDescProdutor.Visible = True
                        grdDescProdutor.DataSource = Helper.getDataView(dsDescProdutor.Tables(0), "")
                        grdDescProdutor.DataBind()
                        grdDescProdutor.Rows(0).Cells.Clear()
                        grdDescProdutor.Rows(0).Cells.Add(New TableCell())
                        grdDescProdutor.Rows(0).Attributes.CssStyle.Add("text-align", "center")
                        grdDescProdutor.Rows(0).Cells(0).Text = "Não existe ainda nenhum desconto ao produtor informado para o Item selecionado!"
                        grdDescProdutor.Rows(0).Cells(0).ColumnSpan = 11
                    End If
                Else
                    desconto.id_central_pedido_item = -1
                    Dim dsentrega As DataSet = desconto.getPedidoDescontoProdutorByFilters()
                    Dim dr As DataRow = dsentrega.Tables(0).NewRow()
                    dsentrega.Tables(0).Rows.InsertAt(dr, 0)
                    grdDescProdutor.Visible = True
                    grdDescProdutor.DataSource = Helper.getDataView(dsentrega.Tables(0), "")
                    grdDescProdutor.DataBind()
                    grdDescProdutor.Rows(0).Cells.Clear()
                    grdDescProdutor.Rows(0).Cells.Add(New TableCell())
                    grdDescProdutor.Rows(0).Attributes.CssStyle.Add("text-align", "center")
                    grdDescProdutor.Rows(0).Cells(0).Text = "Selecione o detalhe do item para visualizar suas entregas."
                    grdDescProdutor.Rows(0).Cells(0).ColumnSpan = 11
                End If
            End If


        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub
    Protected Sub btn_adicionar_cotacao_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btn_adicionar_cotacao.Click
        ViewState.Item("incluirlinha") = "S"
        Dim entrega As New PedidoEntrega
        entrega.id_central_pedido_item = Convert.ToInt32(ViewState.Item("id_central_pedido_item"))
        Dim dsentrega As DataSet = entrega.getPedidoEntregaByFilters()
        Dim dr As DataRow = dsentrega.Tables(0).NewRow()
        dsentrega.Tables(0).Rows.InsertAt(dr, 0)
        ViewState.Item("incluirlinhaentrega") = "S"
        gridEntrega.Visible = True
        gridEntrega.DataSource = Helper.getDataView(dsentrega.Tables(0), "nr_parcela")
        gridEntrega.EditIndex = 0
        gridEntrega.DataBind()
        ViewState.Item("incluirlinha") = Nothing

    End Sub
    Private Sub deletePedidoEntrega(ByVal id_central_pedido_entrega As Integer)
        If Page.IsValid Then


            Try
                'Deleta a cotacao fornecedor
                Dim entrega As New PedidoEntrega

                entrega.id_central_pedido_entrega = id_central_pedido_entrega
                entrega.deletePedidoEntrega()
                messageControl.Alert("Registro excluído com sucesso!")
                loadGridEntrega()


            Catch ex As Exception
                messageControl.Alert(ex.Message)
            End Try
        End If
    End Sub
    Private Sub LimparSelecaoGridItens()

        Try
            'seta zero para limpar seleção e o grid de cotações
            ViewState.Item("id_central_pedido_item") = 0
            btn_adicionar_cotacao.Enabled = False
            btn_adicionar_desconto_prod.Enabled = False
            btn_adicionar_pagto_fornecedor.Enabled = False

        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub
    Private Sub loadParcelasProdutorFornecedor()

        Try
            If ViewState.Item("id_central_pedido_item") Is Nothing Then
                ViewState.Item("id_central_pedido_item") = 0
            End If

            If CLng(ViewState.Item("id_central_pedido_item")) > 0 Then

                btn_incluir_parcelas_fornecedor.Enabled = True
                btn_incluir_parcelas_produtor.Enabled = True

                'Busca os pedidos com item selecionado
                Dim pedidoitem As New PedidoItem(Convert.ToInt32(ViewState.Item("id_central_pedido_item")))

                Dim pedidofornecedor As New PedidoPagtoFornecedor
                pedidofornecedor.id_central_pedido_item = pedidoitem.id_central_pedido_item
                Dim dspedidofornecedor As DataSet = pedidofornecedor.getPedidoPagtoFornecedorByFilters

                Dim pedidoprodutor As New PedidoDescontoProdutor
                pedidoprodutor.id_central_pedido_item = pedidoitem.id_central_pedido_item
                Dim dspedidoprodutor As DataSet = pedidoprodutor.getPedidoDescontoProdutorByFilters


                If dspedidofornecedor.Tables(0).Rows.Count = 0 Then 'se nao tem linhas informadas em pagamento fornecedor, sugere 
                    txt_valor_nota_fiscal_forn.Text = pedidoitem.nr_valor_total
                    If CInt(pedidoitem.nr_parcelas) > 1 Then 'se é Parcelado
                        txt_total_parcelas_forn.Text = pedidoitem.nr_parcelas
                    Else
                        txt_total_parcelas_forn.Text = 1
                    End If

                    If Not pedidoitem.st_parcelamento Is Nothing Then
                        If pedidoitem.st_parcelamento.Equals("D") Then 'SEfor parcelamento DANONE assume 1 parcela para fornecedor
                            txt_total_parcelas_forn.Text = 1
                        End If
                    End If
                    Select Case CInt(pedidoitem.id_central_prazo_pagto)
                        Case 0, 1 '10 dias fora mes
                            txt_dt_primeiro_pagto_forn.Text = DateAdd(DateInterval.Month, 1, Convert.ToDateTime(String.Concat("10/", Format(DateTime.Parse(Now), "MM/yyyy").ToString)))

                        Case 2 '20 dias fora me
                            txt_dt_primeiro_pagto_forn.Text = DateAdd(DateInterval.Month, 1, Convert.ToDateTime(String.Concat("20/", Format(DateTime.Parse(Now), "MM/yyyy").ToString)))

                        Case 3 '32 dias fora me
                            txt_dt_primeiro_pagto_forn.Text = DateAdd(DateInterval.Day, 32, (DateAdd(DateInterval.Month, 1, Convert.ToDateTime(String.Concat("01/", Format(DateTime.Parse(Now), "MM/yyyy").ToString)))))

                        Case 4 '63 dias fora me 
                            txt_dt_primeiro_pagto_forn.Text = DateAdd(DateInterval.Day, 63, (DateAdd(DateInterval.Month, 1, Convert.ToDateTime(String.Concat("01/", Format(DateTime.Parse(Now), "MM/yyyy").ToString)))))
                    End Select

                    txt_dt_primeiro_pagto_forn.Text = DateTime.Parse(txt_dt_primeiro_pagto_forn.Text).ToString("dd/MM/yyyy") 'Fran 05/08/2015 i 
                Else
                    txt_nota_fiscal_forn.Text = String.Empty
                    txt_serie_forn.Text = String.Empty
                    txt_dt_emissao_nota.Text = String.Empty 'fran maio/2016
                    txt_valor_nota_fiscal_forn.Text = String.Empty
                    txt_total_parcelas_forn.Text = String.Empty
                    txt_dt_primeiro_pagto_forn.Text = String.Empty

                End If

                If ViewState.Item("pedidoindireto").ToString.Equals("N") Then 'se nao é pedido indireto
                    'Se for pedido indireto não tem o grid de desconto ao produtor
                    If dspedidoprodutor.Tables(0).Rows.Count = 0 And ViewState.Item("pedidoindireto").ToString.Equals("N") Then 'se nao tem linhas informadas em desconto produtor, sugere 
                        txt_valor_nota_fiscal_prod.Text = pedidoitem.nr_valor_total
                        If CInt(pedidoitem.nr_parcelas) > 1 Then 'se é Parcelado
                            txt_total_parcelas_prod.Text = pedidoitem.nr_parcelas
                        Else
                            txt_total_parcelas_prod.Text = 1
                        End If

                        txt_dt_primeiro_pagto_prod.Text = DateAdd(DateInterval.Day, -1, (DateAdd(DateInterval.Month, 1, Convert.ToDateTime(String.Concat("01/", Format(DateTime.Parse(Now), "MM/yyyy").ToString)))))

                        txt_dt_primeiro_pagto_prod.Text = DateTime.Parse(txt_dt_primeiro_pagto_prod.Text).ToString("dd/MM/yyyy") 'Fran 05/08/2015 i 

                    Else
                        txt_nota_fiscal_prod.Text = String.Empty
                        'txt_serie_forn.Text = String.Empty
                        txt_valor_nota_fiscal_prod.Text = String.Empty
                        txt_total_parcelas_prod.Text = String.Empty
                        txt_dt_primeiro_pagto_prod.Text = String.Empty

                    End If
                End If
            Else
                txt_nota_fiscal_forn.Text = String.Empty
                txt_serie_forn.Text = String.Empty
                txt_valor_nota_fiscal_forn.Text = String.Empty
                txt_total_parcelas_forn.Text = String.Empty
                txt_dt_primeiro_pagto_forn.Text = String.Empty
                txt_nota_fiscal_prod.Text = String.Empty
                txt_serie_forn.Text = String.Empty
                txt_valor_nota_fiscal_prod.Text = String.Empty
                txt_total_parcelas_prod.Text = String.Empty
                txt_dt_primeiro_pagto_prod.Text = String.Empty
                btn_incluir_parcelas_fornecedor.Enabled = False
                btn_incluir_parcelas_produtor.Enabled = False
            End If

        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub
    Private Sub loadParcelasProdutorFornecedorPedidoReaberto()

        Try
            If ViewState.Item("id_central_pedido_item") Is Nothing Then
                ViewState.Item("id_central_pedido_item") = 0
            End If

            If CLng(ViewState.Item("id_central_pedido_item")) > 0 Then

                txt_nota_fiscal_forn.Visible = False
                rf_nr_nota_forn.Visible = False
                cbo_nota_fiscal_forn.Visible = True
                rf_cbo_nota_fiscal_forn.Visible = True
                txt_serie_forn.Enabled = False
                txt_dt_emissao_nota.Enabled = False 'fran 05/2016
                txt_valor_nota_fiscal_forn.Enabled = False

                Dim nrnotaforn As New PedidoPagtoFornecedor
                nrnotaforn.id_central_pedido_item = Convert.ToInt32(ViewState.Item("id_central_pedido_item").ToString)
                cbo_nota_fiscal_forn.DataSource = nrnotaforn.getCentralPedidoPagtoFornecedorNotas()
                cbo_nota_fiscal_forn.DataTextField = "nr_nota_fiscal"
                cbo_nota_fiscal_forn.DataValueField = "ds_serie_valor"
                cbo_nota_fiscal_forn.DataBind()
                cbo_nota_fiscal_forn.Items.Insert(0, New ListItem("[Selecione]", String.Empty))

                If ViewState.Item("pedidoindireto").ToString.Equals("N") Then 'se nao é pedido indireto

                    Dim nrnotaprod As New PedidoDescontoProdutor
                    nrnotaprod.id_central_pedido_item = Convert.ToInt32(ViewState.Item("id_central_pedido_item").ToString)
                    cbo_nota_fiscal_prod.DataSource = nrnotaprod.getCentralPedidoDescontoProdutorNotas()
                    cbo_nota_fiscal_prod.DataTextField = "nr_nota_fiscal"
                    'cbo_nota_fiscal_prod.DataValueField = "nr_valor_nota_fiscal"
                    cbo_nota_fiscal_prod.DataValueField = "ds_nr_nota_valor"
                    cbo_nota_fiscal_prod.DataBind()
                    cbo_nota_fiscal_prod.Items.Insert(0, New ListItem("[Selecione]", String.Empty))

                    cbo_nota_fiscal_prod.Enabled = True
                    btn_incluir_parcelas_produtor.Enabled = True
                    txt_nota_fiscal_prod.Visible = False
                    rf_nr_nota_prod.Visible = False
                    cbo_nota_fiscal_prod.Visible = True
                    rf_cbo_nota_fiscal_prod.Visible = True
                    txt_valor_nota_fiscal_prod.Enabled = False
                End If
                btn_incluir_parcelas_fornecedor.Enabled = True
                cbo_nota_fiscal_forn.Enabled = True
                txt_nota_fiscal_forn.Text = String.Empty
                txt_serie_forn.Text = String.Empty
                txt_dt_emissao_nota.Text = String.Empty 'fran 05/2016
                txt_valor_nota_fiscal_forn.Text = String.Empty
                txt_total_parcelas_forn.Text = String.Empty
                txt_dt_primeiro_pagto_forn.Text = String.Empty

            Else
                txt_nota_fiscal_forn.Visible = False
                rf_nr_nota_forn.Visible = False
                cbo_nota_fiscal_forn.Visible = True
                rf_cbo_nota_fiscal_forn.Visible = True
                txt_serie_forn.Enabled = False
                txt_dt_emissao_nota.Enabled = False 'fran 05/2016
                rf_dtemissao.Visible = False 'fran 05/2016
                txt_valor_nota_fiscal_forn.Enabled = False
                txt_nota_fiscal_prod.Visible = False
                rf_nr_nota_prod.Visible = False
                cbo_nota_fiscal_prod.Visible = True
                rf_cbo_nota_fiscal_prod.Visible = True
                txt_valor_nota_fiscal_prod.Enabled = False

                txt_nota_fiscal_forn.Text = String.Empty
                txt_serie_forn.Text = String.Empty
                txt_valor_nota_fiscal_forn.Text = String.Empty
                txt_dt_emissao_nota.Text = String.Empty 'fran 05/2016
                txt_total_parcelas_forn.Text = String.Empty
                txt_dt_primeiro_pagto_forn.Text = String.Empty
                cbo_nota_fiscal_forn.Enabled = False
                cbo_nota_fiscal_prod.Enabled = False
                btn_incluir_parcelas_fornecedor.Enabled = False
                btn_incluir_parcelas_produtor.Enabled = False

            End If
        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub
    Private Sub EnviarEmailTecnicoAprovacao()
        Try
            If Page.IsValid = True Then
                Try

                    Dim notificacao As New Notificacao
                    'Dim lAssunto As String = String.Concat("Aprovação de Cotações Central de Compras para Propriedade ", , " - ", lbl_nm_propriedade.Text.Trim & ".")
                    Dim lCorpo As String

                    lCorpo = "Existem cotações realizadas pela Central de Compras do Produtor "
                    lCorpo = lCorpo & "'" & lbl_nm_produtor.Text.Trim & "' para a Propriedade "
                    'lCorpo = lCorpo & "'" & String.Concat(txt_id_propriedade.Text.Trim, " - ", lbl_nm_propriedade.Text.Trim) & "', "
                    lCorpo = lCorpo & " pendentes para serem aprovadas por você, técnico responsável."

                    ' Parametro 7 - Central Cotacao 1.o Nível Gestor (enviar aos Tecnicos) 
                    'If notificacao.enviaMensagemEmail(7, lAssunto, lCorpo, MailPriority.High) = True Then

                    'messageControl.Alert("A mensagem de solicitação de aprovação para o Técnico Responsável pela propriedade foi enviada aos destinatários com sucesso!")
                    'Else

                    'messageControl.Alert("A mensagem de solicitação de aprovação para o Técnico Responsável pela propriedade não pode ser enviada. Verifique se há destinatários cadastrados para este tipo de notificação.")
                    'img_notificacao.Visible = True
                    'lk_email_produtor.Visible = True

                    'End If


                Catch ex As Exception
                    messageControl.Alert(ex.Message)
                End Try


            End If

        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub

    Private Function VerificarCotacao() As Boolean

        Try

            Dim cotacaoitem As New CotacaoItem()
            Dim cotacaofornc As New CotacaoFornecedor()
            Dim dscotitem As DataSet = cotacaoitem.getCotacaoItensByFilters
            Dim dscotforn As DataSet
            Dim row As DataRow
            Dim rowfornec As DataRow
            Dim lmsg As String
            Dim isvalid As Boolean = True

            For Each row In dscotitem.Tables(0).Rows
                If row.Item("st_ver_mercado") = "N" Then
                    If CDbl(row.Item("nr_quantidade")) = 0 Then
                        isvalid = False
                        lmsg = "Há itens da cotação cujo cadastro está incompleto!"
                        Exit For
                    End If
                    cotacaofornc.id_central_cotacao_item = Convert.ToInt32(row.Item("id_central_cotacao_item"))
                    dscotforn = cotacaofornc.getCotacaoFornecedorByFilters()
                    For Each rowfornec In dscotforn.Tables(0).Rows
                        If Not CDbl(rowfornec.Item("nr_valor_unitario")) > 0 Then
                            isvalid = False
                            lmsg = "Há cotações para o item " + row.Item("nm_item").ToString + " cujo cadastro está incompleto!"
                            Exit For
                        End If
                    Next
                    If isvalid = False Then
                        Exit For
                    End If

                    cotacaofornc.st_selecionado = "S"
                    cotacaofornc.st_ver_mercado = "N"
                    If cotacaofornc.getCotacaoFornecedorByFilters.Tables(0).Rows.Count = 0 Then
                        isvalid = False
                        lmsg = "Não há cotação selecionada para o item " + row.Item("nm_item").ToString + "."
                        Exit For
                    End If
                End If
            Next

            If isvalid = False Then
                VerificarCotacao = False
                messageControl.Alert(lmsg)
            Else
                VerificarCotacao = True
            End If


        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try


    End Function



    Protected Sub lk_notificar_aprovadores_Click(ByVal sender As Object, ByVal e As System.EventArgs)
        Try
            EnviarEmailTecnicoAprovacao()
        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try
    End Sub
    Protected Sub lk_gerar_pedido_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles lk_gerar_pedido.Click
        If Page.IsValid Then
            Try
                Dim pedido As New Pedido
                pedido.id_central_pedido = (Convert.ToInt32(ViewState.Item("id_central_pedido")))
                pedido.id_modificador = Session("id_login")

                'FRAN 08/12/2020 i incluir log 
                Dim usuariolog As New UsuarioLog
                usuariolog.id_usuario = Session("id_login")
                usuariolog.ds_id_session = Session.SessionID.ToString()
                usuariolog.id_tipo_log = 6 'processo
                usuariolog.id_menu_item = 97
                usuariolog.id_nr_processo = pedido.id_central_pedido
                usuariolog.nm_nr_processo = pedido.id_central_pedido

                usuariolog.insertUsuarioLog()
                'FRAN 08/12/2020  incluir log 

                If pedido.finalizarPedido() = True Then
                    messageControl.Alert("Pedido finalizado com sucesso!")
                Else
                    messageControl.Alert("Ocorreram problemas na finalização do Pedido. Contate o administrador do sistema.")
                End If
                loadData()
            Catch ex As Exception
                messageControl.Alert(ex.Message)
            End Try
        End If
    End Sub
    Protected Sub btn_adicionar_pagto_fornecedor_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btn_adicionar_pagto_fornecedor.Click
        ViewState.Item("incluirlinha") = "S"
        Dim pagto As New PedidoPagtoFornecedor
        pagto.id_central_pedido_item = Convert.ToInt32(ViewState.Item("id_central_pedido_item"))
        pagto.id_situacao = 1 'chamado 860 item 7 fran 19/10/2010
        Dim dspagto As DataSet = pagto.getPedidoPagtoFornecedorByFilters()
        Dim dr As DataRow = dspagto.Tables(0).NewRow()
        dspagto.Tables(0).Rows.InsertAt(dr, 0)
        ViewState.Item("incluirlinhapagto") = "S"
        gridPagtoForn.Visible = True
        gridPagtoForn.DataSource = Helper.getDataView(dspagto.Tables(0), "nr_parcela")
        gridPagtoForn.EditIndex = 0
        gridPagtoForn.DataBind()
        ViewState.Item("incluirlinha") = Nothing
        ViewState.Item("label_nr_nota_forn") = Nothing 'fase 3 fran dez/2014

    End Sub
    Protected Sub gridPagtoForn_PageIndexChanging(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewPageEventArgs) Handles gridPagtoForn.PageIndexChanging
        gridPagtoForn.PageIndex = e.NewPageIndex
        loadData()

    End Sub
    Protected Sub gridPagtoForn_RowCancelingEdit(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewCancelEditEventArgs) Handles gridPagtoForn.RowCancelingEdit
        Try

            gridPagtoForn.EditIndex = -1
            ViewState.Item("incluirlinhapagto") = "N"
            ViewState.Item("incluirlinhapagto") = Nothing
            loadGridPagtoFornecedor()

        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub
    Protected Sub gridPagtoForn_RowCommand(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewCommandEventArgs) Handles gridPagtoForn.RowCommand
        Select Case e.CommandName.Trim.ToString
            Case "delete"
                deletePedidoPagtoFornecedor(Convert.ToInt32(e.CommandArgument.ToString()))

        End Select

    End Sub
    Protected Sub gridPagtoForn_RowCreated(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewRowEventArgs) Handles gridPagtoForn.RowCreated
        If e.Row.RowType = DataControlRowType.DataRow AndAlso (e.Row.RowState = (DataControlRowState.Alternate Or DataControlRowState.Edit) OrElse e.Row.RowState = (DataControlRowState.Normal Or DataControlRowState.Edit)) Then
            Try
                'se esta reabrindo pedido e incluindo nova linha de desconto ao produtor
                'fran fase 3 dez/2014 i
                If ViewState.Item("ReabrirPedido") = "S" Then
                    Dim cbo_nr_nota As DropDownList = CType(e.Row.FindControl("cbo_nr_nota"), DropDownList)
                    Dim txt_nr_nota_fiscal As RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox = CType(e.Row.FindControl("txt_nr_nota_fiscal"), RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox)
                    Dim txt_nr_serie As TextBox = CType(e.Row.FindControl("txt_nr_serie"), TextBox)
                    Dim rf_cbo_nota_fiscal As RequiredFieldValidator = CType(e.Row.FindControl("rf_cbo_nota_fiscal"), RequiredFieldValidator)
                    Dim rqf_nr_nota As RequiredFieldValidator = CType(e.Row.FindControl("rqf_nr_nota"), RequiredFieldValidator)

                    rf_cbo_nota_fiscal.Visible = True
                    rqf_nr_nota.Visible = False
                    txt_nr_nota_fiscal.Visible = False
                    cbo_nr_nota.Visible = True

                    If ViewState.Item("incluirlinhapagto") = "S" Then
                        ViewState.Item("label_nr_nota_forn") = ""
                    End If

                    If Not (ViewState.Item("label_nr_nota_forn") Is Nothing) Then
                        Dim nrnotapedido As New PedidoPagtoFornecedor
                        nrnotapedido.id_central_pedido_item = Convert.ToInt32(ViewState.Item("id_central_pedido_item").ToString)
                        cbo_nr_nota.DataSource = nrnotapedido.getCentralPedidoPagtoFornecedorNotas()
                        cbo_nr_nota.DataTextField = "nr_nota_fiscal"
                        cbo_nr_nota.DataValueField = "ds_serie_valor"
                        cbo_nr_nota.DataBind()

                        If (ViewState.Item("label_nr_nota_forn").ToString.Equals(String.Empty)) Then
                            cbo_nr_nota.Items.Insert(0, New ListItem("[Selecione]", String.Empty))
                            ViewState.Item("label_nr_nota_forn") = "SEM_VALOR"
                        Else
                            cbo_nr_nota.SelectedValue = cbo_nr_nota.Items.FindByText(ViewState.Item("label_nr_nota_forn").Trim.ToString).Value
                            ViewState.Item("label_nr_nota_forn") = Nothing
                        End If

                    End If

                End If
                'fran fase 3 dez/2014 f

            Catch ex As Exception
                messageControl.Alert(ex.Message)
            End Try

        End If


    End Sub

    Protected Sub gridPagtoForn_RowDataBound(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewRowEventArgs) Handles gridPagtoForn.RowDataBound
        If e.Row.RowType = DataControlRowType.DataRow AndAlso (e.Row.RowState = (DataControlRowState.Alternate Or DataControlRowState.Edit) OrElse e.Row.RowState = (DataControlRowState.Normal Or DataControlRowState.Edit)) Then

            Dim txt_dt_emissao As TextBox = CType(e.Row.FindControl("txt_dt_emissao"), TextBox)

            'fran fase 3 set/2014 i 
            If ViewState.Item("ReabrirPedido") = "S" Then

                Dim cbo_nr_nota As DropDownList = CType(e.Row.FindControl("cbo_nr_nota"), DropDownList)
                Dim txt_nr_nota_fiscal As RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox = CType(e.Row.FindControl("txt_nr_nota_fiscal"), RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox)
                Dim txt_nr_valor_nota_fiscal As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(e.Row.FindControl("txt_nr_valor_nota_fiscal"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
                Dim rf_cbo_nota_fiscal As RequiredFieldValidator = CType(e.Row.FindControl("rf_cbo_nota_fiscal"), RequiredFieldValidator)
                Dim rqf_nr_nota As RequiredFieldValidator = CType(e.Row.FindControl("rqf_nr_nota"), RequiredFieldValidator)
                Dim txt_nr_serie As TextBox = CType(e.Row.FindControl("txt_nr_serie"), TextBox)

                rf_cbo_nota_fiscal.Visible = True
                rqf_nr_nota.Visible = False

                cbo_nr_nota.Visible = True
                txt_nr_nota_fiscal.Visible = False
                txt_nr_valor_nota_fiscal.Enabled = False
                txt_nr_serie.Enabled = False
                txt_dt_emissao.Enabled = False 'fran 05/2016


                If ViewState.Item("label_nr_nota_forn") = "SEM_VALOR" Then
                    'Se já fez a criação  da linha e esta sem valor no combo , força o 'Selecione'
                    If Not (cbo_nr_nota Is Nothing) Then
                        cbo_nr_nota.Items.Insert(0, New ListItem("[Selecione]", String.Empty))
                    End If
                    ViewState.Item("label_nr_nota_forn") = Nothing
                End If
            End If
            'fran fase 3 set/2014 f 

            Dim dt_pagto As RK.TextBox.AjaxOnlyDate.OnlyDateTextBox = CType(e.Row.FindControl("txt_dt_pagto"), RK.TextBox.AjaxOnlyDate.OnlyDateTextBox)

            If Not dt_pagto.Text.Equals(String.Empty) Then
                'fran 16/03/2010 i
                'dt_pagto.Text = Left(dt_pagto.Text.Trim, 10)
                dt_pagto.Text = DateTime.Parse(dt_pagto.Text.Trim).ToString("dd/MM/yyyy")
                'fran 16/03/2010 f
            End If
            If Not txt_dt_emissao.Text.Equals(String.Empty) Then
                txt_dt_emissao.Text = DateTime.Parse(txt_dt_emissao.Text.Trim).ToString("dd/MM/yyyy")
            End If

        Else
            If e.Row.RowType = DataControlRowType.DataRow Then

                'fran set/2014 fase 3 i
                'se nao tem nr nota veio de cotacao e acessa pedido pela primeira vez
                Dim lbl_nr_nota_fiscal As Label = CType(e.Row.FindControl("lbl_nr_nota_fiscal"), Label)
                If lbl_nr_nota_fiscal.Text.Equals(String.Empty) Then
                    ViewState.Item("PagtoForn1avez") = "S"
                Else
                    ViewState.Item("PagtoForn1avez") = "N"
                End If
                'fran set/2014 fase 3 f

                Dim dt_pagto As Label = CType(e.Row.FindControl("lbl_dt_pagto"), Label)
                If Not dt_pagto.Text.Equals(String.Empty) Then
                    'fran 16/03/2010 i
                    'dt_pagto.Text = Left(dt_pagto.Text.Trim, 10)
                    dt_pagto.Text = DateTime.Parse(dt_pagto.Text.Trim).ToString("dd/MM/yyyy")
                    'fran 16/03/2010 f
                End If
                Dim lbl_dt_emissao As Label = CType(e.Row.FindControl("lbl_dt_emissao"), Label)
                If Not lbl_dt_emissao.Text.Equals(String.Empty) Then
                    lbl_dt_emissao.Text = DateTime.Parse(lbl_dt_emissao.Text.Trim).ToString("dd/MM/yyyy")
                End If

                'fran 26/03/2012 i 
                Dim lbl_st_transf As Label = CType(e.Row.FindControl("lbl_st_transf"), Label)
                Dim lbl_pedidoorigem As Label = CType(e.Row.FindControl("lbl_pedido_origem"), Label)
                Dim lbl_proporigem As Label = CType(e.Row.FindControl("lbl_prop_origem"), Label)
                'fran 31/12/2014 fase 3 i
                Dim btn_editar As Anthem.ImageButton = CType(e.Row.FindControl("btn_editar"), Anthem.ImageButton)
                Dim btn_delete As Anthem.ImageButton = CType(e.Row.FindControl("btn_delete"), Anthem.ImageButton)
                Dim bexportado As Boolean = False
                'fran 31/12/2014 fase 3 f

                If lbl_st_transf.Text = "S" Then 'se veio calculado de pedido anterior (transf volume)
                    Dim img_st_calculado As Anthem.Image = CType(e.Row.FindControl("img_st_exportado"), Anthem.Image)
                    img_st_calculado.ImageUrl = "~/img/ico_chk_true.gif"
                    img_st_calculado.ToolTip = "Exportação realizada no Pedido Origem, antes da transferência de volume."
                    'pedido
                    lbl_pedidoorigem.Text = lbl_pedido_origem.Text
                    'propriedade origem
                    lbl_proporigem.Text = lbl_propriedadeup_origem.Text
                    bexportado = True 'fran 12/2014 fase 3

                Else
                    'fran 15/05/2012 themis i
                    'fran 01/06/2012 chamado 1560 i
                    'Dim lbl_st_exportacao As Label = CType(e.Row.FindControl("st_exportacao"), Label)
                    Dim lbl_st_exportacao As Label = CType(e.Row.FindControl("lbl_st_exportacao"), Label)
                    'fran 01/06/2012 chamado 1560 f
                    Dim img_st_calculado As Anthem.Image = CType(e.Row.FindControl("img_st_exportado"), Anthem.Image)

                    If lbl_st_exportacao.Text.Trim.Equals("S") Then
                        img_st_calculado.ImageUrl = "~/img/ico_chk_true.gif"
                        img_st_calculado.ToolTip = "Exportação já realizada."
                        bexportado = True 'fran 12/2014 fase 3

                    End If
                    'fran 15/05/2012 themis f


                End If
                'fran 26/03/2012 f 
                'fran fase 3 12/2014 i
                'se ja tem exportacao nao pode alterar 
                If ViewState.Item("ReabrirPedido") = "S" Then

                    If bexportado = True Then
                        btn_editar.Enabled = False
                        btn_delete.Enabled = False
                        btn_editar.ImageUrl = "~/img/icone_editar_grid_desabilitado.gif"
                        btn_delete.ImageUrl = "~/img/icone_excluir_desabilitado.gif"
                    End If
                End If
                'fran fase 3 8/2014 f

            End If
        End If

    End Sub

    Protected Sub gridPagtoForn_RowDeleting(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewDeleteEventArgs) Handles gridPagtoForn.RowDeleting
        e.Cancel = True

    End Sub


    Protected Sub gridPagtoForn_RowEditing(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewEditEventArgs) Handles gridPagtoForn.RowEditing
        Try
            If ViewState.Item("incluirlinha") = "S" And e.NewEditIndex = 0 Then
                ViewState.Item("incluirlinha") = "S"
                loadGridPagtoFornecedor()
            Else
                Dim lbl_nr_nota_fiscal As Label = CType(gridPagtoForn.Rows(e.NewEditIndex).FindControl("lbl_nr_nota_fiscal"), Label)
                ViewState.Item("label_nr_nota_forn") = Trim(lbl_nr_nota_fiscal.Text) 'fase 3 fran dez/2014

                gridPagtoForn.EditIndex = e.NewEditIndex
                loadGridPagtoFornecedor()
            End If
        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub


    Protected Sub gridPagtoForn_RowUpdating(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewUpdateEventArgs) Handles gridPagtoForn.RowUpdating
        Dim row As GridViewRow = gridPagtoForn.Rows(e.RowIndex)
        Try
            If Page.IsValid Then


                If (Not (row) Is Nothing) Then

                    Dim pagto As New PedidoPagtoFornecedor

                    Dim lbl_id_central_pedido_item As Label = CType(row.FindControl("lbl_id_central_pedido_item"), Label)
                    Dim lbl_id_central_pedido_pagto_fornecedor As Label = CType(row.FindControl("lbl_id_central_pedido_pagto_fornecedor"), Label)

                    Dim nr_parcela As RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox = CType(row.FindControl("txt_nr_parcela"), RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox)
                    Dim nr_valor_nota_fiscal As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_valor_nota_fiscal"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
                    Dim nr_nota_fiscal As RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox = CType(row.FindControl("txt_nr_nota_fiscal"), RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox)
                    Dim nr_serie As Anthem.TextBox = CType(row.FindControl("txt_nr_serie"), Anthem.TextBox)
                    Dim nr_valor_parcela As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_valor_parcela"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
                    Dim dt_pagto As RK.TextBox.AjaxOnlyDate.OnlyDateTextBox = CType(row.FindControl("txt_dt_pagto"), RK.TextBox.AjaxOnlyDate.OnlyDateTextBox)
                    Dim dt_emissao As RK.TextBox.AjaxOnlyDate.OnlyDateTextBox = CType(row.FindControl("txt_dt_emissao"), RK.TextBox.AjaxOnlyDate.OnlyDateTextBox)

                    pagto.nr_serie_nota_fiscal = nr_serie.Text
                    pagto.dt_emissao_nota_fiscal = dt_emissao.Text 'fran 05/2016

                    If ViewState.Item("ReabrirPedido") = "S" Then
                        Dim cbo_nr_nota As DropDownList = CType(row.FindControl("cbo_nr_nota"), DropDownList)
                        pagto.nr_nota_fiscal = cbo_nr_nota.SelectedItem.Text
                    Else
                        pagto.nr_nota_fiscal = nr_nota_fiscal.Text

                    End If

                    If Not nr_valor_nota_fiscal.Text.ToString.Equals(String.Empty) Then
                        pagto.nr_valor_nota_fiscal = Convert.ToDecimal(nr_valor_nota_fiscal.Text)
                    End If

                    pagto.nr_parcela = nr_parcela.Text
                    pagto.dt_pagto = dt_pagto.Text
                    If Not nr_valor_parcela.Text.ToString.Equals(String.Empty) Then
                        pagto.nr_valor_parcela = Convert.ToDecimal(nr_valor_parcela.Text)
                    End If

                    pagto.id_modificador = Session("id_login")
                    pagto.id_central_pedido_item = Convert.ToInt32(ViewState.Item("id_central_pedido_item"))
                    'fran 14/02/2011 chamado 1170 i só deixa atualizar ou inserir se algum campo for diferente do banco
                    If pagto.getPedidoPagtoFornecedorByFilters.Tables(0).Rows.Count = 0 Then
                        'fran 14/02/2011 chamado 1170 f
                        'Se é um novo item
                        If Not ViewState.Item("incluirlinhapagto") Is Nothing Then
                            If ViewState.Item("incluirlinhapagto") = "S" Then
                                pagto.insertPedidoCentralPagtoFornecedor()
                                ViewState.Item("incluirlinhapagto") = Nothing
                            Else
                                pagto.id_central_pedido_pagto_fornecedor = Convert.ToInt32(lbl_id_central_pedido_pagto_fornecedor.Text)
                                pagto.updatePedidoPagtoFornecedor()
                            End If
                        Else
                            pagto.id_central_pedido_pagto_fornecedor = Convert.ToInt32(lbl_id_central_pedido_pagto_fornecedor.Text)
                            pagto.updatePedidoPagtoFornecedor()
                        End If
                        'fran 14/02/2011 chamado 1170 i
                    Else
                        If Not ViewState.Item("incluirlinhapagto") Is Nothing Then
                            If ViewState.Item("incluirlinhapagto") = "S" Then
                                ViewState.Item("incluirlinhapagto") = Nothing
                            End If
                        End If
                    End If
                    'fran 14/02/2011 chamado 1170 f

                    gridPagtoForn.EditIndex = -1

                    loadGridPagtoFornecedor()

                End If
            End If
        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub

    Private Sub deletePedidoPagtoFornecedor(ByVal id_central_pedido_pagto_fornecedor As Integer)
        If Page.IsValid Then


            Try
                'Deleta a cotacao fornecedor
                Dim pagto As New PedidoPagtoFornecedor

                pagto.id_central_pedido_pagto_fornecedor = id_central_pedido_pagto_fornecedor
                pagto.deletePedidoPagtoFornecedor()
                messageControl.Alert("Registro excluído com sucesso!")
                loadGridPagtoFornecedor()


            Catch ex As Exception
                messageControl.Alert(ex.Message)
            End Try
        End If
    End Sub
    Private Sub deletePedidoObservacao(ByVal id_central_pedido_observacao As Integer)
        If Page.IsValid Then


            Try
                'Deleta a cotacao fornecedor
                Dim observacao As New PedidoObservacao

                observacao.id_central_pedido_observacao = id_central_pedido_observacao
                observacao.deletePedidoObservacao()
                messageControl.Alert("Registro excluído com sucesso!")
                loadGridObservacao()


            Catch ex As Exception
                messageControl.Alert(ex.Message)
            End Try
        End If
    End Sub
    Private Sub deletePedidoDescontoProd(ByVal id_central_pedido_desconto_produtor As Integer)
        If Page.IsValid Then


            Try
                'Deleta a cotacao fornecedor
                Dim desconto As New PedidoDescontoProdutor(id_central_pedido_desconto_produtor)
                Dim maissolidos As New Poupanca
                Dim lnrmssaldodisponivel As Decimal

                If ViewState.Item("pedidoindireto").ToString.Equals("N") Then
                    If ViewState.Item("maissolidospremiado") = True Then
                        'se o desconto ao produtor deletado tem mais solidos
                        If desconto.st_mais_solidos = "S" Then
                            If CInt(ViewState.Item("id_propriedade_titular")) > 0 Then
                                maissolidos.id_propriedade_titular = ViewState.Item("id_propriedade_titular")
                                maissolidos.id_pessoa = 0
                            Else
                                maissolidos.id_pessoa = Convert.ToInt32(ViewState.Item("id_produtor"))
                                maissolidos.id_propriedade_titular = 0
                            End If
                            maissolidos.id_poupanca_parametro = ViewState.Item("id_poupanca_parametro")
                            maissolidos.dt_referencia = String.Concat("01", Right(DateTime.Parse(desconto.dt_pagto).ToString("dd/MM/yyyy"), 8))
                            maissolidos.nr_valor_central = -desconto.nr_mais_solidos_valor_utilizado
                            maissolidos.id_modificador = Session("id_login")

                            maissolidos.updateMaisSolidosPremio()
                            'atualiza saldo disponivel
                            lnrmssaldodisponivel = maissolidos.getMaisSolidosProdutorSaldoDisponivel
                            lbl_ms_valor_disponivel.Text = FormatCurrency(lnrmssaldodisponivel, 2)
                            ViewState.Item("maissolidossaldodisponivel") = lnrmssaldodisponivel


                        End If
                    End If

                End If

                desconto.id_central_pedido_desconto_produtor = id_central_pedido_desconto_produtor
                desconto.deletePedidoDescontoProdutor()
                messageControl.Alert("Registro excluído com sucesso!")
                loadGridDescontoProdutor()


            Catch ex As Exception
                messageControl.Alert(ex.Message)
            End Try
        End If
    End Sub
    'fran chamado 816 - 14/05/2010
    'Protected Sub lk_email_parceiro_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles lk_email_parceiro.Click
    '    Dim lassunto As String
    '    Dim lcorpo As String
    '    Dim arqTemp As StreamReader
    '    Dim lcaminhoservidor As String = System.Configuration.ConfigurationManager.AppSettings("PathReports").ToString()
    '    Dim propriedade As New Propriedade(Convert.ToInt32(ViewState.Item("id_propriedade").ToString))
    '    Dim produtor As New Pessoa(Convert.ToInt32(ViewState.Item("id_produtor").ToString))
    '    Dim fornecedor As New Pessoa(Convert.ToInt32(ViewState.Item("id_fornecedor").ToString))
    '    Dim lemail_parceiro As String

    '    lemail_parceiro = fornecedor.ds_email
    '    If lemail_parceiro.Equals(String.Empty) Then
    '        If Not fornecedor.ds_email2 Is Nothing Then
    '            lemail_parceiro = fornecedor.ds_email2
    '        Else
    '            lemail_parceiro = String.Empty

    '        End If
    '        'lemail_parceiro = "franoliveira@hotmail.com"
    '    End If
    '    If Not lemail_parceiro.Equals(String.Empty) Then
    '        lassunto = String.Concat("DANONE - Pedido de Compra ", "Nr ", lbl_id_central_pedido.Text)
    '        arqTemp = New StreamReader(lcaminhoservidor & "\email_fornecedor.HTML", Encoding.UTF7)
    '        lcorpo = ""
    '        Do While Not arqTemp.EndOfStream
    '            lcorpo = lcorpo & arqTemp.ReadLine
    '        Loop

    '        lcorpo = Replace(lcorpo, "$dt_pedido", DateTime.Parse(lbl_dt_pedido.Text.ToString).ToString("dd/MM/yyyy"))
    '        lcorpo = Replace(lcorpo, "$id_pedido", ViewState.Item("id_central_pedido").ToString)
    '        lcorpo = Replace(lcorpo, "$nr_contrato", fornecedor.nr_contrato.ToString)
    '        If fornecedor.nm_abreviado.Equals(String.Empty) Then
    '            lcorpo = Replace(lcorpo, "$ds_fornecedor", String.Concat(fornecedor.cd_pessoa.ToString, " - ", fornecedor.nm_pessoa))
    '        Else
    '            lcorpo = Replace(lcorpo, "$ds_fornecedor", String.Concat(fornecedor.cd_pessoa.ToString, " - ", fornecedor.nm_abreviado))
    '        End If
    '        lcorpo = Replace(lcorpo, "$end_fornecedor", String.Concat(fornecedor.ds_endereco, " ", fornecedor.nr_endereco))
    '        lcorpo = Replace(lcorpo, "$bairro_fornecedor", fornecedor.ds_bairro)
    '        lcorpo = Replace(lcorpo, "$cidade_fornecedor", fornecedor.nm_cidade)
    '        lcorpo = Replace(lcorpo, "$uf_fornecedor", fornecedor.cd_uf)
    '        lcorpo = Replace(lcorpo, "$cepfornecedor", fornecedor.cd_cep)
    '        If fornecedor.st_categoria = "F" Then
    '            lcorpo = Replace(lcorpo, "$cnpjfornecedor", fornecedor.cd_cpf)
    '        Else
    '            lcorpo = Replace(lcorpo, "$cnpjfornecedor", fornecedor.cd_cnpj)
    '        End If
    '        lcorpo = Replace(lcorpo, "$inscrestadualfornecedor", fornecedor.cd_inscricao_estadual)
    '        lcorpo = Replace(lcorpo, "$ds_contato", fornecedor.ds_contato)
    '        lcorpo = Replace(lcorpo, "$email", fornecedor.ds_email)
    '        lcorpo = Replace(lcorpo, "$fone1", fornecedor.ds_telefone_1)
    '        lcorpo = Replace(lcorpo, "$fone2", fornecedor.ds_telefone_2)

    '        lcorpo = Replace(lcorpo, "$ds_produtor", String.Concat(produtor.nm_pessoa.ToString + " - ", produtor.cd_pessoa + " - ", propriedade.id_propriedade.ToString + "-", lbl_up.Text.ToString))
    '        lcorpo = Replace(lcorpo, "$end_produtor", String.Concat(produtor.ds_endereco, " ", produtor.nr_endereco))
    '        lcorpo = Replace(lcorpo, "$bairro_produtor", produtor.ds_bairro)
    '        lcorpo = Replace(lcorpo, "$cidade_produtor", produtor.nm_cidade)
    '        lcorpo = Replace(lcorpo, "$uf_produtor", produtor.cd_uf)
    '        lcorpo = Replace(lcorpo, "$cepprodutor", produtor.cd_cep)
    '        If fornecedor.st_categoria = "F" Then
    '            lcorpo = Replace(lcorpo, "$cnpjprodutor", produtor.cd_cpf)
    '        Else
    '            lcorpo = Replace(lcorpo, "$cnpjprodutor", produtor.cd_cnpj)
    '        End If
    '        lcorpo = Replace(lcorpo, "$inscrestadualprodutor", produtor.cd_inscricao_estadual)
    '        lcorpo = Replace(lcorpo, "$ds_contato", produtor.ds_contato)
    '        lcorpo = Replace(lcorpo, "$email", produtor.ds_email)
    '        lcorpo = Replace(lcorpo, "$fone1", produtor.ds_telefone_1)
    '        lcorpo = Replace(lcorpo, "$fone2", produtor.ds_telefone_2)


    '        lcorpo = Replace(lcorpo, "$nm_produtor", produtor.nm_pessoa)
    '        lcorpo = Replace(lcorpo, "$end_propriedade", String.Concat(propriedade.ds_endereco, " ", propriedade.nr_endereco))
    '        lcorpo = Replace(lcorpo, "$bairro_propriedade", propriedade.ds_bairro)
    '        lcorpo = Replace(lcorpo, "$cidade_propriedade", propriedade.nm_cidade)
    '        lcorpo = Replace(lcorpo, "$uf_propriedade", propriedade.cd_uf)
    '        lcorpo = Replace(lcorpo, "$ceppropriedade", propriedade.cd_cep)
    '        If fornecedor.st_categoria = "F" Then
    '            lcorpo = Replace(lcorpo, "$cnpjprodutor", produtor.cd_cpf)
    '        Else
    '            lcorpo = Replace(lcorpo, "$cnpjprodutor", produtor.cd_cnpj)
    '        End If
    '        lcorpo = Replace(lcorpo, "$increstadualprodutor", produtor.cd_inscricao_estadual)
    '        lcorpo = Replace(lcorpo, "$nr_total_pedido", lbl_total_pedido.Text)

    '        Dim pedido As New Pedido
    '        pedido.id_central_pedido = Convert.ToInt32(ViewState.Item("id_central_pedido"))
    '        Dim dsgrid As DataSet = pedido.getCentralPedidoEmailParceiro()
    '        Dim row As DataRow
    '        Dim ltable As String = String.Empty
    '        For Each row In dsgrid.Tables(0).Rows
    '            ltable = "<tr><td style=' border-left: gray 1px solid;'>"
    '            ltable = ltable & row.Item("cd_item").ToString & "</td>"
    '            ltable = ltable & "<td style='border-left: gray 1px solid;'> </td>"
    '            ltable = ltable & "<td style='border-left: gray 1px solid;'>" & row.Item("nm_item").ToString & "</td>"
    '            ltable = ltable & "<td style='border-left: gray 1px solid;'>" & row.Item("cd_unidade_medida").ToString & "</td>"
    '            ltable = ltable & "<td style='border-left: gray 1px solid;'>" & row.Item("nr_quantidade_prevista").ToString & "</td>"
    '            ltable = ltable & "<td style='border-left: gray 1px solid;'>R$</td>"
    '            ltable = ltable & "<td style='border-left: gray 1px solid;'>" & Round(CDbl(row.Item("nr_valor_unitario").ToString), 2).ToString & "</td>"
    '            ltable = ltable & "<td style='border-left: gray 1px solid;'>0,00</td>"
    '            ltable = ltable & "<td style='border-left: gray 1px solid;'>0,00</td>"
    '            ltable = ltable & "<td style='border-left: gray 1px solid;'>" & row.Item("nr_perc_icms").ToString & "</td>"
    '            ltable = ltable & "<td style='border-left: gray 1px solid;'>" & row.Item("nr_valor_total_item").ToString & "</td>"
    '            ltable = ltable & "<td style='border-left: gray 1px solid;'>" & Left(row.Item("dt_entrega_prevista").ToString, 10) & "</td></tr>"
    '        Next
    '        lcorpo = Replace(lcorpo, "$dsgrid", ltable.ToString)

    '        Dim notificacao As New Notificacao
    '        arqTemp.Close()
    '        If notificacao.enviaMensagemEmail(lassunto, lcorpo, "recepcao.de.leite-pocos@danone.com", lemail_parceiro, , MailPriority.High, True) = True Then

    '            messageControl.Alert("Email enviado ao parceiro com sucesso!")
    '        Else

    '            messageControl.Alert("Email ao parceiro não foi enviado com sucesso!")

    '        End If
    '    Else
    '        messageControl.Alert("O email não pode ser enviado pois não há nenhum email informado no cadastrado do Parceiro!")
    '    End If

    'End Sub

    Protected Sub lk_email_parceiro_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles lk_email_parceiro.Click
        Dim lassunto As String
        Dim lcorpo As String
        Dim arqTemp As StreamReader
        Dim lcaminhoservidor As String = System.Configuration.ConfigurationManager.AppSettings("PathReports").ToString()
        'Dim lcaminhoservidor As String = "http://" & System.Configuration.ConfigurationManager.AppSettings("ApplicationServer").ToString()
        Dim propriedade As New Propriedade(Convert.ToInt32(ViewState.Item("id_propriedade").ToString))
        Dim produtor As New Pessoa(Convert.ToInt32(ViewState.Item("id_produtor").ToString))
        Dim fornecedor As New Pessoa(Convert.ToInt32(ViewState.Item("id_fornecedor").ToString))
        Dim lemail_parceiro As String
        Dim lemail_parceiro2 As String = String.Empty 'fran fase 2 melhorias
        Dim ldatahj As Date = DateTime.Parse(Now).ToString("dd/MM/yyyy")
        Dim lstipofrete As String = String.Empty

        lemail_parceiro = fornecedor.ds_email
        If lemail_parceiro.Equals(String.Empty) Then
            If Not fornecedor.ds_email2 Is Nothing Then
                lemail_parceiro = fornecedor.ds_email2
            Else
                lemail_parceiro = String.Empty
            End If
            'fran fase 2 melhorias i se existe o primeiro email, busca o 2
        Else
            If Not fornecedor.ds_email2 Is Nothing Then 'se nao for nothing, joga o valor no para2
                lemail_parceiro2 = fornecedor.ds_email2
            End If
        End If
        'fran fase 2 melhorias f

        'FRAN 08/12/2020 i incluir log 
        Dim usuariolog As New UsuarioLog
        usuariolog.id_usuario = Session("id_login")
        usuariolog.ds_id_session = Session.SessionID.ToString()
        usuariolog.id_tipo_log = 9 'ENVIO EMAIL
        usuariolog.id_menu_item = 97
        usuariolog.id_nr_processo = lbl_id_central_pedido.Text
        usuariolog.nm_nr_processo = lbl_id_central_pedido.Text
        usuariolog.ds_nm_processo = "Pedidos - E-mail Parceiro"
        usuariolog.insertUsuarioLog()
        'fran 08/12/2020 f

        'lemail_parceiro = "franoliveira@hotmail.com"
        If Not lemail_parceiro.Equals(String.Empty) Then
            lassunto = String.Concat("DANONE - Pedido de Compra ", "Nr ", lbl_id_central_pedido.Text)
            arqTemp = New StreamReader(lcaminhoservidor & "\central_pedido_email_fornecedor.HTML", Encoding.UTF7)
            lcorpo = ""
            Do While Not arqTemp.EndOfStream
                lcorpo = lcorpo & arqTemp.ReadLine
            Loop

            lcorpo = Replace(lcorpo, "$nm_estabelecimento", ViewState.Item("nm_estabelecimento").ToString)
            lcorpo = Replace(lcorpo, "$dt_hoje", String.Concat(Format(ldatahj, "dd").ToString, " de ", Format(ldatahj, "MMMM").ToString, " de ", Format(ldatahj, "yyyy").ToString & "."))
            lcorpo = Replace(lcorpo, "$id_pedido", ViewState.Item("id_central_pedido").ToString)
            lcorpo = Replace(lcorpo, "$nm_fornecedor", fornecedor.nm_pessoa)
            lcorpo = Replace(lcorpo, "$ds_fornec_contato", fornecedor.ds_contato)
            lcorpo = Replace(lcorpo, "$email", fornecedor.ds_email)
            lcorpo = Replace(lcorpo, "$fone1", fornecedor.ds_telefone_1)
            lcorpo = Replace(lcorpo, "$fone2", fornecedor.ds_telefone_2)

            lcorpo = Replace(lcorpo, "$nm_produtor", produtor.nm_pessoa)
            lcorpo = Replace(lcorpo, "$cd_produtor", produtor.cd_pessoa)
            lcorpo = Replace(lcorpo, "$nm_propriedade", propriedade.nm_propriedade)
            lcorpo = Replace(lcorpo, "$id_propriedade", propriedade.id_propriedade)
            lcorpo = Replace(lcorpo, "$nr_unid_producao", lbl_up.Text.ToString)
            'fran fase 2 melhorias i
            'lcorpo = Replace(lcorpo, "$bairro_produtor", produtor.ds_bairro)
            'lcorpo = Replace(lcorpo, "$cidade_produtor", produtor.nm_cidade)
            'lcorpo = Replace(lcorpo, "$nm_estado_produtor", produtor.nm_estado)
            lcorpo = Replace(lcorpo, "$bairro_produtor", propriedade.ds_bairro)
            lcorpo = Replace(lcorpo, "$cidade_produtor", propriedade.nm_cidade)
            lcorpo = Replace(lcorpo, "$nm_estado_produtor", propriedade.nm_estado)
            'fran fase 2 melhorias 2

            If produtor.st_categoria = "F" Then
                lcorpo = Replace(lcorpo, "$cnpjprodutor", produtor.cd_cpf)
            Else
                lcorpo = Replace(lcorpo, "$cnpjprodutor", produtor.cd_cnpj)
            End If
            'fran fase 2 melhorias i
            'lcorpo = Replace(lcorpo, "$inscrestadualprodutor", produtor.cd_inscricao_estadual)
            'lcorpo = Replace(lcorpo, "$ds_contato", produtor.ds_contato)
            lcorpo = Replace(lcorpo, "$inscrestadualprodutor", propriedade.cd_inscricao_estadual)
            lcorpo = Replace(lcorpo, "$ds_contato", propriedade.ds_contato)
            'fran fase 2 melhorias f
            lcorpo = Replace(lcorpo, "$prodfone3", produtor.ds_telefone_1)
            lcorpo = Replace(lcorpo, "$prodfone4", produtor.ds_telefone_2)

            Dim pedido As New Pedido
            pedido.id_central_pedido = Convert.ToInt32(ViewState.Item("id_central_pedido"))
            Dim dsgrid As DataSet = pedido.getCentralPedidoEmailParceiroItens()
            Dim row As DataRow
            Dim ltable As String = String.Empty
            Dim i As Integer = 1
            For Each row In dsgrid.Tables(0).Rows
                If i > 1 Then
                    ltable = ltable & "<tr><td style='width: 20px; height: 15px;'>&nbsp;</td><td style='width: 27px; height: 15px;'>&nbsp;</td><td colspan='2' style='height: 15px'>&nbsp;</td><td colspan='4' style='height: 15px'>&nbsp;</td></tr>"
                End If
                ltable = "<tr><td style='width: 20px; height: 17px;'>&nbsp;</td>"
                ltable = ltable & "<td style='width: 27px; font-weight: bold; height: 17px;'>2." & i.ToString & ".</td>"
                ltable = ltable & "<td colspan='6' style='font-weight: bold; height: 17px'>" & row.Item("nm_item").ToString & "</td>"
                ltable = ltable & "</tr>"

                ltable = ltable & "<tr><td style='width: 20px; height: 17px;'>&nbsp;</td><td style='width: 27px; height: 17px;'>&nbsp;</td>"
                ltable = ltable & "<td colspan='2' style=' height: 17px;'>Quantidade:</td>"
                'fran 09/11/2011 chamado 1132 i
                'ltable = ltable & "<td colspan='4' style='height: 17px'>" & CInt(row.Item("nr_quantidade")).ToString & " " & row.Item("nm_unidade_medida").ToString & "</td>"
                ltable = ltable & "<td colspan='4' style='height: 17px'>" & row.Item("nr_quantidade").ToString & " " & row.Item("nm_unidade_medida").ToString & "</td>"
                'fran 09/11/2011 chamado 1132 f
                ltable = ltable & "</tr>"
                ltable = ltable & "<tr><td style='width: 20px; height: 17px;'>&nbsp;</td><td style='width: 27px; height: 17px;'>&nbsp;</td>"
                ltable = ltable & "<td colspan='2' style='height: 17px'>Embalagem:</td>"
                ltable = ltable & "<td colspan='4' style='height: 17px'>" & row.Item("ds_tipo_medida").ToString & "</td>"
                ltable = ltable & "</tr>"
                'fran 30/07/2010 i chamado 682 -
                If CInt(ViewState.Item("id_grupo")) <> 3 Then 'se o fornecedor for transportador de frete não exibe valor unitario e sacaria
                    ltable = ltable & "<tr><td style='width: 20px; height: 17px;'>&nbsp;</td><td style='width: 27px; height: 17px;'>&nbsp;</td>"
                    ltable = ltable & "<td colspan='2' style='height: 17px'>Preço Unitário:</td>"
                    ltable = ltable & "<td colspan='4' style='height: 17px'>" & FormatCurrency(row.Item("nr_valor_unitario"), 2).ToString & "</td>"
                    ltable = ltable & "</tr>"
                    ltable = ltable & "<tr><td style='width: 20px; height: 17px;'>&nbsp;</td><td style='width: 27px; height: 17px;'>&nbsp;</td>"
                    ltable = ltable & "<td colspan='2' style='height: 17px'>Preço Sacaria:</td>"
                    ltable = ltable & "<td colspan='4' style='height: 17px'>" & FormatCurrency(row.Item("nr_sacaria"), 2).ToString & "</td>"
                    ltable = ltable & "</tr>"
                End If
                'fran 30/07/2010 f chamado 682 -
                'fran 07/12/2010 i chamado 1080
                'ltable = ltable & "<tr><td style='width: 20px; height: 17px;'>&nbsp;</td><td style='width: 27px; height: 17px;'>&nbsp;</td>"
                'ltable = ltable & "<td colspan='2' style='height: 17px'>Preço Frete:</td>"
                'ltable = ltable & "<td colspan='4' style='height: 17px'>" & FormatCurrency(row.Item("nr_frete"), 2).ToString & "</td>"
                'ltable = ltable & "</tr>"

                If CInt(ViewState.Item("id_grupo")) <> 3 Then 'se nao é transportador
                    Dim cotfornecedor As New CotacaoFornecedor
                    cotfornecedor.id_central_cotacao = row.Item("id_central_cotacao")
                    cotfornecedor.id_fornecedor = Convert.ToInt32(ViewState.Item("id_fornecedor").ToString)
                    cotfornecedor.id_item = row.Item("id_item")
                    cotfornecedor.st_selecionado = "S"
                    Dim dscotfornecedor As DataSet = cotfornecedor.getCotacaoFornecedorByFilters
                    If dscotfornecedor.Tables(0).Rows.Count > 0 Then
                        'fran 09/01/2011 i chamado 1126
                        'If dscotfornecedor.Tables(0).Rows(0).Item("ds_tipo_frete").ToString.Trim <> "D" Then 'se não é fob-D
                        If dscotfornecedor.Tables(0).Rows(0).Item("ds_tipo_frete").ToString.Trim = "C" Then 'se não é fob-D nem fob-I
                            'fran 09/01/2011 f chamado 1126

                            ltable = ltable & "<tr><td style='width: 20px; height: 17px;'>&nbsp;</td><td style='width: 27px; height: 17px;'>&nbsp;</td>"
                            ltable = ltable & "<td colspan='2' style='height: 17px'>Preço Frete:</td>"
                            ltable = ltable & "<td colspan='4' style='height: 17px'>" & FormatCurrency(row.Item("nr_frete"), 2).ToString & "</td>"
                            ltable = ltable & "</tr>"
                        End If
                    Else 'se não tem linhas
                        ltable = ltable & "<tr><td style='width: 20px; height: 17px;'>&nbsp;</td><td style='width: 27px; height: 17px;'>&nbsp;</td>"
                        ltable = ltable & "<td colspan='2' style='height: 17px'>Preço Frete:</td>"
                        ltable = ltable & "<td colspan='4' style='height: 17px'>" & FormatCurrency(row.Item("nr_frete"), 2).ToString & "</td>"
                        ltable = ltable & "</tr>"

                    End If
                Else
                    ltable = ltable & "<tr><td style='width: 20px; height: 17px;'>&nbsp;</td><td style='width: 27px; height: 17px;'>&nbsp;</td>"
                    ltable = ltable & "<td colspan='2' style='height: 17px'>Preço Frete:</td>"
                    ltable = ltable & "<td colspan='4' style='height: 17px'>" & FormatCurrency(row.Item("nr_frete"), 2).ToString & "</td>"
                    ltable = ltable & "</tr>"
                End If
                'fran 07/12/2010 f chamado 1080
                ltable = ltable & "<tr><td style='width: 20px; height: 17px;'>&nbsp;</td><td style='width: 27px; height: 17px;'>&nbsp;</td>"
                ltable = ltable & "<td colspan='2' style='height: 17px'>Valor Total:</td>"
                ltable = ltable & "<td colspan='4' style='height: 17px'>" & FormatCurrency(row.Item("nr_valor_total"), 2).ToString & "</td>"
                ltable = ltable & "</tr>"

                'fran 08/2015 i melhorias relatorios
                ltable = ltable & "<tr><td style='width: 20px; height: 17px;'>&nbsp;</td><td style='width: 27px; height: 17px;'>&nbsp;</td>"
                ltable = ltable & "<td colspan='2' style='height: 17px'>Tipo Frete:</td>"
                lstipofrete = row.Item("ds_tipo_frete").ToString
                Select Case row.Item("ds_tipo_frete").ToString
                    Case "D"
                        lstipofrete = "FOB-D"
                    Case "C"
                        lstipofrete = "CIF"
                    Case "I"
                        lstipofrete = "FOB-I"

                End Select
                ltable = ltable & "<td colspan='4' style='height: 17px'>" & lstipofrete & "</td>"
                ltable = ltable & "</tr>"

                If CInt(ViewState.Item("id_grupo")) = 3 Then 'se o fornecedor for transportador de frete exibe o nome do parceiro de compra 
                    ltable = ltable & "<tr><td style='width: 20px; height: 17px;'>&nbsp;</td><td style='width: 27px; height: 17px;'>&nbsp;</td>"
                    ltable = ltable & "<td colspan='2' style='height: 17px'>Parceiro:</td>"
                    ltable = ltable & "<td colspan='4' style='height: 17px'>" & row.Item("nm_parceiro_compra").ToString & "</td>"
                    ltable = ltable & "</tr>"
                End If
                'fran 08/2015 f melhorias relatorios


                'lcorpo = Replace(lcorpo, "$itens", i.ToString)
                i = i + 1
            Next
            Dim lentrega As String = String.Empty
            'fran 30/07/2010 i chamado 682 -
            If CInt(ViewState.Item("id_grupo")) <> 3 Then 'se o fornecedor for transportador de frete não existe grid de entregas
                'fran 30/07/2010 f chamado 682 -
                pedido.id_central_pedido = Convert.ToInt32(ViewState.Item("id_central_pedido"))
                Dim dsentrega As DataSet = pedido.getCentralPedidoEmailParceiroEntrega

                Dim rows As DataRow
                Dim j As Integer = 1
                For Each rows In dsentrega.Tables(0).Rows
                    lentrega = lentrega & "<tr><td style='width: 20px; height: 17px'>&nbsp;</td><td style='width: 27px; height: 17px'>&nbsp;</td>"
                    lentrega = lentrega & "<td style='width: 35px; height: 17px'>3.1." & j.ToString & "</td>"
                    lentrega = lentrega & "<td colspan='2' >Entrega " & j.ToString & ":</td>"
                    lentrega = lentrega & "<td colspan='3' style='height: 17px'>"
                    lentrega = lentrega & DateTime.Parse(rows.Item("dt_entrega").ToString).ToString("dd/MM/yyyy") & "</td>"
                    lentrega = lentrega & "</tr>"
                    j = j + 1
                Next
            End If

            'fran 01/2014 fase 2 melhorias i
            'Dim dspagto As DataSet = pedido.getCentralPedidoEmailParceiroPagto
            'Dim lpagtofornec As String = String.Empty
            'i = 1
            'For Each row In dspagto.Tables(0).Rows
            '    lpagtofornec = lpagtofornec & "<tr><td style='width: 20px;'>&nbsp;</td><td style='width: 27px; height: 17px;'>&nbsp;</td>"
            '    'fran 30/07/2010 i chamado 682 -
            '    If CInt(ViewState.Item("id_grupo")) = 3 Then 'se o fornecedor for transportador de frete o item é 3.1 pois não há entrega
            '        lpagtofornec = lpagtofornec & "<td style='width: 35px; '>3.1." & i.ToString & "</td>"
            '    Else
            '        'fran 30/07/2010 f chamado 682 -
            '        lpagtofornec = lpagtofornec & "<td style='width: 35px; '>3.2." & i.ToString & "</td>"
            '    End If
            '    lpagtofornec = lpagtofornec & "<td colspan='2' >Parcela " & i.ToString & ":</td>"
            '    lpagtofornec = lpagtofornec & "<td colspan='3' >" & row.Item("dt_pagto").ToString & "</td>"
            '    lpagtofornec = lpagtofornec & "</tr>"
            '    i = i + 1
            'Next
            'Foi implementado um combo em cotação, no grid de itens, prazo de pagto. Vamos substituir as datas de pagamento pelo texto do combo
            Dim lpagtofornec As String = String.Empty
            i = 1
            For Each row In dsgrid.Tables(0).Rows
                lpagtofornec = lpagtofornec & "<tr><td style='width: 20px;'>&nbsp;</td><td style='width: 27px; height: 17px;'>&nbsp;</td>"
                If CInt(ViewState.Item("id_grupo")) = 3 Then 'se o fornecedor for transportador de frete o item é 3.1 pois não há entrega
                    lpagtofornec = lpagtofornec & "<td style='width: 35px; '>3.1." & i.ToString & "</td>"
                Else
                    lpagtofornec = lpagtofornec & "<td style='width: 35px; '>3.2." & i.ToString & "</td>"
                End If
                lpagtofornec = lpagtofornec & "<td colspan='2' >Item " & row.Item("nm_item").ToString & ":</td>"
                'fran 06/2019 - se parcelamento parceuiro deve informar as parcelas
                If CInt(ViewState.Item("id_grupo")) <> 3 AndAlso row.Item("st_parcelamento").ToString.Equals("P") AndAlso CInt(row.Item("nr_parcelas").ToString) > 1 Then
                    lpagtofornec = lpagtofornec & "<td colspan='3' >" & row.Item("nm_central_prazo_pagto").ToString & " em " & row.Item("nr_parcelas").ToString & " Parcelas</td>"
                Else
                    lpagtofornec = lpagtofornec & "<td colspan='3' >" & row.Item("nm_central_prazo_pagto").ToString & "</td>"
                End If
                lpagtofornec = lpagtofornec & "</tr>"
                i = i + 1
            Next
            'fran 01/2014 fase 2 melhorias f

            lcorpo = Replace(lcorpo, "$dsgriditens", ltable.ToString)
            lcorpo = Replace(lcorpo, "$dspagtofornec", lpagtofornec.ToString)
            lcorpo = Replace(lcorpo, "$dsentrega", lentrega.ToString)
            lcorpo = Replace(lcorpo, "ecxtextosmall", "textosmall")
            'lcorpo = Replace(lcorpo, "$itemcondgerais", i)
            'lcorpo = Replace(lcorpo, "$itemaprov", i + 1)

            'fran envio email datas i
            pedido.id_central_pedido = Convert.ToInt32(ViewState.Item("id_central_pedido"))
            pedido.id_modificador = Session("id_login")
            'fran envio email datas f


            Dim notificacao As New Notificacao
            arqTemp.Close()
            'fran 24/08/2010 i chamado 931
            'If notificacao.enviaMensagemEmail(lassunto, lcorpo, "recepcao.de.leite-pocos@danone.com", lemail_parceiro, , MailPriority.High, True) = True Then
            'fran 14/01/2014 i fase 2 melhoria
            'If notificacao.enviaMensagemEmail(lassunto, lcorpo, "central.compras@danone.com", lemail_parceiro, , MailPriority.High, True) = True Then
            If notificacao.enviaMensagemEmail(lassunto, lcorpo, "central.compras@danone.com", lemail_parceiro, "central.compras@danone.com", MailPriority.High, True, lemail_parceiro2, False) = True Then
                'fran 14/01/2014 f fase 2 melhoria
                pedido.st_envio_email = "S"  'fran envio email datas i
                pedido.updateCentralPedidoDataEnvioEmail() 'fran envio email datas i

                'fran 24/08/2010 f chamado 931
                messageControl.Alert("Email enviado ao parceiro com sucesso!")
            Else

                pedido.st_envio_email = "N"  'fran envio email datas i
                pedido.updateCentralPedidoDataEnvioEmail() 'fran envio email datas i

                messageControl.Alert("Email ao parceiro não foi enviado com sucesso!")

            End If
        Else
            Dim pedido As New Pedido
            pedido.id_central_pedido = Convert.ToInt32(ViewState.Item("id_central_pedido"))
            pedido.st_envio_email = "E"  'indica que Nao tem email no cadstro fran envio email datas i
            pedido.id_modificador = Session("id_login")
            pedido.updateCentralPedidoDataEnvioEmail() 'fran envio email datas i

            messageControl.Alert("O email não pode ser enviado pois não há nenhum email informado no cadastrado do Parceiro!")
        End If

    End Sub
    Protected Sub btn_adicionar_desconto_prod_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btn_adicionar_desconto_prod.Click
        If Page.IsValid Then

            ViewState.Item("incluirlinha") = "S"
            Dim desc As New PedidoDescontoProdutor
            desc.id_central_pedido_item = Convert.ToInt32(ViewState.Item("id_central_pedido_item"))
            Dim dsdesc As DataSet = desc.getPedidoDescontoProdutorByFilters()
            Dim dr As DataRow = dsdesc.Tables(0).NewRow()
            dsdesc.Tables(0).Rows.InsertAt(dr, 0)
            ViewState.Item("incluirlinhadesc") = "S"
            grdDescProdutor.Visible = True
            grdDescProdutor.DataSource = Helper.getDataView(dsdesc.Tables(0), "nr_parcela")
            grdDescProdutor.EditIndex = 0
            grdDescProdutor.DataBind()
            ViewState.Item("incluirlinha") = Nothing
            ViewState.Item("label_nr_nota_prod") = Nothing

        End If

    End Sub
    Protected Sub grdDescProdutor_PageIndexChanging(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewPageEventArgs) Handles grdDescProdutor.PageIndexChanging
        grdDescProdutor.PageIndex = e.NewPageIndex
        loadData()

    End Sub
    Protected Sub grdDescProdutor_RowCancelingEdit(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewCancelEditEventArgs) Handles grdDescProdutor.RowCancelingEdit
        Try

            grdDescProdutor.EditIndex = -1
            ViewState.Item("incluirlinhadesc") = "N"
            ViewState.Item("incluirlinhadesc") = Nothing
            loadGridDescontoProdutor()

        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub
    Protected Sub grdDescProdutor_RowCommand(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewCommandEventArgs) Handles grdDescProdutor.RowCommand
        Select Case e.CommandName.Trim.ToString
            Case "delete"
                deletePedidoDescontoProd(Convert.ToInt32(e.CommandArgument.ToString()))

        End Select

    End Sub
    Protected Sub grdDescProdutor_RowCreated(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewRowEventArgs) Handles grdDescProdutor.RowCreated
        If e.Row.RowType = DataControlRowType.DataRow AndAlso (e.Row.RowState = (DataControlRowState.Alternate Or DataControlRowState.Edit) OrElse e.Row.RowState = (DataControlRowState.Normal Or DataControlRowState.Edit)) Then
            Try
                'se esta reabrindo pedido desconto ao produtor
                'fran fase 3 dez/2014 i
                If ViewState.Item("ReabrirPedido") = "S" Then
                    Dim cbo_nr_nota As DropDownList = CType(e.Row.FindControl("cbo_nr_nota"), DropDownList)
                    Dim txt_nr_nota_fiscal As RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox = CType(e.Row.FindControl("txt_nr_nota_fiscal"), RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox)
                    Dim rf_cbo_nota_fiscal As RequiredFieldValidator = CType(e.Row.FindControl("rf_cbo_nota_fiscal"), RequiredFieldValidator)
                    Dim rqf_nr_nota As RequiredFieldValidator = CType(e.Row.FindControl("rqf_nr_nota"), RequiredFieldValidator)
                    rf_cbo_nota_fiscal.Visible = True
                    rqf_nr_nota.Visible = False
                    txt_nr_nota_fiscal.Visible = False
                    cbo_nr_nota.Visible = True

                    If ViewState.Item("incluirlinhadesc") = "S" Then
                        ViewState.Item("label_nr_nota_prod") = ""
                    End If

                    If Not (ViewState.Item("label_nr_nota_prod") Is Nothing) Then

                        Dim nrnotapedido As New PedidoDescontoProdutor
                        nrnotapedido.id_central_pedido_item = Convert.ToInt32(ViewState.Item("id_central_pedido_item").ToString)
                        cbo_nr_nota.DataSource = nrnotapedido.getCentralPedidoDescontoProdutorNotas()
                        cbo_nr_nota.DataTextField = "nr_nota_fiscal"
                        'cbo_nr_nota.DataValueField = "nr_valor_nota_fiscal"
                        cbo_nr_nota.DataValueField = "ds_nr_nota_valor"
                        cbo_nr_nota.DataBind()

                        If (ViewState.Item("label_nr_nota_prod").ToString.Equals(String.Empty)) Then
                            cbo_nr_nota.Items.Insert(0, New ListItem("[Selecione]", String.Empty))
                            ViewState.Item("label_nr_nota_prod") = "SEM_VALOR"
                        Else
                            cbo_nr_nota.SelectedValue = cbo_nr_nota.Items.FindByText(ViewState.Item("label_nr_nota_prod").Trim.ToString).Value
                            ViewState.Item("label_nr_nota_prod") = Nothing
                        End If
                    End If



                End If

                'fran fase 3 dez/2014 f

            Catch ex As Exception
                messageControl.Alert(ex.Message)
            End Try

        End If

    End Sub
    Protected Sub grdDescProdutor_RowDataBound(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewRowEventArgs) Handles grdDescProdutor.RowDataBound
        Dim lbl_st_mais_solidos As Label = CType(e.Row.FindControl("lbl_st_mais_solidos"), Label)
        Dim lbl_st_mais_solidos_valor_utilizado As Label = CType(e.Row.FindControl("lbl_st_mais_solidos_valor_utilizado"), Label)
        Dim lbl_saldo_mais_solidos As Label = CType(e.Row.FindControl("lbl_saldo_mais_solidos"), Label)
        Dim lnr_saldo_disponivel_referencia As Decimal = 0

        If e.Row.RowType = DataControlRowType.DataRow AndAlso (e.Row.RowState = (DataControlRowState.Alternate Or DataControlRowState.Edit) OrElse e.Row.RowState = (DataControlRowState.Normal Or DataControlRowState.Edit)) Then
            Dim dt_pagto As RK.TextBox.AjaxOnlyDate.OnlyDateTextBox = CType(e.Row.FindControl("txt_dt_pagto"), RK.TextBox.AjaxOnlyDate.OnlyDateTextBox)
            Dim chk_mais_solidos As CheckBox = CType(e.Row.FindControl("chk_mais_solidos"), CheckBox)

            'fran fase 3 set/2014 i 
            If ViewState.Item("ReabrirPedido") = "S" Then

                Dim cbo_nr_nota As DropDownList = CType(e.Row.FindControl("cbo_nr_nota"), DropDownList)
                Dim txt_nr_nota_fiscal As RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox = CType(e.Row.FindControl("txt_nr_nota_fiscal"), RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox)
                Dim txt_nr_valor_nota_fiscal As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(e.Row.FindControl("txt_nr_valor_nota_fiscal"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
                Dim rf_cbo_nota_fiscal As RequiredFieldValidator = CType(e.Row.FindControl("rf_cbo_nota_fiscal"), RequiredFieldValidator)
                Dim rqf_nr_nota As RequiredFieldValidator = CType(e.Row.FindControl("rqf_nr_nota"), RequiredFieldValidator)

                rf_cbo_nota_fiscal.Visible = True
                rqf_nr_nota.Visible = False

                cbo_nr_nota.Visible = True
                txt_nr_nota_fiscal.Visible = False
                txt_nr_valor_nota_fiscal.Enabled = False

                If ViewState.Item("label_nr_nota_prod") = "SEM_VALOR" Then
                    'Se já fez a criação  da linha e esta sem valor no combo , força o 'Selecione'
                    If Not (cbo_nr_nota Is Nothing) Then
                        cbo_nr_nota.Items.Insert(0, New ListItem("[Selecione]", String.Empty))
                    End If
                    ViewState.Item("label_nr_nota_prod") = Nothing
                End If
            End If


            'fran fase 3 set/2014 f 

            If Not dt_pagto.Text.Equals(String.Empty) Then
                'fran 16/03/2010 i
                'dt_pagto.Text = Left(dt_pagto.Text.Trim, 10)
                dt_pagto.Text = DateTime.Parse(dt_pagto.Text.Trim).ToString("dd/MM/yyyy")
                'fran 16/03/2010 f
            End If
            'Fran 10/2018 i
            'se produtor faz parte mais solidos
            If ViewState.Item("maissolidospremiado") = True Then
                If CDec(ViewState.Item("maissolidossaldodisponivel")) > 0 Then
                    If lbl_st_mais_solidos.Text = "S" Then
                        chk_mais_solidos.Checked = True
                        chk_mais_solidos.ToolTip = "Programa Mais Sólidos utilizado."
                    Else
                        chk_mais_solidos.Checked = False
                        If Not dt_pagto.Text.Equals(String.Empty) Then
                            BuscarMaisSolidosValorPremio(String.Concat("01", Right(dt_pagto.Text, 8)), 1, True, , , , lnr_saldo_disponivel_referencia)
                            If lnr_saldo_disponivel_referencia = 0 Then
                                chk_mais_solidos.Enabled = False
                                chk_mais_solidos.ToolTip = "O Saldo da REFERÊNCIA para o Programa Mais Sólidos está zerado."
                                lbl_saldo_mais_solidos.Visible = True
                                lbl_saldo_mais_solidos.Text = "Saldo: R$ 0,00"
                            Else
                                chk_mais_solidos.Enabled = True
                                chk_mais_solidos.ToolTip = String.Empty
                                lbl_saldo_mais_solidos.Visible = True
                                lbl_saldo_mais_solidos.Text = String.Concat("Saldo: ", FormatCurrency(lnr_saldo_disponivel_referencia, 2))
                            End If
                        Else
                            chk_mais_solidos.Enabled = False
                            lbl_saldo_mais_solidos.Visible = False
                        End If

                    End If

                Else 'saldo disponivel do programa zerado
                    'se o desconto está utilizando programa
                    If lbl_st_mais_solidos.Text = "S" Then
                        chk_mais_solidos.Checked = True
                    Else
                        chk_mais_solidos.Checked = False
                        chk_mais_solidos.Enabled = False
                        chk_mais_solidos.ToolTip = "O Saldo do Programa Mais Sólidos está zerado!"
                    End If

                End If
            End If
        Else
            If e.Row.RowType = DataControlRowType.DataRow Then

                Dim dt_pagto As Label = CType(e.Row.FindControl("lbl_dt_pagto"), Label)
                Dim img_st_utilizar_mais_solidos As Anthem.Image = CType(e.Row.FindControl("img_st_utilizar_mais_solidos"), Anthem.Image)

                'fran set/2014 fase 3 i
                'se nao tem nr nota veio de cotacao e acessa pedido pela primeira vez
                Dim lbl_nr_nota_fiscal As Label = CType(e.Row.FindControl("lbl_nr_nota_fiscal"), Label)
                If lbl_nr_nota_fiscal.Text.Equals(String.Empty) Then
                    ViewState.Item("DescProd1avez") = "S"
                Else
                    ViewState.Item("DescProd1avez") = "N"
                End If
                'fran set/2014 fase 3 f

                If Not dt_pagto.Text.Equals(String.Empty) Then
                    'fran 16/03/2010 i
                    'dt_pagto.Text = Left(dt_pagto.Text.Trim, 10)
                    dt_pagto.Text = DateTime.Parse(dt_pagto.Text.Trim).ToString("dd/MM/yyyy")
                    'fran 16/03/2010 f
                End If
                'fran 26/03/2012 i 
                Dim lbl_st_transf As Label = CType(e.Row.FindControl("lbl_st_transf"), Label)
                Dim lbl_pedidoorigem As Label = CType(e.Row.FindControl("lbl_pedido_ori"), Label)
                Dim lbl_proporigem As Label = CType(e.Row.FindControl("lbl_prop_ori"), Label)
                Dim btn_editar As Anthem.ImageButton = CType(e.Row.FindControl("btn_editar"), Anthem.ImageButton)
                Dim btn_delete As Anthem.ImageButton = CType(e.Row.FindControl("btn_delete"), Anthem.ImageButton)
                Dim bcalculado As Boolean = False 'fran 08/2014 fase 3
                Dim lbl_id_central_pedido_desconto_produtor As Label = CType(e.Row.FindControl("lbl_id_central_pedido_desconto_produtor"), Label)
                Dim lbl_nr_valor_parcela As Label = CType(e.Row.FindControl("lbl_nr_valor_parcela"), Label)

                If lbl_st_transf.Text = "S" Then 'se veio calculado de pedido anterior (transf volume)
                    Dim img_st_calculado As Anthem.Image = CType(e.Row.FindControl("img_st_calculado"), Anthem.Image)
                    img_st_calculado.ImageUrl = "~/img/ico_chk_true.gif"
                    img_st_calculado.ToolTip = "Cálculo efetivado no Pedido Origem, antes da transferência de volume."
                    'pedido
                    lbl_pedidoorigem.Text = lbl_pedido_origem.Text
                    'propriedade origem
                    lbl_proporigem.Text = lbl_propriedadeup_origem.Text
                    bcalculado = True 'fran 08/2014 fase 3
                Else
                    'fran 15/05/2012 Themis
                    Dim desctoprodutor As New PedidoDescontoProdutor
                    'fran 01/06/2012 chamado 1560 i
                    If lbl_id_central_pedido_desconto_produtor.Text.Equals(String.Empty) Then
                        Dim img_st_calculado As Anthem.Image = CType(e.Row.FindControl("img_st_calculado"), Anthem.Image)
                        img_st_calculado.ImageUrl = "~/img/ico_chk_false.gif"
                        bcalculado = False 'fran 08/2014 fase 3

                    Else
                        'fran 01/06/2012 chamado 1560 f

                        desctoprodutor.id_central_pedido_desconto_produtor = Convert.ToInt32(lbl_id_central_pedido_desconto_produtor.Text)
                        If desctoprodutor.getPedidoDescontoProdutorCalculado > 0 Then
                            Dim img_st_calculado As Anthem.Image = CType(e.Row.FindControl("img_st_calculado"), Anthem.Image)
                            img_st_calculado.ImageUrl = "~/img/ico_chk_true.gif"
                            img_st_calculado.ToolTip = "Cálculo definitivo executado."
                            bcalculado = True 'fran 08/2014 fase 3
                        Else
                            Dim img_st_calculado As Anthem.Image = CType(e.Row.FindControl("img_st_calculado"), Anthem.Image)
                            img_st_calculado.ImageUrl = "~/img/ico_chk_false.gif"
                            bcalculado = False 'fran 08/2014 fase 3

                        End If
                        'fran 26/03/2012 f 
                    End If
                    'fran fase 3 8/2014 i
                    'se ja tem calculo nao pode alterar 
                    If ViewState.Item("ReabrirPedido") = "S" Then

                        If bcalculado = True Then
                            btn_editar.Enabled = False
                            btn_delete.Enabled = False
                            btn_editar.ImageUrl = "~/img/icone_editar_grid_desabilitado.gif"
                            btn_delete.ImageUrl = "~/img/icone_excluir_desabilitado.gif"
                        Else
                            'Dim txt_nr_nota_fiscal As RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox = CType(e.Row.FindControl("txt_nr_nota_fiscal"), RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox)
                            'Dim txt_nr_valor_nota_fiscal As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(e.Row.FindControl("txt_nr_valor_nota_fiscal"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)

                            'txt_nr_nota_fiscal.Enabled = False
                            'txt_nr_valor_nota_fiscal.Enabled = False
                        End If
                    End If
                    'fran fase 3 8/2014 f

                End If

                'Fran 10/2018 i
                If lbl_id_central_pedido_desconto_produtor.Text.Equals(String.Empty) Then
                    img_st_utilizar_mais_solidos.ImageUrl = "~/img/ico_chk_false.gif"
                Else
                    'se produtor faz parte mais solidos
                    If ViewState.Item("maissolidospremiado") = True Then
                        If CDec(ViewState.Item("maissolidossaldodisponivel")) > 0 Then
                            If lbl_st_mais_solidos.Text = "S" Then
                                img_st_utilizar_mais_solidos.ImageUrl = "~/img/ico_chk_true.gif"
                                img_st_utilizar_mais_solidos.ToolTip = "Programa Mais Sólidos utilizado."
                                lbl_saldo_mais_solidos.Text = String.Empty
                            Else
                                BuscarMaisSolidosValorPremio(String.Concat("01", Right(dt_pagto.Text, 8)), CDec(lbl_nr_valor_parcela.Text), True, , , , lnr_saldo_disponivel_referencia)
                                img_st_utilizar_mais_solidos.ImageUrl = "~/img/ico_chk_false.gif"
                                If lnr_saldo_disponivel_referencia = 0 Then
                                    lbl_saldo_mais_solidos.Text = "Saldo: R$ 0,00"
                                Else
                                    lbl_saldo_mais_solidos.Text = String.Concat("Saldo: ", FormatCurrency(lnr_saldo_disponivel_referencia, 2))

                                End If

                            End If

                        Else 'saldo disponivel do programa zerado
                            'se o desconto está utilizando programa
                            If lbl_st_mais_solidos.Text = "S" Then
                                img_st_utilizar_mais_solidos.ImageUrl = "~/img/ico_chk_true.gif"
                                img_st_utilizar_mais_solidos.ToolTip = "Programa Mais Sólidos utilizado."
                                lbl_saldo_mais_solidos.Text = String.Empty
                            Else
                                img_st_utilizar_mais_solidos.ImageUrl = "~/img/ico_chk_false.gif"
                                lbl_saldo_mais_solidos.Text = "Saldo: R$ 0,00"
                            End If

                        End If
                        'se ainda nao gravou

                    End If


                End If
            End If
        End If
    End Sub
    Protected Sub grdDescProdutor_RowDeleting(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewDeleteEventArgs) Handles grdDescProdutor.RowDeleting
        e.Cancel = True

    End Sub
    Protected Sub grdDescProdutor_RowEditing(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewEditEventArgs) Handles grdDescProdutor.RowEditing
        Try
            If ViewState.Item("incluirlinha") = "S" And e.NewEditIndex = 0 Then
                ViewState.Item("incluirlinha") = "S"
                loadGridDescontoProdutor()
            Else
                Dim lbl_nr_nota_fiscal As Label = CType(grdDescProdutor.Rows(e.NewEditIndex).FindControl("lbl_nr_nota_fiscal"), Label)
                ViewState.Item("label_nr_nota_prod") = Trim(lbl_nr_nota_fiscal.Text) 'fran fase 3 dez/2014
                grdDescProdutor.EditIndex = e.NewEditIndex
                loadGridDescontoProdutor()
            End If
        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub

    Protected Sub grdDescProdutor_RowUpdated(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewUpdatedEventArgs) Handles grdDescProdutor.RowUpdated

    End Sub
    Protected Sub grdDescProdutor_RowUpdating(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewUpdateEventArgs) Handles grdDescProdutor.RowUpdating
        Dim row As GridViewRow = grdDescProdutor.Rows(e.RowIndex)
        Try
            If Page.IsValid Then


                If (Not (row) Is Nothing) Then

                    Dim desconto As New PedidoDescontoProdutor
                    Dim dsdesconto As DataSet

                    Dim lbl_id_central_pedido_item As Label = CType(row.FindControl("lbl_id_central_pedido_item"), Label)
                    Dim lbl_id_central_pedido_desconto_produtor As Label = CType(row.FindControl("lbl_id_central_pedido_desconto_produtor"), Label)

                    Dim nr_valor_nota_fiscal As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_valor_nota_fiscal"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
                    Dim nr_parcela As RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox = CType(row.FindControl("txt_nr_parcela"), RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox)
                    Dim nr_nota_fiscal As RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox = CType(row.FindControl("txt_nr_nota_fiscal"), RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox)
                    Dim nr_valor_parcela As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_valor_parcela"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
                    Dim dt_pagto As RK.TextBox.AjaxOnlyDate.OnlyDateTextBox = CType(row.FindControl("txt_dt_pagto"), RK.TextBox.AjaxOnlyDate.OnlyDateTextBox)
                    Dim cbo_nr_nota As DropDownList = CType(row.FindControl("cbo_nr_nota"), DropDownList) 'fran fase 3 set/2014
                    Dim chk_mais_solidos As CheckBox = CType(row.FindControl("chk_mais_solidos"), CheckBox)
                    Dim lbl_st_mais_solidos As Label = CType(row.FindControl("lbl_st_mais_solidos"), Label)
                    Dim lbl_st_mais_solidos_valor_utilizado As Label = CType(row.FindControl("lbl_st_mais_solidos_valor_utilizado"), Label)
                    Dim bmaissolidosincluir As Boolean = False
                    Dim bmaissolidosretirar As Boolean = False


                    'fran fase 3 set/2014 i
                    If ViewState.Item("ReabrirPedido") = "S" Then
                        desconto.nr_nota_fiscal = Convert.ToInt32(cbo_nr_nota.SelectedItem.Text)
                    Else
                        'fran fase 3 set/2014 f

                        If Not nr_nota_fiscal.Text.ToString.Equals(String.Empty) Then
                            desconto.nr_nota_fiscal = Convert.ToInt32(nr_nota_fiscal.Text)
                        End If
                    End If


                    If Not nr_valor_nota_fiscal.Text.ToString.Equals(String.Empty) Then
                        desconto.nr_valor_nota_fiscal = Convert.ToDecimal(nr_valor_nota_fiscal.Text)
                    End If

                    desconto.nr_parcela = nr_parcela.Text
                    desconto.dt_pagto = dt_pagto.Text
                    If Not nr_valor_parcela.Text.ToString.Equals(String.Empty) Then
                        desconto.nr_valor_parcela = Convert.ToDecimal(nr_valor_parcela.Text)
                    End If
                    desconto.id_modificador = Session("id_login")
                    desconto.id_central_pedido_item = Convert.ToInt32(ViewState.Item("id_central_pedido_item"))

                    'se esta querendo atualizar no mais solidos
                    If chk_mais_solidos.Checked = True Then
                        desconto.st_mais_solidos = "S"
                    Else
                        desconto.st_mais_solidos = "N"
                    End If

                    'fran 14/02/2011 chamado 1170 i só deixa atualizar ou inserir se algum campo for diferente do banco
                    dsdesconto = desconto.getPedidoDescontoProdutorByFilters 'fran 10/2018i
                    'If desconto.getPedidoDescontoProdutorByFilters.Tables(0).Rows.Count = 0 Then 'fran 10/2018i
                    If dsdesconto.Tables(0).Rows.Count = 0 Then
                        'fran 14/02/2011 chamado 1170 f
                        'Se é um novo item
                        If Not ViewState.Item("incluirlinhadesc") Is Nothing Then
                            If ViewState.Item("incluirlinhadesc") = "S" Then
                                desconto.id_central_pedido_desconto_produtor = desconto.insertPedidoCentralDescontoProdutor()
                                ViewState.Item("incluirlinhadesc") = Nothing

                                If ViewState.Item("maissolidospremiado") = True AndAlso desconto.st_mais_solidos = "S" Then
                                    bmaissolidosincluir = True
                                Else
                                    bmaissolidosincluir = False
                                End If
                            Else
                                desconto.id_central_pedido_desconto_produtor = Convert.ToInt32(lbl_id_central_pedido_desconto_produtor.Text)
                                desconto.updatePedidoDescontoProdutor()
                                If ViewState.Item("maissolidospremiado") = True AndAlso desconto.st_mais_solidos = "S" AndAlso Not lbl_st_mais_solidos.Text = "S" Then
                                    bmaissolidosincluir = True
                                End If
                                If ViewState.Item("maissolidospremiado") = True AndAlso desconto.st_mais_solidos = "N" AndAlso lbl_st_mais_solidos.Text = "S" Then
                                    bmaissolidosretirar = True
                                End If
                            End If
                        Else
                            desconto.id_central_pedido_desconto_produtor = Convert.ToInt32(lbl_id_central_pedido_desconto_produtor.Text)
                            desconto.updatePedidoDescontoProdutor()
                            If ViewState.Item("maissolidospremiado") = True AndAlso desconto.st_mais_solidos = "S" AndAlso Not lbl_st_mais_solidos.Text = "S" Then
                                bmaissolidosincluir = True
                            End If
                            If ViewState.Item("maissolidospremiado") = True AndAlso desconto.st_mais_solidos = "N" AndAlso lbl_st_mais_solidos.Text = "S" Then
                                bmaissolidosretirar = True
                            End If
                        End If
                        'fran 14/02/2011 chamado 1170 i

                        If ViewState.Item("DescProd1avez") = "S" Then
                            desconto.updatePedidoDescontoProdutorNotaData()
                        End If
                    Else
                        'fran 10/2018 i
                        'se é produtor premiado
                        If ViewState.Item("maissolidospremiado") = True AndAlso desconto.st_mais_solidos = "S" AndAlso Not lbl_st_mais_solidos.Text = "S" Then
                            bmaissolidosincluir = True
                        End If
                        If ViewState.Item("maissolidospremiado") = True AndAlso desconto.st_mais_solidos = "N" AndAlso lbl_st_mais_solidos.Text = "S" Then
                            bmaissolidosretirar = True
                        End If

                        If Not ViewState.Item("incluirlinhadesc") Is Nothing Then
                            If ViewState.Item("incluirlinhadesc") = "S" Then
                                ViewState.Item("incluirlinhadesc") = Nothing
                            End If
                        End If
                    End If
                    'fran 14/02/2011 chamado 1170 f
                    '**********************************************************************************************
                    'MAIS SOLIDOS
                    '***********************************************************************************************
                    'fran 10/2018 i MAIS SOLIDOS
                    Dim lnr_maissolidos_valor_premio As Decimal = 0
                    Dim lnrmssaldodisponivel As Decimal
                    Dim maissolidos As New Poupanca

                    If CInt(ViewState.Item("id_propriedade_titular")) > 0 Then
                        maissolidos.id_propriedade_titular = ViewState.Item("id_propriedade_titular")
                        maissolidos.id_pessoa = 0
                    Else
                        maissolidos.id_pessoa = Convert.ToInt32(ViewState.Item("id_produtor"))
                        maissolidos.id_propriedade_titular = 0
                    End If
                    maissolidos.id_poupanca_parametro = ViewState.Item("id_poupanca_parametro")
                    maissolidos.id_modificador = desconto.id_modificador
                    maissolidos.dt_referencia = String.Concat("01", Right(DateTime.Parse(desconto.dt_pagto).ToString("dd/MM/yyyy"), 8))

                    If Not lbl_id_central_pedido_desconto_produtor.Text.Equals(String.Empty) And Not desconto.id_central_pedido_desconto_produtor > 0 Then
                        desconto.id_central_pedido_desconto_produtor = Convert.ToInt32(lbl_id_central_pedido_desconto_produtor.Text)
                    End If

                    If bmaissolidosincluir = True Then
                        'busca o valor do premio, e se tiver premio devolve o valor do total da central atualizado
                        lnr_maissolidos_valor_premio = Me.BuscarMaisSolidosValorPremio(maissolidos.dt_referencia.ToString, desconto.nr_valor_parcela, True, , , , )

                        'se nao tem saldo para a referencia pagto
                        If lnr_maissolidos_valor_premio = 0 Then
                            'atualiza o desconto do produtor para nao pode utilizar saldo mais solidos
                            desconto.st_mais_solidos = "N"
                            desconto.nr_mais_solidos_valor_utilizado = 0
                            desconto.updatePedidoDescontoProdutorMaisSolidos()
                        Else
                            'se tema saldo, atualiza desconto ao produtor e poupanca premio
                            desconto.st_mais_solidos = "S"
                            desconto.nr_mais_solidos_valor_utilizado = lnr_maissolidos_valor_premio
                            desconto.updatePedidoDescontoProdutorMaisSolidos()

                            maissolidos.nr_valor_central = lnr_maissolidos_valor_premio
                            maissolidos.updateMaisSolidosPremio()

                            'atualiza saldo disponivel
                            lnrmssaldodisponivel = maissolidos.getMaisSolidosProdutorSaldoDisponivel
                            lbl_ms_valor_disponivel.Text = FormatCurrency(lnrmssaldodisponivel, 2)
                            ViewState.Item("maissolidossaldodisponivel") = lnrmssaldodisponivel

                        End If

                    End If

                    If bmaissolidosretirar Then
                        'atualiza o desconto do produtor para nao pode utilizar saldo mais solidos
                        desconto.st_mais_solidos = "N"
                        desconto.nr_mais_solidos_valor_utilizado = 0
                        desconto.updatePedidoDescontoProdutorMaisSolidos()

                        'se o desconto ao produtor deletado tem mais solidos
                        If Not lbl_st_mais_solidos_valor_utilizado.Text.Equals(String.Empty) Then
                            maissolidos.nr_valor_central = -CDec(lbl_st_mais_solidos_valor_utilizado.Text)
                            maissolidos.id_modificador = Session("id_login")
                            maissolidos.updateMaisSolidosPremio()
                        End If

                        'atualiza saldo disponivel
                        lnrmssaldodisponivel = maissolidos.getMaisSolidosProdutorSaldoDisponivel
                        lbl_ms_valor_disponivel.Text = FormatCurrency(lnrmssaldodisponivel, 2)
                        ViewState.Item("maissolidossaldodisponivel") = lnrmssaldodisponivel

                    End If
                    'fran 10/2018 f MAIS SOLIDOS

                    grdDescProdutor.EditIndex = -1

                    loadGridDescontoProdutor()

                End If
            End If
        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub
    Protected Sub gridEntrega_PageIndexChanging(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewPageEventArgs) Handles gridEntrega.PageIndexChanging
        gridEntrega.PageIndex = e.NewPageIndex
        loadData()

    End Sub
    Protected Sub gridEntrega_RowCancelingEdit(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewCancelEditEventArgs) Handles gridEntrega.RowCancelingEdit
        Try

            gridEntrega.EditIndex = -1
            ViewState.Item("incluirlinhaentrega") = "N"
            ViewState.Item("incluirlinhaentrega") = Nothing
            loadGridEntrega()

        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub
    Protected Sub gridEntrega_RowCommand(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewCommandEventArgs) Handles gridEntrega.RowCommand
        Select Case e.CommandName.Trim.ToString
            Case "delete"
                deletePedidoEntrega(Convert.ToInt32(e.CommandArgument.ToString()))

        End Select

    End Sub
    Protected Sub gridEntrega_RowCreated(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewRowEventArgs) Handles gridEntrega.RowCreated
        If e.Row.RowType = DataControlRowType.DataRow AndAlso (e.Row.RowState = (DataControlRowState.Alternate Or DataControlRowState.Edit) OrElse e.Row.RowState = (DataControlRowState.Normal Or DataControlRowState.Edit)) Then
            Try
                Dim cvparceiro As CustomValidator = CType(e.Row.FindControl("cv_parceiro"), CustomValidator)
                Dim dt_entrega_prevista As RK.TextBox.AjaxOnlyDate.OnlyDateTextBox = CType(e.Row.FindControl("txt_dt_entrega_prevista"), RK.TextBox.AjaxOnlyDate.OnlyDateTextBox)
                Dim nr_quantidade_prevista As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(e.Row.FindControl("txt_nr_quantidade_prevista"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
                Dim nr_parcela As RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox = CType(e.Row.FindControl("txt_nr_parcela"), RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox)

                If ViewState.Item("incluirlinha") = "S" Then
                    If e.Row.RowIndex = 0 Then
                        ViewState.Item("label_parceiro") = ""
                        ViewState.Item("label_tipo") = ""
                    End If
                End If
                If ViewState.Item("incluirlinhaentrega") = "S" Then
                    'cvparceiro.Enabled = True
                    nr_parcela.Enabled = True
                    'nr_quantidade_prevista.Enabled = True
                    'dt_entrega_prevista.Enabled = True
                Else
                    'cvparceiro.Enabled = False
                    nr_parcela.Enabled = False
                    'nr_quantidade_prevista.Enabled = False
                    'dt_entrega_prevista.Enabled = False
                End If


            Catch ex As Exception
                messageControl.Alert(ex.Message)
            End Try

        End If

    End Sub
    Protected Sub gridEntrega_RowDataBound(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewRowEventArgs) Handles gridEntrega.RowDataBound
        Dim lbl_st_selecionado As Label = CType(e.Row.FindControl("lbl_st_selecionado"), Label)
        Dim chk_st_selecionado As CheckBox = CType(e.Row.FindControl("chk_st_selecionado"), CheckBox)
        If e.Row.RowType = DataControlRowType.DataRow AndAlso (e.Row.RowState = (DataControlRowState.Alternate Or DataControlRowState.Edit) OrElse e.Row.RowState = (DataControlRowState.Normal Or DataControlRowState.Edit)) Then
            Try

                Dim dt_entrega_prevista As RK.TextBox.AjaxOnlyDate.OnlyDateTextBox = CType(e.Row.FindControl("txt_dt_entrega_prevista"), RK.TextBox.AjaxOnlyDate.OnlyDateTextBox)
                Dim dt_entrega_real As RK.TextBox.AjaxOnlyDate.OnlyDateTextBox = CType(e.Row.FindControl("txt_dt_entrega_real"), RK.TextBox.AjaxOnlyDate.OnlyDateTextBox)
                Dim nr_quantidade_real As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(e.Row.FindControl("txt_nr_quantidade_real"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)

                If Not dt_entrega_prevista.Text.Equals(String.Empty) Then
                    dt_entrega_prevista.Text = DateTime.Parse(dt_entrega_prevista.Text).ToString("dd/MM/yyyy")
                Else
                    dt_entrega_prevista.Text = String.Empty
                End If
                If Not dt_entrega_real.Text.Equals(String.Empty) Then
                    'fran 23/11/2010 chamado 1070 i
                    'dt_entrega_real.Text = DateTime.Parse(dt_entrega_prevista.Text).ToString("dd/MM/yyyy")
                    dt_entrega_real.Text = DateTime.Parse(dt_entrega_real.Text).ToString("dd/MM/yyyy")
                    'fran 23/11/2010 chamado 1070 f
                Else
                    dt_entrega_real.Text = String.Empty
                End If
                'fran fase 2 melhorias i
                If Not nr_quantidade_real.Text.Trim.Equals(String.Empty) Then
                    If CDec(nr_quantidade_real.Text) = 0 Then
                        nr_quantidade_real.Text = String.Empty
                    End If
                End If
                'fran fase 2 melhorias f

            Catch ex As Exception
                messageControl.Alert(ex.Message)
            End Try
        Else
            If e.Row.RowType = DataControlRowType.DataRow Then
                Dim dt_entrega_prevista As Label = CType(e.Row.FindControl("lbl_dt_entrega_prevista"), Label)
                Dim dt_entrega_real As Label = CType(e.Row.FindControl("lbl_dt_entrega_real"), Label)
                If Not dt_entrega_prevista.Text.Equals(String.Empty) Then
                    dt_entrega_prevista.Text = DateTime.Parse(dt_entrega_prevista.Text).ToString("dd/MM/yyyy")
                End If

                If Not dt_entrega_real.Text.Equals(String.Empty) Then
                    'fran 23/11/2010 chamado 1070 i
                    'dt_entrega_real.Text = DateTime.Parse(dt_entrega_prevista.Text).ToString("dd/MM/yyyy")
                    dt_entrega_real.Text = DateTime.Parse(dt_entrega_real.Text).ToString("dd/MM/yyyy")
                    'fran 23/11/2010 chamado 1070 f
                End If
                'se finalizado
                'fran 05/05/2010 i chamado 812
                'fran chamado 998 i 
                'If ViewState.Item("id_situacao_pedido").ToString = "3" Then
                If ViewState.Item("id_situacao_pedido").ToString <> "1" Then
                    'fran chamado 998 f

                    Dim btn_delete As ImageButton = CType(e.Row.FindControl("btn_delete"), ImageButton)
                    btn_delete.Visible = False
                End If
                'fran 05/05/2010 i chamado 812

            End If
        End If

    End Sub
    Protected Sub gridEntrega_RowDeleting(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewDeleteEventArgs) Handles gridEntrega.RowDeleting
        e.Cancel = True

    End Sub
    Protected Sub gridEntrega_RowEditing(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewEditEventArgs) Handles gridEntrega.RowEditing
        Try
            If ViewState.Item("incluirlinha") = "S" And e.NewEditIndex = 0 Then
                ViewState.Item("incluirlinha") = "S"
                loadGridEntrega()
            Else
                gridEntrega.EditIndex = e.NewEditIndex
                loadGridEntrega()
            End If
        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub
    Protected Sub gridEntrega_RowUpdating(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewUpdateEventArgs) Handles gridEntrega.RowUpdating
        Dim row As GridViewRow = gridEntrega.Rows(e.RowIndex)
        Try
            If Page.IsValid Then


                If (Not (row) Is Nothing) Then

                    Dim entrega As New PedidoEntrega

                    Dim lbl_id_central_pedido_item As Label = CType(row.FindControl("lbl_id_central_pedido_item"), Label)
                    Dim lbl_id_central_pedido_entrega As Label = CType(row.FindControl("lbl_id_central_pedido_entrega"), Label)

                    Dim lvalor_total As Decimal
                    Dim lqtdeitem As Decimal

                    Dim dt_entrega_prevista As RK.TextBox.AjaxOnlyDate.OnlyDateTextBox = CType(row.FindControl("txt_dt_entrega_prevista"), RK.TextBox.AjaxOnlyDate.OnlyDateTextBox)
                    Dim nr_quantidade_prevista As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_quantidade_prevista"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
                    Dim nr_parcela As RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox = CType(row.FindControl("txt_nr_parcela"), RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox)
                    Dim nr_quantidade_real As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_quantidade_real"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
                    Dim dt_entrega_real As RK.TextBox.AjaxOnlyDate.OnlyDateTextBox = CType(row.FindControl("txt_dt_entrega_real"), RK.TextBox.AjaxOnlyDate.OnlyDateTextBox)

                    entrega.dt_entrega_prevista = DateTime.Parse(dt_entrega_prevista.Text).ToString("dd/MM/yyyy")
                    entrega.nr_quantidade_prevista = Convert.ToDecimal(nr_quantidade_prevista.Text)
                    'fran chamado 608 i
                    'entrega.nr_parcela = Convert.ToDecimal(nr_parcela.Text)
                    If nr_parcela.Text.Equals(String.Empty) Then
                        entrega.nr_parcela = 0
                    Else
                        entrega.nr_parcela = Convert.ToInt32(nr_parcela.Text)
                    End If
                    'fran chamado 608 f

                    If Not dt_entrega_real.Text.Equals(String.Empty) Then
                        entrega.dt_entrega_real = DateTime.Parse(dt_entrega_real.Text).ToString("dd/MM/yyyy")
                    End If
                    If Not nr_quantidade_real.Text.Equals(String.Empty) Then
                        entrega.nr_quantidade_real = Convert.ToDecimal(nr_quantidade_real.Text)
                    End If


                    entrega.id_modificador = Session("id_login")
                    entrega.id_central_pedido_item = Convert.ToInt32(ViewState.Item("id_central_pedido_item"))

                    'fran 14/02/2011 chamado 1170 i só deixa atualizar ou inserir se algum campo for diferente do banco
                    If entrega.getPedidoEntregaByFilters.Tables(0).Rows.Count = 0 Then
                        'fran 14/02/2011 chamado 1170 f
                        'Se é um novo item
                        If Not ViewState.Item("incluirlinhaentrega") Is Nothing Then
                            If ViewState.Item("incluirlinhaentrega") = "S" Then
                                entrega.insertPedidoCentralEntrega()
                                ViewState.Item("incluirlinhaentrega") = Nothing
                            Else
                                entrega.id_central_pedido_entrega = Convert.ToInt32(lbl_id_central_pedido_entrega.Text)
                                entrega.updatePedidoEntrega()
                            End If
                        Else
                            entrega.id_central_pedido_entrega = Convert.ToInt32(lbl_id_central_pedido_entrega.Text)
                            entrega.updatePedidoEntrega()
                        End If
                        'fran 14/02/2011 chamado 1170 i
                    Else
                        If Not ViewState.Item("incluirlinhaentrega") Is Nothing Then
                            If ViewState.Item("incluirlinhaentrega") = "S" Then
                                ViewState.Item("incluirlinhaentrega") = Nothing
                            End If
                        End If
                    End If
                    'fran 14/02/2011 chamado 1170 f

                    gridEntrega.EditIndex = -1

                    loadGridEntrega()

                End If
            End If
        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub
    Protected Sub cv_pedido_ServerValidate(ByVal source As Object, ByVal args As System.Web.UI.WebControls.ServerValidateEventArgs) Handles cv_pedido.ServerValidate

        Try
            Dim lmsg As String
            Dim lvalid As Boolean
            Dim pedido As New Pedido
            Dim dspedido As DataSet
            Dim row As DataRow
            args.IsValid = True
            pedido.id_central_pedido = Convert.ToInt32(ViewState.Item("id_central_pedido"))


            If CInt(ViewState.Item("id_grupo")) <> 3 Then 'fran 30/07/2010 i chamado 682
                'Busca a somatoria das qtde previstas de ntrega de cada item do pedido
                dspedido = pedido.getCentralPedidoConsSomaQtdePrevista
                If dspedido.Tables(0).Rows.Count > 0 Then
                    For Each row In dspedido.Tables(0).Rows
                        'se a qtde do pedido subtraindo a soma da qtde prevista para o item for diferente de zero
                        If Convert.ToDecimal(row.Item("qtde")) <> 0 Then
                            args.IsValid = False
                            lmsg = "O somatório da 'Qtde Prevista' está diferente da quantidade informada para o item " & row.Item("nm_item").ToString & "."
                            Exit For
                        End If
                    Next
                Else
                    args.IsValid = False
                    lmsg = "A quantidade prevista para Entregas deve ser informada!"
                End If
            End If
            'fran chamado 945 i 25/08/2010 - não deve consistir o somatorio das prcelas com o valor total do item nem para fornecedor nem para produtor
            'If args.IsValid = True Then

            '    'Busca a somatoria do valor das parcelas  e subtrai peo valor total do item
            '    dspedido = pedido.getCentralPedidoConsSomaValorFornecedor
            '    If dspedido.Tables(0).Rows.Count > 0 Then
            '        For Each row In dspedido.Tables(0).Rows
            '            'se o valor total do item do pedido subtraindo a soma do valor da parcelas para o item for diferente de zero
            '            If Convert.ToDecimal(row.Item("valor")) <> 0 Then
            '                args.IsValid = False
            '                lmsg = "Para o item " & row.Item("nm_item").ToString & ", o somatório do valor das parcelas do 'Pagamento ao Fonecedor' está diferente do valor total informado no pedido."
            '                Exit For
            '            End If
            '        Next
            '    Else
            '        args.IsValid = False
            '        lmsg = "O valor das parcelas do Pagamento ao Fornecedor deve ser informado!"
            '    End If
            'End If
            'If CInt(ViewState.Item("id_grupo")) <> 3 Then 'se diferente de transportador 'fran 30/07/2010 i chamado 682

            '    If args.IsValid = True Then
            '        'Busca a somatoria do valor das parcelas  e subtrai peo valor total do item
            '        dspedido = pedido.getCentralPedidoConsSomaValorProdutor
            '        If dspedido.Tables(0).Rows.Count > 0 Then
            '            For Each row In dspedido.Tables(0).Rows
            '                'se o valor total do item do pedido subtraindo a soma do valor da parcelas para o item for diferente de zero
            '                If Convert.ToDecimal(row.Item("valor")) <> 0 Then
            '                    args.IsValid = False
            '                    lmsg = "Para o item " & row.Item("nm_item").ToString & ", o somatório do valor das parcelas do 'Desconto ao Produtor' está diferente do valor total informado no pedido."
            '                    Exit For
            '                End If
            '            Next
            '        Else
            '            args.IsValid = False
            '            lmsg = "O valor das parcelas do Desconto ao Produtor deve ser informado!"
            '        End If
            '    End If
            'End If
            'fran chamado 945 f
            If args.IsValid = True Then
                'Busca se existe data de pagamento repetidas 
                dspedido = pedido.getCentralPedidoConsDataFornecedor
                If dspedido.Tables(0).Rows.Count > 0 Then
                    'se tem linhas, tem datas repetias
                    For Each row In dspedido.Tables(0).Rows
                        args.IsValid = False
                        'lmsg = "As datas de pagamento para o 'Pagamento ao Fornecedor' do item " & row.Item("nm_item").ToString & " não podem ser repetidas." 'fran fase 3 set/2014
                        lmsg = "As datas de pagamento para o 'Pagamento ao Fornecedor' do item " & row.Item("nm_item").ToString & ", nr de nota " & row.Item("nr_nota_fiscal").ToString & " não podem ser repetidas." 'fran fase 3 set/2014
                        Exit For
                    Next
                End If
            End If
            'fran 25/08/2010 i chamado 946 - o pedido de transportador tb terá desconto ao produtor
            'If CInt(ViewState.Item("id_grupo")) <> 3 Then 'fran 30/07/2010 i chamado 682
            'fran 25/08/2010 f chamado 946 - o pedido de transportador tb terá desconto ao produtor

            'fran 10/03/2010 i chamado 686
            'fran fase 3 i 
            'If args.IsValid = True  Then
            If args.IsValid = True Then
                If ViewState.Item("ReabrirPedido") = "N" Then
                    If ViewState.Item("pedidoindireto") = "N" Then

                        'fran fase 3 f
                        'Busca a quantidade de  parcelas informadas em cotação e o count das parcelas informadas para pedido
                        dspedido = pedido.getCentralPedidoConsParcelas
                        If dspedido.Tables(0).Rows.Count > 0 Then
                            Dim lqtde_parcelas As Integer
                            Dim lnr_parcelas As Integer
                            Dim lnr_nota_fiscal As Int64
                            For Each row In dspedido.Tables(0).Rows
                                lqtde_parcelas = row.Item("qtde_parcelas")
                                lnr_parcelas = row.Item("nr_parcelas")
                                lnr_nota_fiscal = row.Item("nr_nota_fiscal")
                                'se parcela informada em cotacao é 0 (a vista) ou 1 parcela (á vista) e a qtde parcelas incluidas no grid for maior que 1
                                If (lnr_parcelas = 0 Or lnr_parcelas = 1) And lqtde_parcelas > 1 Then
                                    args.IsValid = False
                                    lmsg = "Para o item " & row.Item("nm_item").ToString & ", nota fiscal " & row.Item("nr_nota_fiscal").ToString & ", o parcelamento do Desconto ao Produtor deve ser feito em apenas 1 vez, conforme informado na Cotação."
                                    Exit For
                                End If
                                'assume que se veio parcelas = 0 significa que aomenos tem 1 parcela
                                If lnr_parcelas = 0 Then
                                    lnr_parcelas = 1
                                End If
                                'se a atde parcelas incluidas for maior que as parcelas informadas na cotação
                                If lqtde_parcelas > lnr_parcelas Then
                                    args.IsValid = False
                                    lmsg = "Para o item " & row.Item("nm_item").ToString & ", nota fiscal " & row.Item("nr_nota_fiscal").ToString & ", o parcelamento do Desconto ao Produtor deve ser no máximo de " & lnr_parcelas & " parcelas, conforme informado na Cotação."
                                    Exit For
                                End If
                            Next
                        Else

                            args.IsValid = False
                            lmsg = "Parcelas de desconto ao produtor devem ser informadas!"
                        End If
                    End If
                Else

                    'fran 08/2015 i
                    'Busca a quantidade de  parcelas informadas em cotação e o count das parcelas informadas para pedido
                    dspedido = pedido.getCentralPedidoConsParcelasbyItem
                    If dspedido.Tables(0).Rows.Count > 0 Then
                        Dim lqtde_parcelas As Integer
                        Dim lnr_parcelas As Integer
                        For Each row In dspedido.Tables(0).Rows
                            lqtde_parcelas = row.Item("qtde_parcelas")
                            lnr_parcelas = row.Item("nr_parcelas")
                            'se parcela informada em parcelamento é 0 (a vista) ou 1 parcela (á vista) e a qtde parcelas incluidas no grid for maior que 1
                            If (row.Item("st_parcelamento").Equals("N")) And lqtde_parcelas > 1 Then
                                args.IsValid = False
                                lmsg = "Para o item " & row.Item("nm_item").ToString & ", o parcelamento do Desconto ao Produtor deve ser feito em apenas 1 vez, conforme informado no campo Parcelamento. Caso necessário, altere o campo parcelamento e clique em 'Atualizar Parcelamento'."
                                Exit For
                            End If
                        Next
                    Else

                        args.IsValid = False
                        lmsg = "Parcelas de desconto ao produtor devem ser informadas!"
                    End If


                    'fase 3 09/2014 i 
                    'Se esta reabrindo pedido.... Deixa aumentar ou retirar parcelas.... contanto que o valor da nota bata com total
                    'Porém se parcelamento for DANONE, deve respoeitar total de parcelas informada no parametro 
                    dspedido = pedido.getCentralPedidoTotalParcelasByPedido 'Busca da VIEWTOTALPARCELAS o total de parcelas por ITEM
                    If dspedido.Tables(0).Rows.Count > 0 Then
                        For Each row In dspedido.Tables(0).Rows
                            'se o parcelamento do item é DANONE, deve respeitar o limite de parcelas do parametro
                            If row.Item("st_parcelamento").ToString.Equals("D") Then
                                If CInt(row.Item("nr_total_parcela").ToString) > CInt(ViewState.Item("nr_politica_parcelas").ToString) Then
                                    args.IsValid = False
                                    lmsg = "Para o item " & row.Item("nm_item").ToString & ", nota fiscal " & row.Item("nr_nota_fiscal").ToString & ", o parcelamento do Desconto ao Produtor deve ser no máximo de " & ViewState.Item("nr_politica_parcelas").ToString & " parcelas, de acordo com a Política de Parcelas para Danone."
                                    Exit For
                                End If
                            End If
                        Next
                    Else
                        args.IsValid = False
                        lmsg = "Parcelas de desconto ao produtor devem ser informadas!"
                    End If
                    'fase 3 09/2014 f 
                End If
            End If
            'fran 10/03/2010 f
            If args.IsValid = True And ViewState.Item("pedidoindireto") = "N" Then 'fase 3
                'Busca se existe data de pagamento repetidas 
                dspedido = pedido.getCentralPedidoConsDataProdutor
                If dspedido.Tables(0).Rows.Count > 0 Then
                    'se tem linhas, tem datas repetias
                    For Each row In dspedido.Tables(0).Rows
                        args.IsValid = False
                        'lmsg = "As datas de pagamento para o 'Desconto ao Produtor' do item " & row.Item("nm_item").ToString & " não podem ser repetidas." 'fran fase 3 set/2014
                        lmsg = "As datas de pagamento para o 'Desconto ao Produtor' do item " & row.Item("nm_item").ToString & ", nr de nota " & row.Item("nr_nota_fiscal").ToString & " não podem ser repetidas." 'fran fase 3 set/2014
                        Exit For
                    Next
                End If
            End If
            'End If 'fran 25/08/2010 i chamado 946 - o pedido de transportador tb terá desconto ao produtor
            'fran 10/05/2010 i chamado 817
            If args.IsValid = True Then
                'Verifica se há o mesmo nr nota com valores diferentes
                dspedido = pedido.getCentralPedidoConsNotaVlDiferenteFornec
                If dspedido.Tables(0).Rows.Count > 0 Then
                    'se tem linhas, tem notas com valores diferentes
                    For Each row In dspedido.Tables(0).Rows
                        args.IsValid = False
                        'lmsg = String.Concat("Para o item " & row.Item("nm_item").ToString, " a nota de número ", row.Item("nr_nota_fiscal").ToString, " não pode ter o campo 'Vl Nota' com valores diferentes.")
                        lmsg = String.Concat("Para o item " & row.Item("nm_item").ToString, " do Pagamento ao Fornecedor, a nota de número ", row.Item("nr_nota_fiscal").ToString, " não pode ter o campo 'Vl Nota' com valores diferentes.")
                        Exit For
                    Next
                End If
            End If
            If args.IsValid = True Then
                'Verifica se há o mesmo nr nota com valores diferentes
                dspedido = pedido.getCentralPedidoConsNotaSerieEmissaoFornec
                If dspedido.Tables(0).Rows.Count > 0 Then
                    'se tem linhas, tem notas com valores diferentes
                    For Each row In dspedido.Tables(0).Rows
                        If CInt(row.Item("count_serie")) > 1 Then
                            args.IsValid = False
                            lmsg = String.Concat("Para o item " & row.Item("nm_item").ToString, " do Pagamento ao Fornecedor, a nota de número ", row.Item("nr_nota_fiscal").ToString, " não pode ter o campo 'Série' com valores diferentes.")
                            Exit For
                        End If
                        If CInt(row.Item("count_data")) > 1 Then
                            args.IsValid = False
                            lmsg = String.Concat("Para o item " & row.Item("nm_item").ToString, " do Pagamento ao Fornecedor, a nota de número ", row.Item("nr_nota_fiscal").ToString, " não pode ter o campo 'Emissão' com valores diferentes.")
                            Exit For
                        End If
                    Next
                End If
            End If
            If args.IsValid = True Then
                'Verifica se a soma das parcelas para um nr nota é igual ao vl da nota
                dspedido = pedido.getCentralPedidoConsSomaParcComVlNotaFornec
                If dspedido.Tables(0).Rows.Count > 0 Then
                    For Each row In dspedido.Tables(0).Rows
                        If row.Item("valor_nota_fiscal") > 0 Then
                            If row.Item("valor") <> 0 Then 'se tem diferença
                                args.IsValid = False
                                'lmsg = String.Concat("Para o item " & row.Item("nm_item").ToString, " o somatório das parcelas da nota ", row.Item("nr_nota_fiscal").ToString, " está diferente do Valor da Nota Fiscal informado.")
                                lmsg = String.Concat("Para o item " & row.Item("nm_item").ToString, " do Pagamento ao Fornecedor, o somatório das parcelas da nota ", row.Item("nr_nota_fiscal").ToString, " está diferente do Valor da Nota Fiscal informado.")
                                Exit For

                            End If
                        End If
                    Next
                Else
                    'fran -8/2015i
                    'se não tem linhas de fornecedor
                    args.IsValid = False
                    lmsg = String.Concat("Para finalizar o pedido, Pagamento ao Fornecedor deve ser informado!")

                    'fran -8/2015f

                End If
            End If
            'fran 10/05/2010 f chamado 817

            'fran 25/08/2010 i chamado 945
            If args.IsValid = True And ViewState.Item("pedidoindireto") = "N" Then
                'Verifica se há o mesmo nr nota com valores diferentes
                dspedido = pedido.getCentralPedidoConsNotaVlDiferenteProdutor
                If dspedido.Tables(0).Rows.Count > 0 Then
                    'se tem linhas, tem notas com valores diferentes
                    For Each row In dspedido.Tables(0).Rows
                        args.IsValid = False
                        lmsg = String.Concat("Para o item " & row.Item("nm_item").ToString, " do Desconto ao Produtor, a nota de número ", row.Item("nr_nota_fiscal").ToString, " não pode ter o campo 'Vl Nota' com valores diferentes.")
                        Exit For
                    Next
                End If
            End If
            If args.IsValid = True And ViewState.Item("pedidoindireto") = "N" Then
                'Verifica se a soma das parcelas para um nr nota é igual ao vl da nota
                dspedido = pedido.getCentralPedidoConsSomaParcComVlNotaProdutor
                If dspedido.Tables(0).Rows.Count > 0 Then
                    For Each row In dspedido.Tables(0).Rows
                        If row.Item("valor_nota_fiscal") > 0 Then
                            If row.Item("valor") <> 0 Then 'se tem diferença
                                args.IsValid = False
                                lmsg = String.Concat("Para o item " & row.Item("nm_item").ToString, " do Desconto ao Produtor, o somatório das parcelas da nota ", row.Item("nr_nota_fiscal").ToString, " está diferente do Valor da Nota Fiscal informado.")
                                Exit For

                            End If
                        End If
                    Next
                End If
            End If
            'fran 25/08/2010 f chamado 945

            'fran 08/2015 i
            If args.IsValid = True And ViewState.Item("pedidoindireto") = "N" Then 'fase 3
                'Verifica se o nr nota existe nos dois grids fornecedor e produtor 
                dspedido = pedido.getCentralPedidoConsNrNotaFornecProd
                If dspedido.Tables(0).Rows.Count > 0 Then
                    For Each row In dspedido.Tables(0).Rows
                        args.IsValid = False
                        lmsg = String.Concat("Para o item " & row.Item("nm_item").ToString, " os mesmos números de Nota Fiscal devem ser informados para Desconto ao Produtor e Pagamento ao Fornecedor.")
                        Exit For
                    Next
                End If
            End If

            If args.IsValid = True And ViewState.Item("pedidoindireto") = "N" Then 'fase 3
                'Verifica se o valor nota é o mesmo para dois grids fornecedor e produtor 
                dspedido = pedido.getCentralPedidoConsValorNotaFornecProd
                If dspedido.Tables(0).Rows.Count > 0 Then
                    For Each row In dspedido.Tables(0).Rows
                        args.IsValid = False
                        lmsg = String.Concat("Para o item " & row.Item("nm_item").ToString, " o valor da Nota Fiscal " & row.Item("nr_nota_fiscal").ToString, " está divergente entre Desconto ao Produtor e Pagamento ao Fornecedor.")
                        Exit For
                    Next
                End If
            End If

            'fran 08/2015 f


            If Not args.IsValid Then
                messageControl.Alert(lmsg)
            End If


        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try
    End Sub
    Protected Sub lk_email_produtor_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles lk_email_produtor.Click
        Dim lassunto As String
        Dim lcorpo As String
        Dim arqTemp As StreamReader
        Dim lcaminhoservidor As String = System.Configuration.ConfigurationManager.AppSettings("PathReports").ToString()  ' Na Danone os relatórios ficam aonde estãqo as páginas
        'Dim lcaminhoservidor As String = "http://" & System.Configuration.ConfigurationManager.AppSettings("ApplicationServer").ToString()
        Dim propriedade As New Propriedade(Convert.ToInt32(ViewState.Item("id_propriedade").ToString))
        Dim produtor As New Pessoa(Convert.ToInt32(ViewState.Item("id_produtor").ToString))
        Dim fornecedor As New Pessoa(Convert.ToInt32(ViewState.Item("id_fornecedor").ToString))
        Dim lemail_parceiro As String
        Dim ldatahj As Date = DateTime.Parse(Now).ToString("dd/MM/yyyy")

        lemail_parceiro = produtor.ds_email
        If lemail_parceiro.Equals(String.Empty) Then
            If Not produtor.ds_email2 Is Nothing Then
                lemail_parceiro = produtor.ds_email2
            Else
                lemail_parceiro = String.Empty

            End If
        End If
        'lemail_parceiro = "franoliveira@hotmail.com"
        If Not lemail_parceiro.Equals(String.Empty) Then
            lassunto = String.Concat("DANONE - Pedido de Compra ", "Nr ", lbl_id_central_pedido.Text)
            arqTemp = New StreamReader(lcaminhoservidor & "\central_pedido_email_produtor.HTML", Encoding.UTF7)
            lcorpo = ""
            Do While Not arqTemp.EndOfStream
                lcorpo = lcorpo & arqTemp.ReadLine
            Loop

            lcorpo = Replace(lcorpo, "$nm_estabelecimento", ViewState.Item("nm_estabelecimento").ToString)
            lcorpo = Replace(lcorpo, "$dt_hoje", String.Concat(Format(ldatahj, "dd").ToString, " de ", Format(ldatahj, "MMMM").ToString, " de ", Format(ldatahj, "yyyy").ToString & "."))
            lcorpo = Replace(lcorpo, "$id_pedido", ViewState.Item("id_central_pedido").ToString)
            lcorpo = Replace(lcorpo, "$datapedido", lbl_dt_pedido.Text)
            'fran 04/08/2010 i chamado 918
            lcorpo = Replace(lcorpo, "$nm_parceiro", fornecedor.nm_pessoa)
            'fran 04/08/2010 f chamado 918

            'lcorpo = Replace(lcorpo, "$nm_fornecedor", fornecedor.nm_pessoa)
            'lcorpo = Replace(lcorpo, "$ds_fornec_contato", fornecedor.ds_contato)
            'lcorpo = Replace(lcorpo, "$email", fornecedor.ds_email)
            'lcorpo = Replace(lcorpo, "$fone1", fornecedor.ds_telefone_1)
            'lcorpo = Replace(lcorpo, "$fone2", fornecedor.ds_telefone_2)

            lcorpo = Replace(lcorpo, "$nm_produtor", produtor.nm_pessoa)
            lcorpo = Replace(lcorpo, "$cd_produtor", produtor.cd_pessoa)
            lcorpo = Replace(lcorpo, "$nm_propriedade", propriedade.nm_propriedade)
            lcorpo = Replace(lcorpo, "$id_propriedade", propriedade.id_propriedade)
            lcorpo = Replace(lcorpo, "$nr_unid_producao", lbl_up.Text.ToString)
            lcorpo = Replace(lcorpo, "$bairro_produtor", produtor.ds_bairro)
            lcorpo = Replace(lcorpo, "$cidade_produtor", produtor.nm_cidade)
            lcorpo = Replace(lcorpo, "$nm_estado_produtor", produtor.nm_estado)
            If produtor.st_categoria = "F" Then
                lcorpo = Replace(lcorpo, "$cnpjprodutor", produtor.cd_cpf)
            Else
                lcorpo = Replace(lcorpo, "$cnpjprodutor", produtor.cd_cnpj)
            End If
            lcorpo = Replace(lcorpo, "$inscrestadualprodutor", produtor.cd_inscricao_estadual)
            lcorpo = Replace(lcorpo, "$ds_contato", produtor.ds_contato)
            lcorpo = Replace(lcorpo, "$prodfone3", produtor.ds_telefone_1)
            lcorpo = Replace(lcorpo, "$prodfone4", produtor.ds_telefone_2)


            Dim pedido As New Pedido
            pedido.id_central_pedido = Convert.ToInt32(ViewState.Item("id_central_pedido"))
            Dim dsgrid As DataSet = pedido.getCentralPedidoEmailParceiroItens()
            Dim row As DataRow
            Dim ltable As String = String.Empty
            Dim i As Integer = 1
            For Each row In dsgrid.Tables(0).Rows
                ltable = "<tr><td style='width: 20px; height: 17px;'>&nbsp;</td>"
                ltable = ltable & "<td style='width: 27px; font-weight: bold; height: 17px;'>2." & i.ToString & ".</td>"
                ltable = ltable & "<td colspan='6' style='font-weight: bold; height: 17px'>" & row.Item("nm_item").ToString & "</td>"
                ltable = ltable & "</tr>"

                ltable = ltable & "<tr><td style='width: 20px; height: 17px;'>&nbsp;</td><td style='width: 27px; height: 17px;'>&nbsp;</td>"
                ltable = ltable & "<td colspan='2' style=' height: 17px;'>Quantidade:</td>"
                ltable = ltable & "<td colspan='4' style='height: 17px'>" & CInt(row.Item("nr_quantidade")).ToString & " " & row.Item("nm_unidade_medida").ToString & "</td>"
                ltable = ltable & "</tr>"
                ltable = ltable & "<tr><td style='width: 20px; height: 17px;'>&nbsp;</td><td style='width: 27px; height: 17px;'>&nbsp;</td>"
                ltable = ltable & "<td colspan='2' style='height: 17px'>Embalagem:</td>"
                ltable = ltable & "<td colspan='4' style='height: 17px'>" & row.Item("ds_tipo_medida").ToString & "</td>"
                ltable = ltable & "</tr>"
                ltable = ltable & "<tr><td style='width: 20px; height: 17px;'>&nbsp;</td><td style='width: 27px; height: 17px;'>&nbsp;</td>"
                ltable = ltable & "<td colspan='2' style='height: 17px'>Preço Unitário:</td>"
                ltable = ltable & "<td colspan='4' style='height: 17px'>" & FormatCurrency(row.Item("nr_valor_unitario"), 2).ToString & "</td>"
                ltable = ltable & "</tr>"
                ltable = ltable & "<tr><td style='width: 20px; height: 17px;'>&nbsp;</td><td style='width: 27px; height: 17px;'>&nbsp;</td>"
                ltable = ltable & "<td colspan='2' style='height: 17px'>Preço Sacaria:</td>"
                ltable = ltable & "<td colspan='4' style='height: 17px'>" & FormatCurrency(row.Item("nr_sacaria"), 2).ToString & "</td>"
                ltable = ltable & "</tr>"
                ltable = ltable & "<tr><td style='width: 20px; height: 17px;'>&nbsp;</td><td style='width: 27px; height: 17px;'>&nbsp;</td>"
                ltable = ltable & "<td colspan='2' style='height: 17px'>Preço Frete:</td>"
                ltable = ltable & "<td colspan='4' style='height: 17px'>" & FormatCurrency(row.Item("nr_frete"), 2).ToString & "</td>"
                ltable = ltable & "</tr>"
                ltable = ltable & "<tr><td style='width: 20px; height: 17px;'>&nbsp;</td><td style='width: 27px; height: 17px;'>&nbsp;</td>"
                ltable = ltable & "<td colspan='2' style='height: 17px'>Valor Total:</td>"
                ltable = ltable & "<td colspan='4' style='height: 17px'>" & FormatCurrency(row.Item("nr_valor_total"), 2).ToString & "</td>"
                ltable = ltable & "</tr>"
                ltable = ltable & "<tr><td style='width: 20px; height: 15px;'>&nbsp;</td><td style='width: 27px; height: 15px;'>&nbsp;</td><td colspan='2' style='height: 15px'>&nbsp;</td><td colspan='4' style='height: 15px'>&nbsp;</td></tr>"
                ltable = ltable & "<tr><td style='width: 20px; height: 17px'>&nbsp;</td><td style='width: 27px; height: 17px'>&nbsp;</td>"
                ltable = ltable & "<td style='width: 32px; height: 17px; font-weight: bold;'>2." & i.ToString & ".1</td>"
                ltable = ltable & "<td colspan='5' style='height: 17px; font-weight: bold;'>Entregas Programadas</td>"
                ltable = ltable & "</tr>"

                Dim pedidoentrega As New PedidoEntrega
                pedidoentrega.id_central_pedido_item = Convert.ToInt32(row.Item("id_central_pedido_item"))
                Dim dsentrega As DataSet = pedidoentrega.getPedidoEntregaByFilters
                Dim rows As DataRow
                Dim j As Integer = 1
                For Each rows In dsentrega.Tables(0).Rows
                    ltable = ltable & "<tr><td style='width: 20px; height: 17px'>&nbsp;</td><td style='width: 27px; height: 17px'>&nbsp;</td>"
                    ltable = ltable & "<td style='width: 35px; height: 17px'>&nbsp;</td><td style='width: 42px; height: 17px'>2." & i.ToString & ".1." & j.ToString & "</td>"
                    ltable = ltable & "<td colspan='2' style='width: 61px; height: 17px'>Entrega " & j.ToString & ":</td>"
                    ltable = ltable & "<td colspan='2' style='height: 17px'>"
                    ltable = ltable & DateTime.Parse(rows.Item("dt_entrega_prevista").ToString).ToString("dd/MM/yyyy") & " - " & rows.Item("nr_quantidade_prevista").ToString & " " & row.Item("nm_unidade_medida").ToString & "</td>"
                    ltable = ltable & "</tr>"
                    j = j + 1
                Next
                'lcorpo = Replace(lcorpo, "$itens", i.ToString)
                i = i + 1
            Next




            Dim dspagto As DataSet = pedido.getCentralPedidoEmailProdutorPagto
            Dim lpagtoprod As String = String.Empty
            i = 1
            For Each row In dspagto.Tables(0).Rows
                lpagtoprod = lpagtoprod & "<tr><td style='width: 20px;'>&nbsp;</td><td style='width: 27px; height: 17px;'>&nbsp;</td>"
                lpagtoprod = lpagtoprod & "<td style='width: 35px; '>3.1." & i.ToString & "</td>"
                lpagtoprod = lpagtoprod & "<td colspan='2' >Parcela " & i.ToString & ":</td>"
                'fran 9/12/2010 i
                'lpagtoprod = lpagtoprod & "<td colspan='3' >" & row.Item("dt_pagto").ToString & " - Valor " & CStr(FormatCurrency(row.Item("nr_valor_parcela").ToString, 2, , TriState.False)) & "</td>"
                lpagtoprod = lpagtoprod & "<td colspan='3' >Pagto " & row.Item("dt_pagto").ToString & " - Valor " & CStr(FormatCurrency(row.Item("nr_valor_parcela").ToString, 2, , TriState.False)) & "</td>"
                'fran 9/12/2010 f
                lpagtoprod = lpagtoprod & "</tr>"
                i = i + 1
            Next


            lcorpo = Replace(lcorpo, "$dsgriditens", ltable.ToString)
            lcorpo = Replace(lcorpo, "$dspagtoprodutor", lpagtoprod.ToString)
            lcorpo = Replace(lcorpo, "ecxtextosmall", "textosmall")

            Dim notificacao As New Notificacao
            arqTemp.Close()

            'FRAN 08/12/2020 i incluir log 
            Dim usuariolog As New UsuarioLog
            usuariolog.id_usuario = Session("id_login")
            usuariolog.ds_id_session = Session.SessionID.ToString()
            usuariolog.id_tipo_log = 9 'ENVIO EMAIL
            usuariolog.id_menu_item = 97
            usuariolog.id_nr_processo = lbl_id_central_pedido.Text
            usuariolog.nm_nr_processo = lbl_id_central_pedido.Text
            usuariolog.ds_nm_processo = "Pedidos - E-mail Produtor"
            usuariolog.insertUsuarioLog()
            'fran 08/12/2020 f

            'fran 24/08/2010 i chamado 931
            'If notificacao.enviaMensagemEmail(lassunto, lcorpo, "recepcao.de.leite-pocos@danone.com", lemail_parceiro, , MailPriority.High, True) = True Then
            If notificacao.enviaMensagemEmail(lassunto, lcorpo, "central.compras@danone.com", lemail_parceiro, , MailPriority.High, True, , False) = True Then
                'fran 24/08/2010 f chamado 931

                messageControl.Alert("Email enviado ao produtor com sucesso!")
            Else

                messageControl.Alert("Email ao produtor não foi enviado com sucesso!")

            End If
        Else
            messageControl.Alert("O email não pode ser enviado pois não há nenhum email informado no cadastra do Produtor!")
        End If
    End Sub

    Protected Sub cv_datapagto_ServerValidate(ByVal source As Object, ByVal args As System.Web.UI.WebControls.ServerValidateEventArgs)
        Try

            args.IsValid = True
            Dim wc As WebControl = CType(source, WebControl)
            Dim row As GridViewRow = CType(wc.NamingContainer, GridViewRow)
            Dim txt_dt_pagto As RK.TextBox.AjaxOnlyDate.OnlyDateTextBox = CType(row.FindControl("txt_dt_pagto"), RK.TextBox.AjaxOnlyDate.OnlyDateTextBox)

            'se a data de pagamento for menor que a data do pedido menos 1 mes
            If Convert.ToDateTime(txt_dt_pagto.Text) < DateAdd(DateInterval.Month, -1, Convert.ToDateTime(lbl_dt_pedido.Text)) Then
                args.IsValid = False
            Else
                args.IsValid = True
            End If

            If Not args.IsValid Then
                messageControl.Alert("A data de pagamento do Pagamento ao Fornecedor não pode ser anterior à Data de Pedido menos 1 mês.")
            End If
        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub
    Protected Sub cv_datapagtoprod_ServerValidate(ByVal source As Object, ByVal args As System.Web.UI.WebControls.ServerValidateEventArgs)
        Try

            args.IsValid = True
            Dim wc As WebControl = CType(source, WebControl)
            Dim row As GridViewRow = CType(wc.NamingContainer, GridViewRow)
            Dim txt_dt_pagto As RK.TextBox.AjaxOnlyDate.OnlyDateTextBox = CType(row.FindControl("txt_dt_pagto"), RK.TextBox.AjaxOnlyDate.OnlyDateTextBox)

            'se a data de pagamento for menor que a data do pedido menos 1 mes
            If Convert.ToDateTime(txt_dt_pagto.Text) < DateAdd(DateInterval.Month, -1, Convert.ToDateTime(lbl_dt_pedido.Text)) Then
                args.IsValid = False
            Else
                args.IsValid = True
            End If

            If Not args.IsValid Then
                messageControl.Alert("A data de pagamento do Desconto ao Produtor não pode ser anterior à Data de Pedido menos 1 mês.")
            End If
        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try
    End Sub
    Protected Sub btn_adicionar_obs_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btn_adicionar_obs.Click
        ViewState.Item("incluirlinha") = "S"
        Dim obs As New PedidoObservacao
        obs.id_central_pedido = Convert.ToInt32(ViewState.Item("id_central_pedido"))
        obs.id_situacao = 1
        Dim dsobs As DataSet = obs.getPedidoObservacaoByFilters()
        Dim dr As DataRow = dsobs.Tables(0).NewRow()
        dr.Item("dt_criacao") = DateTime.Parse(Now).ToString("dd/MM/yyyy")
        dsobs.Tables(0).Rows.InsertAt(dr, 0)
        ViewState.Item("incluirlinhaobs") = "S"
        gridObs.Visible = True
        gridObs.DataSource = Helper.getDataView(dsobs.Tables(0), "dt_criacao")
        gridObs.EditIndex = 0
        gridObs.DataBind()
        ViewState.Item("incluirlinha") = Nothing

    End Sub
    Protected Sub gridObs_PageIndexChanging(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewPageEventArgs) Handles gridObs.PageIndexChanging
        gridObs.PageIndex = e.NewPageIndex
        loadData()
    End Sub
    Protected Sub gridObs_RowCancelingEdit(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewCancelEditEventArgs) Handles gridObs.RowCancelingEdit
        Try

            gridObs.EditIndex = -1
            ViewState.Item("incluirlinhaobs") = "N"
            ViewState.Item("incluirlinhaobs") = Nothing
            loadGridObservacao()

        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try
    End Sub
    Protected Sub gridObs_RowCommand(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewCommandEventArgs) Handles gridObs.RowCommand
        Select Case e.CommandName.Trim.ToString
            Case "delete"
                deletePedidoObservacao(Convert.ToInt32(e.CommandArgument.ToString()))

        End Select
    End Sub
    Protected Sub gridObs_RowCreated(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewRowEventArgs) Handles gridObs.RowCreated

    End Sub
    Protected Sub gridObs_RowDataBound(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewRowEventArgs) Handles gridObs.RowDataBound
        If e.Row.RowType = DataControlRowType.DataRow AndAlso (e.Row.RowState = (DataControlRowState.Alternate Or DataControlRowState.Edit) OrElse e.Row.RowState = (DataControlRowState.Normal Or DataControlRowState.Edit)) Then
            Try

                Dim dt_criacao As Label = CType(e.Row.FindControl("lbl_dt_criacao"), Label)

                If Not dt_criacao.Text.Equals(String.Empty) Then
                    dt_criacao.Text = DateTime.Parse(dt_criacao.Text).ToString("dd/MM/yyyy")
                Else
                    dt_criacao.Text = String.Empty
                End If

            Catch ex As Exception
                messageControl.Alert(ex.Message)
            End Try
        Else
            If e.Row.RowType = DataControlRowType.DataRow Then
                Dim dt_criacao As Label = CType(e.Row.FindControl("lbl_dt_criacao"), Label)
                If Not dt_criacao.Text.Equals(String.Empty) Then
                    dt_criacao.Text = DateTime.Parse(dt_criacao.Text).ToString("dd/MM/yyyy")
                End If

            End If
        End If

    End Sub
    Protected Sub gridObs_RowDeleting(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewDeleteEventArgs) Handles gridObs.RowDeleting
        e.Cancel = True

    End Sub
    Protected Sub gridObs_RowEditing(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewEditEventArgs) Handles gridObs.RowEditing
        Try
            If ViewState.Item("incluirlinha") = "S" And e.NewEditIndex = 0 Then
                ViewState.Item("incluirlinha") = "S"
                loadGridObservacao()
            Else
                gridObs.EditIndex = e.NewEditIndex
                loadGridObservacao()
            End If
        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try
    End Sub
    Protected Sub gridObs_RowUpdating(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.GridViewUpdateEventArgs) Handles gridObs.RowUpdating
        Dim row As GridViewRow = gridObs.Rows(e.RowIndex)
        Try
            If Page.IsValid Then


                If (Not (row) Is Nothing) Then

                    Dim obs As New PedidoObservacao

                    Dim lbl_id_central_pedido_observacao As Label = CType(row.FindControl("lbl_id_central_pedido_observacao"), Label)

                    Dim txt_ds_observacao As TextBox = CType(row.FindControl("txt_ds_observacao"), TextBox)

                    obs.id_modificador = Session("id_login")
                    obs.id_central_pedido = Convert.ToInt32(ViewState.Item("id_central_pedido"))
                    obs.ds_observacao = txt_ds_observacao.Text

                    ' só deixa atualizar ou inserir se algum campo for diferente do banco
                    If obs.getPedidoObservacaoByFilters.Tables(0).Rows.Count = 0 Then
                        'Se é um novo item
                        If Not ViewState.Item("incluirlinhaobs") Is Nothing Then
                            If ViewState.Item("incluirlinhaobs") = "S" Then
                                obs.insertPedidoCentralObservacao()
                                ViewState.Item("incluirlinhaobs") = Nothing
                            Else
                                obs.id_central_pedido_observacao = Convert.ToInt32(lbl_id_central_pedido_observacao.Text)
                                obs.updatePedidoObservacao()
                            End If
                        Else
                            obs.id_central_pedido_observacao = Convert.ToInt32(lbl_id_central_pedido_observacao.Text)
                            obs.updatePedidoObservacao()
                        End If

                    Else
                        If Not ViewState.Item("incluirlinhaobs") Is Nothing Then
                            If ViewState.Item("incluirlinhaobs") = "S" Then
                                ViewState.Item("incluirlinhaobs") = Nothing
                            End If
                        End If
                    End If


                    gridObs.EditIndex = -1

                    loadGridObservacao()

                End If
            End If
        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try


    End Sub
    Protected Sub btn_incluir_parcelas_fornecedor_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btn_incluir_parcelas_fornecedor.Click
        Try
            If Page.IsValid Then

                Dim pagto As New PedidoPagtoFornecedor
                Dim i As Int32
                Dim nr_maior_parcela_banco As Int32
                Dim lnAuxDiferenca As Decimal
                Dim lnAuxValorParcela As Decimal

                pagto.nr_serie_nota_fiscal = txt_serie_forn.Text
                If ViewState.Item("ReabrirPedido") = "S" Then
                    pagto.nr_nota_fiscal = cbo_nota_fiscal_forn.SelectedItem.Text
                Else
                    pagto.nr_nota_fiscal = txt_nota_fiscal_forn.Text

                End If

                If Not txt_valor_nota_fiscal_forn.Text.ToString.Equals(String.Empty) Then
                    pagto.nr_valor_nota_fiscal = Convert.ToDecimal(txt_valor_nota_fiscal_forn.Text)
                End If
                pagto.id_modificador = Session("id_login")
                pagto.id_central_pedido_item = Convert.ToInt32(ViewState.Item("id_central_pedido_item"))

                pagto.dt_pagto = txt_dt_primeiro_pagto_forn.Text

                pagto.dt_emissao_nota_fiscal = txt_dt_emissao_nota.Text 'fran 11/05/2016

                pagto.nr_valor_parcela = Round(Convert.ToDecimal(txt_valor_nota_fiscal_forn.Text) / Convert.ToInt32(txt_total_parcelas_forn.Text), 2)

                lnAuxValorParcela = pagto.nr_valor_parcela

                lnAuxDiferenca = Convert.ToDecimal(txt_valor_nota_fiscal_forn.Text) - (lnAuxValorParcela * Convert.ToInt32(txt_total_parcelas_forn.Text))

                nr_maior_parcela_banco = pagto.getPagtoFornecedorMaxParcela


                'só deixa atualizar ou inserir se algum campo for diferente do banco
                If pagto.getPedidoPagtoFornecedorByFilters.Tables(0).Rows.Count = 0 Then
                    'Se é um novo item
                    If CInt(txt_total_parcelas_forn.Text) > 1 Then 'se é Parcelado
                        For i = 1 To CInt(txt_total_parcelas_forn.Text)
                            pagto.nr_parcela = i + nr_maior_parcela_banco
                            If i = 1 Then
                                'assue que a primeira parcela vai ter a diferença de centavos do valor
                                pagto.nr_valor_parcela = pagto.nr_valor_parcela + lnAuxDiferenca
                            End If
                            If i > 1 Then
                                pagto.dt_pagto = DateAdd(DateInterval.Month, 1, Convert.ToDateTime(pagto.dt_pagto))
                                pagto.nr_valor_parcela = lnAuxValorParcela
                            End If

                            pagto.insertPedidoCentralPagtoFornecedor()
                        Next
                    Else
                        'fran 08/2015 i 
                        If nr_maior_parcela_banco = 0 Then
                            nr_maior_parcela_banco = 1 'assume que é a primeira parcela
                        End If
                        'fran 08/2015 f 

                        pagto.nr_parcela = i + nr_maior_parcela_banco

                        pagto.insertPedidoCentralPagtoFornecedor()
                    End If

                Else
                    messageControl.Alert("Os dados informados já existem no cadastro de Pagamento ao Fornecedor!")
                End If

                cbo_nota_fiscal_forn.SelectedValue = String.Empty
                txt_nota_fiscal_forn.Text = String.Empty
                txt_serie_forn.Text = String.Empty
                txt_dt_emissao_nota.Text = String.Empty 'fran maio/2016
                txt_valor_nota_fiscal_forn.Text = String.Empty
                txt_total_parcelas_forn.Text = String.Empty
                txt_dt_primeiro_pagto_forn.Text = String.Empty

                loadGridPagtoFornecedor()

                'FRAN 08/12/2020 i incluir log 
                Dim usuariolog As New UsuarioLog
                usuariolog.id_usuario = Session("id_login")
                usuariolog.ds_id_session = Session.SessionID.ToString()
                usuariolog.id_tipo_log = 3 'alteracao
                usuariolog.id_menu_item = 97
                usuariolog.id_nr_processo = lbl_id_central_pedido.Text
                usuariolog.nm_nr_processo = lbl_id_central_pedido.Text

                usuariolog.insertUsuarioLog()
                'fran 08/12/2020 f
            End If

        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try
    End Sub
    Protected Sub cv_datapagtoforn_ServerValidate(ByVal source As Object, ByVal args As System.Web.UI.WebControls.ServerValidateEventArgs) Handles cv_datapagtoforn.ServerValidate
        Try

            args.IsValid = True

            'se a data de pagamento for menor que a data do pedido menos 1 mes
            If Convert.ToDateTime(txt_dt_primeiro_pagto_forn.Text) < DateAdd(DateInterval.Month, -1, Convert.ToDateTime(lbl_dt_pedido.Text)) Then
                args.IsValid = False
            Else
                args.IsValid = True
            End If

            If Not args.IsValid Then
                messageControl.Alert("A data de primeiro pagamento do 'Pagamento ao Fornecedor' não pode ser anterior à Data de Pedido menos 1 mês.")
            End If
        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try
    End Sub
    Protected Sub cv_datapagtoprod_ServerValidate1(ByVal source As Object, ByVal args As System.Web.UI.WebControls.ServerValidateEventArgs) Handles cv_datapagtoprod.ServerValidate
        Try

            args.IsValid = True

            'se a data de pagamento for menor que a data do pedido menos 1 mes
            If Convert.ToDateTime(txt_dt_primeiro_pagto_prod.Text) < DateAdd(DateInterval.Month, -1, Convert.ToDateTime(lbl_dt_pedido.Text)) Then
                args.IsValid = False
            Else
                args.IsValid = True
            End If

            If Not args.IsValid Then
                messageControl.Alert("A data de pagamento do Desconto ao Produtor não pode ser anterior à Data de Pedido menos 1 mês.")
            End If
        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try
    End Sub
    Protected Sub btn_incluir_parcelas_produtor_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btn_incluir_parcelas_produtor.Click
        Try
            If Page.IsValid Then

                Dim pagto As New PedidoDescontoProdutor
                Dim i As Int32
                Dim nr_maior_parcela_banco As Int32
                Dim lnAuxDiferenca As Decimal
                Dim lnAuxValorParcela As Decimal
                Dim liiddescontoprodutor As Int32 = 0
                'fran 10/2018 mais solidos i
                Dim maissolidos As New Poupanca
                Dim dsmaissolidos As DataSet
                Dim lnr_tota_central As Decimal = 0
                Dim ldt_maiorreferenciacompedido As String = String.Empty
                Dim lnr_acumulado_maior_referencia As Decimal = 0
                Dim ldt_referencia_pagto As String
                'Dim lnr_saldo_disponivel_referencia As Decimal = 0
                Dim lnr_maissolidos_valor_premio As Decimal = 0
                Dim lnrmssaldodisponivel As Decimal
                Dim lbatualizarsaldodisponivel As Boolean = False
                'Dim lbmaissolidossaldozero As Boolean = False
                'fran 10/2018 mais solidos f

                If ViewState.Item("ReabrirPedido") = "S" Then
                    pagto.nr_nota_fiscal = cbo_nota_fiscal_prod.SelectedItem.Text
                Else
                    pagto.nr_nota_fiscal = txt_nota_fiscal_prod.Text
                End If

                If Not txt_valor_nota_fiscal_prod.Text.ToString.Equals(String.Empty) Then
                    pagto.nr_valor_nota_fiscal = Convert.ToDecimal(txt_valor_nota_fiscal_prod.Text)
                End If
                pagto.id_modificador = Session("id_login")
                pagto.id_central_pedido_item = Convert.ToInt32(ViewState.Item("id_central_pedido_item"))

                pagto.dt_pagto = txt_dt_primeiro_pagto_prod.Text

                pagto.nr_valor_parcela = Round(Convert.ToDecimal(txt_valor_nota_fiscal_prod.Text) / Convert.ToInt32(txt_total_parcelas_prod.Text), 2)

                lnAuxValorParcela = pagto.nr_valor_parcela

                lnAuxDiferenca = Convert.ToDecimal(txt_valor_nota_fiscal_prod.Text) - (lnAuxValorParcela * Convert.ToInt32(txt_total_parcelas_prod.Text))

                nr_maior_parcela_banco = pagto.getDescontoProdutorMaxParcela

                'fran mais solidos 10/2018 i

                ldt_referencia_pagto = String.Concat("01", Right(pagto.dt_pagto.ToString, 8))

                If chk_utilizarmaissolidos.Checked = True Then
                    'GUARDA OS VALORES DA MAIOR REFERENCIA JA DESCONTADA DO PREMIO,ou seja, que já utilizou os pedidos para abater o mais solidos
                    If CInt(ViewState.Item("id_propriedade_titular")) > 0 Then
                        maissolidos.id_propriedade_titular = ViewState.Item("id_propriedade_titular")
                        maissolidos.id_pessoa = 0
                    Else
                        maissolidos.id_pessoa = Convert.ToInt32(ViewState.Item("id_produtor"))
                        maissolidos.id_propriedade_titular = 0
                    End If
                    maissolidos.id_poupanca_parametro = ViewState.Item("id_poupanca_parametro")
                    '***************************************
                    'Buscar no PREMIO a mior referencia e o valor acumulado da maior referencia que tenha valor de pedido associado  
                    dsmaissolidos = maissolidos.getMaisSolidosMaiorReferenciaComPedido
                    If dsmaissolidos.Tables(0).Rows.Count > 0 Then
                        With dsmaissolidos.Tables(0).Rows(0)
                            lnr_acumulado_maior_referencia = .Item("nr_valor_acumulado")
                            lnr_tota_central = .Item("nr_total_central")
                            ldt_maiorreferenciacompedido = .Item("dt_maior_referencia")
                        End With
                    End If
                End If
                'fran mais solidos 10/2018 2

                'só deixa atualizar ou inserir se algum campo for diferente do banco
                If pagto.getPedidoDescontoProdutorByFilters.Tables(0).Rows.Count = 0 Then
                    'Se é um novo item
                    If CInt(txt_total_parcelas_prod.Text) > 1 Then 'se é Parcelado
                        For i = 1 To CInt(txt_total_parcelas_prod.Text)
                            pagto.nr_parcela = i + nr_maior_parcela_banco
                            If i = 1 Then
                                'assue que a primeira parcela vai ter a diferença de centavos do valor
                                pagto.nr_valor_parcela = pagto.nr_valor_parcela + lnAuxDiferenca
                            End If
                            If i > 1 Then
                                pagto.dt_pagto = DateAdd(DateInterval.Month, 1, Convert.ToDateTime(pagto.dt_pagto))
                                pagto.nr_valor_parcela = lnAuxValorParcela
                                ldt_referencia_pagto = DateAdd(DateInterval.Month, 1, Convert.ToDateTime(ldt_referencia_pagto.ToString)) 'fran 10/2018
                            End If
                            'fran 10/2018 i
                            'pagto.insertPedidoCentralDescontoProdutor()
                            liiddescontoprodutor = pagto.insertPedidoCentralDescontoProdutor

                            'se deve descontar o pedido no programa mais solidos
                            If chk_utilizarmaissolidos.Checked = True Then
                                'busca o valor do premio, e se tiver premio devolve o valor do total da central atualizado
                                lnr_maissolidos_valor_premio = Me.BuscarMaisSolidosValorPremio(ldt_referencia_pagto, pagto.nr_valor_parcela, False, ldt_maiorreferenciacompedido, lnr_acumulado_maior_referencia, lnr_tota_central)

                                'se nao tem saldo para a referencia pagto
                                If lnr_maissolidos_valor_premio = 0 Then
                                    'atualiza o desconto do produtor para nao pode utilizar saldo mais solidos
                                    pagto.st_mais_solidos = "N"
                                    pagto.nr_mais_solidos_valor_utilizado = 0
                                    pagto.id_central_pedido_desconto_produtor = liiddescontoprodutor
                                    pagto.updatePedidoDescontoProdutorMaisSolidos()
                                Else
                                    'se tema saldo, atualiza desconto ao produtor e poupanca premio
                                    pagto.st_mais_solidos = "S"
                                    pagto.nr_mais_solidos_valor_utilizado = lnr_maissolidos_valor_premio
                                    pagto.id_central_pedido_desconto_produtor = liiddescontoprodutor
                                    pagto.updatePedidoDescontoProdutorMaisSolidos()

                                    maissolidos.id_modificador = pagto.id_modificador
                                    maissolidos.dt_referencia = ldt_referencia_pagto.ToString
                                    maissolidos.nr_valor_central = lnr_maissolidos_valor_premio
                                    maissolidos.updateMaisSolidosPremio()

                                    lbatualizarsaldodisponivel = True
                                End If
                            End If
                            'fran 10/2018 f

                        Next
                        If lbatualizarsaldodisponivel = True Then
                            'atualiza saldo disponivel
                            lnrmssaldodisponivel = maissolidos.getMaisSolidosProdutorSaldoDisponivel
                            lbl_ms_valor_disponivel.Text = FormatCurrency(lnrmssaldodisponivel, 2)
                            ViewState.Item("maissolidossaldodisponivel") = lnrmssaldodisponivel

                        End If
                    Else
                        'fran 08/2015 i 
                        If nr_maior_parcela_banco = 0 Then
                            nr_maior_parcela_banco = 1 'assume que é a primeira parcela
                        End If
                        'fran 08/2015 f 
                        pagto.nr_parcela = i + nr_maior_parcela_banco

                        'fran 10/2018 i
                        'pagto.insertPedidoCentralDescontoProdutor()
                        liiddescontoprodutor = pagto.insertPedidoCentralDescontoProdutor

                        'se deve descontar o pedido no programa mais solidos
                        If chk_utilizarmaissolidos.Checked = True Then
                            'busca o valor do premio, e se tiver premio devolve o valor do total da central atualizado
                            lnr_maissolidos_valor_premio = Me.BuscarMaisSolidosValorPremio(ldt_referencia_pagto, pagto.nr_valor_parcela, False, ldt_maiorreferenciacompedido, lnr_acumulado_maior_referencia, lnr_tota_central)

                            'se nao tem saldo para a referencia pagto
                            If lnr_maissolidos_valor_premio = 0 Then
                                'atualiza o desconto do produtor para nao pode utilizar saldo mais solidos
                                pagto.st_mais_solidos = "N"
                                pagto.nr_mais_solidos_valor_utilizado = 0
                                pagto.id_central_pedido_desconto_produtor = liiddescontoprodutor
                                pagto.updatePedidoDescontoProdutorMaisSolidos()
                            Else
                                'se tema saldo, atualiza desconto ao produtor e poupanca premio
                                pagto.st_mais_solidos = "S"
                                pagto.nr_mais_solidos_valor_utilizado = lnr_maissolidos_valor_premio
                                pagto.id_central_pedido_desconto_produtor = liiddescontoprodutor
                                pagto.updatePedidoDescontoProdutorMaisSolidos()

                                maissolidos.id_modificador = pagto.id_modificador
                                maissolidos.dt_referencia = ldt_referencia_pagto.ToString
                                maissolidos.nr_valor_central = lnr_maissolidos_valor_premio
                                maissolidos.updateMaisSolidosPremio()

                                'atualiza saldo disponivel
                                lnrmssaldodisponivel = maissolidos.getMaisSolidosProdutorSaldoDisponivel
                                lbl_ms_valor_disponivel.Text = FormatCurrency(lnrmssaldodisponivel, 2)
                                ViewState.Item("maissolidossaldodisponivel") = lnrmssaldodisponivel

                            End If
                        End If
                        'fran 10/2018 f

                    End If

                Else
                    messageControl.Alert("Os dados informados já existem no cadastro de Desconto ao Produtor!")
                End If

                loadGridDescontoProdutor()
            End If
        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub
    Protected Sub cbo_nr_nota_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs)
        Try
            Dim wc As WebControl = CType(sender, WebControl)
            Dim row As GridViewRow = CType(wc.NamingContainer, GridViewRow)

            Dim lsaux As String
            Dim lpos As Integer

            Dim cbo_nr_nota As DropDownList = CType(row.FindControl("cbo_nr_nota"), DropDownList)
            Dim txt_nr_valor_nota_fiscal As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_valor_nota_fiscal"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)

            'txt_nr_valor_nota_fiscal.Text = FormatNumber(CDec(cbo_nr_nota.SelectedValue), 2, , , TriState.True)
            'txt_nr_valor_nota_fiscal.Text = CDec(cbo_nr_nota.SelectedValue) 'atribui o valor da nota
            If Not cbo_nr_nota.SelectedValue.Equals(String.Empty) Then 'se selecionou alguma nota
                lsaux = cbo_nr_nota.SelectedValue.ToString.Trim
                lsaux = Replace(lsaux, ".", ",")
                lsaux = Replace(lsaux, " ", "")
                lpos = InStr(1, lsaux, "*")
                If lpos > 0 Then
                    If lpos = 1 Then ' se encontrou * na 1a posição não valor
                        txt_nr_valor_nota_fiscal.Text = String.Empty
                    Else 'se encontrou * 
                        txt_nr_valor_nota_fiscal.Text = FormatNumber(CDec(Mid(lsaux, 1, lpos - 1).ToString), 2, , , TriState.True)
                    End If

                Else
                    txt_nr_valor_nota_fiscal.Text = String.Empty
                End If

            Else
                txt_nr_valor_nota_fiscal.Text = String.Empty
            End If
            txt_nr_valor_nota_fiscal.Enabled = False

        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try
    End Sub
    Protected Sub cbo_nr_nota_SelectedIndexChanged1(ByVal sender As Object, ByVal e As System.EventArgs)
        Try
            Dim wc As WebControl = CType(sender, WebControl)
            Dim row As GridViewRow = CType(wc.NamingContainer, GridViewRow)
            Dim lsaux As String
            Dim lpos As Integer
            Dim lposdata As Integer


            Dim cbo_nr_nota As DropDownList = CType(row.FindControl("cbo_nr_nota"), DropDownList)
            Dim txt_nr_valor_nota_fiscal As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_valor_nota_fiscal"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
            Dim txt_dt_emissao As RK.TextBox.AjaxOnlyDate.OnlyDateTextBox = CType(row.FindControl("txt_dt_emissao"), RK.TextBox.AjaxOnlyDate.OnlyDateTextBox)
            Dim txt_nr_serie As Anthem.TextBox = CType(row.FindControl("txt_nr_serie"), Anthem.TextBox)
            Dim lbl_id_central_pedido_pagto_fornecedor As Label = CType(row.FindControl("lbl_id_central_pedido_pagto_fornecedor"), Label)

            Try
                If Not cbo_nr_nota.SelectedValue.Equals(String.Empty) Then 'se selecionou alguma nota
                    lsaux = cbo_nr_nota.SelectedValue.ToString.Trim
                    lsaux = Replace(lsaux, ".", ",")
                    lsaux = Replace(lsaux, " ", "")
                    lpos = InStr(1, lsaux, "*")
                    lposdata = InStr(lpos + 1, lsaux, "*")
                    If lpos > 0 Then
                        If lpos = 1 Then ' se encontrou * na 1a posição não tem serie
                            txt_nr_serie.Text = String.Empty
                        Else 'se encontrou * 
                            txt_nr_serie.Text = Mid(lsaux, 1, lpos - 1)
                        End If

                        'se na promeira posição apos * tiver outro * ou vazio, nao tem valor de nota
                        If Mid(lsaux, lpos + 1, 1).ToString.Equals("*") OrElse Mid(lsaux, lpos + 1, 1).ToString.Equals(String.Empty) Then
                            txt_nr_valor_nota_fiscal.Text = String.Empty
                        Else
                            txt_nr_valor_nota_fiscal.Text = FormatNumber(Convert.ToDecimal(Mid(lsaux, lpos + 1, lposdata - lpos - 1).ToString), 2, , , TriState.True)
                        End If
                        'se na primeira posição apos * for vazio nao tem data emissao
                        If Mid(lsaux, lposdata + 1, 1).ToString.Equals("*") OrElse Mid(lsaux, lposdata + 1, 1).ToString.Equals(String.Empty) Then
                            txt_dt_emissao.Text = String.Empty
                        Else
                            txt_dt_emissao.Text = DateTime.Parse(Mid(lsaux, lposdata + 1)).ToString("dd/MM/yyyy")
                        End If
                    Else
                        txt_nr_serie.Text = String.Empty
                        txt_nr_valor_nota_fiscal.Text = String.Empty
                        txt_dt_emissao.Text = String.Empty
                    End If

                Else
                    txt_nr_valor_nota_fiscal.Text = String.Empty
                    txt_nr_serie.Text = String.Empty
                    txt_dt_emissao.Text = String.Empty

                End If
                txt_nr_valor_nota_fiscal.Enabled = False
                txt_nr_serie.Enabled = False
                txt_dt_emissao.Enabled = False


            Catch ex As Exception
                messageControl.Alert(ex.Message)

            End Try

        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try
    End Sub

    Protected Sub cbo_nota_fiscal_prod_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles cbo_nota_fiscal_prod.SelectedIndexChanged
        Try

            Dim lsaux As String
            Dim lpos As Integer

            If Not cbo_nota_fiscal_prod.SelectedValue.Equals(String.Empty) Then 'se selecionou alguma nota
                lsaux = cbo_nota_fiscal_prod.SelectedValue.ToString.Trim
                lsaux = Replace(lsaux, ".", ",")
                lsaux = Replace(lsaux, " ", "")
                lpos = InStr(1, lsaux, "*")
                If lpos > 0 Then
                    If lpos = 1 Then ' se encontrou * na 1a posição não tem valor
                        txt_valor_nota_fiscal_prod.Text = String.Empty
                    Else 'se encontrou * 
                        txt_valor_nota_fiscal_prod.Text = FormatNumber(Convert.ToDecimal(Mid(lsaux, 1, lpos - 1).ToString), 2, , , TriState.True)
                    End If
                Else
                    txt_valor_nota_fiscal_prod.Text = String.Empty
                End If
                'txt_valor_nota_fiscal_prod.Text = FormatNumber(Convert.ToDecimal(cbo_nota_fiscal_prod.SelectedValue.ToString), 2, , , TriState.True)
            Else
                txt_valor_nota_fiscal_prod.Text = String.Empty

            End If

        Catch ex As Exception
            messageControl.Alert(ex.Message)

        End Try
    End Sub

    Protected Sub cbo_nota_fiscal_forn_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles cbo_nota_fiscal_forn.SelectedIndexChanged
        Try
            Dim lsaux As String
            Dim lpos As Integer
            Dim lposdata As Integer

            If Not cbo_nota_fiscal_forn.SelectedValue.Equals(String.Empty) Then 'se selecionou alguma nota
                lsaux = cbo_nota_fiscal_forn.SelectedValue.ToString.Trim
                lsaux = Replace(lsaux, ".", ",")
                lsaux = Replace(lsaux, " ", "")
                lpos = InStr(1, lsaux, "*")
                lposdata = InStr(lpos + 1, lsaux, "*")

                If lpos > 0 Then
                    If lpos = 1 Then ' se encontrou * na 1a posição não tem serie
                        txt_serie_forn.Text = String.Empty
                    Else 'se encontrou * 
                        txt_serie_forn.Text = Mid(lsaux, 1, lpos - 1)
                    End If

                    'If Not Mid(lsaux, lpos + 1).ToString.Equals(String.Empty) Then
                    'se na promeira posição apos * tiver outro * ou vazio, nao tem valor de nota
                    If Mid(lsaux, lpos + 1, 1).ToString.Equals("*") OrElse Mid(lsaux, lpos + 1, 1).ToString.Equals(String.Empty) Then

                        txt_valor_nota_fiscal_forn.Text = String.Empty
                    Else
                        'txt_valor_nota_fiscal_forn.Text = FormatNumber(Convert.ToDecimal(Mid(lsaux, lpos + 1).ToString), 2, , , TriState.True)
                        txt_valor_nota_fiscal_forn.Text = FormatNumber(Convert.ToDecimal(Mid(lsaux, lpos + 1, lposdata - lpos - 1).ToString), 2, , , TriState.True)
                    End If

                    'se na primeira posição apos * for vazio nao tem data emissao
                    If Mid(lsaux, lposdata + 1, 1).ToString.Equals("*") OrElse Mid(lsaux, lposdata + 1, 1).ToString.Equals(String.Empty) Then
                        txt_dt_emissao_nota.Text = String.Empty
                    Else
                        txt_dt_emissao_nota.Text = DateTime.Parse(Mid(lsaux, lposdata + 1)).ToString("dd/MM/yyyy")
                    End If

                Else
                    txt_serie_forn.Text = String.Empty
                    txt_valor_nota_fiscal_forn.Text = String.Empty
                    txt_dt_emissao_nota.Text = String.Empty

                End If

            Else
                txt_valor_nota_fiscal_forn.Text = String.Empty
                txt_serie_forn.Text = String.Empty
                txt_dt_emissao_nota.Text = String.Empty

            End If
        Catch ex As Exception
            messageControl.Alert(ex.Message)

        End Try

    End Sub

 
    Protected Sub cv_parcelamento_ServerValidate(ByVal source As Object, ByVal args As System.Web.UI.WebControls.ServerValidateEventArgs) Handles cv_parcelamento.ServerValidate
        Try
            Dim lmsg As String
            Dim pedido As New Pedido
            Dim dspedido As DataSet

            args.IsValid = True
            pedido.id_central_pedido = Convert.ToInt32(ViewState.Item("id_central_pedido"))
            pedido.id_central_pedido_item = Convert.ToInt32(ViewState.Item("id_central_pedido_item"))

            If cbo_parcelamento.SelectedValue.Equals("N") Then
                'Se parcelamento do banco é DANONE OU PARCEIRO deve verificar a qtde de parcelas já inclusas. 
                'Se existir apenas 1, nao deixa mais incluir e atualiza para N
                'Se existir mmais que 1 parcela, exibe mensagem avisando que nao pode atualizar para a vista 
                If Not ViewState.Item("st_parcelamento").ToString.Equals("N") Then
                    dspedido = pedido.getCentralPedidoConsParcelasbyItem
                    If dspedido.Tables(0).Rows.Count > 0 Then
                        Dim lqtde_parcelas As Integer
                        Dim lnr_parcelas As Integer
                        With dspedido.Tables(0).Rows(0)
                            lqtde_parcelas = .Item("qtde_parcelas")
                            lnr_parcelas = .Item("nr_parcelas")
                            'se a atde parcelas já existentes é maior que 1, 
                            If lqtde_parcelas > 1 Then
                                args.IsValid = False
                                lmsg = "Para o item " & .Item("nm_item").ToString & ", o tipo de parcelamento não poderá ser atualizado para não parcelado. Mais de uma parcela estão cadastradas em Desconto ao Produtor."
                            Else
                                'se quatde de parcelas ja cadastradas no desconto produtor for 1 apenas ataulizar 
                            End If
                        End With

                    End If
                End If
            End If


            If Not args.IsValid Then
                messageControl.Alert(lmsg)
            End If


        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try
    End Sub

    Protected Sub btn_atualizar_parcelamento_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles btn_atualizar_parcelamento.Click
        Try
            If Page.IsValid Then

                Dim pedidoitem As New PedidoItem

                pedidoitem.st_parcelamento = cbo_parcelamento.SelectedValue.ToString
                pedidoitem.id_central_pedido_item = Convert.ToInt32(ViewState.Item("id_central_pedido_item"))

                pedidoitem.updatePedidoItemParcelamento()
                'FRAN 08/12/2020 i incluir log 
                Dim usuariolog As New UsuarioLog
                usuariolog.id_usuario = Session("id_login")
                usuariolog.ds_id_session = Session.SessionID.ToString()
                usuariolog.id_tipo_log = 3 'alteracao
                usuariolog.id_menu_item = 97
                usuariolog.id_nr_processo = lbl_id_central_pedido.Text
                usuariolog.nm_nr_processo = lbl_id_central_pedido.Text

                usuariolog.insertUsuarioLog()
                'fran 08/12/2020 f



                loadGridItens()
                ViewState.Item("st_parcelamento") = pedidoitem.st_parcelamento.ToString


            End If
        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub

    Protected Sub cv_dataemissao_ServerValidate(ByVal source As Object, ByVal args As System.Web.UI.WebControls.ServerValidateEventArgs)
        Try

            args.IsValid = True
            Dim wc As WebControl = CType(source, WebControl)
            Dim row As GridViewRow = CType(wc.NamingContainer, GridViewRow)
            Dim txt_dt_emissao As RK.TextBox.AjaxOnlyDate.OnlyDateTextBox = CType(row.FindControl("txt_dt_emissao"), RK.TextBox.AjaxOnlyDate.OnlyDateTextBox)
            Dim lmsg As String
            'se a data de emissao for menor que a data do pedido menos 1 mes
            If Convert.ToDateTime(txt_dt_emissao.Text) < DateAdd(DateInterval.Month, -1, Convert.ToDateTime(lbl_dt_pedido.Text)) Then
                lmsg = "A data de pagamento do Pagamento ao Fornecedor não pode ser anterior à Data de Pedido menos 1 mês."
                args.IsValid = False
            Else
                args.IsValid = True
            End If



            If Not args.IsValid Then
                messageControl.Alert(lmsg)
            End If
        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try
    End Sub

    Protected Sub cv_emissao_nota_ServerValidate(ByVal source As Object, ByVal args As System.Web.UI.WebControls.ServerValidateEventArgs) Handles cv_emissao_nota.ServerValidate
        Try

            args.IsValid = True

            'se a data de pagamento for menor que a data do pedido menos 1 mes
            If Convert.ToDateTime(txt_dt_emissao_nota.Text) < DateAdd(DateInterval.Month, -1, Convert.ToDateTime(lbl_dt_pedido.Text)) Then
                args.IsValid = False
            Else
                args.IsValid = True
            End If

            If Not args.IsValid Then
                messageControl.Alert("A data de emissão da nota fiscal do 'Pagamento ao Fornecedor' não pode ser anterior à Data de Pedido menos 1 mês.")
            End If
        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try
    End Sub
    Private Function BuscarMaisSolidosValorPremio(ByVal pdt_referencia_pagto As String, ByVal pnr_valor_parcela_pagto As Decimal, ByVal pbBuscarMaiorReferencia As Boolean, Optional ByVal pdtMaiorReferencia As String = "", Optional ByVal pnrAcumuladoMaiorReferencia As Decimal = 0, Optional ByRef pnr_valor_central As Decimal = 0, Optional ByRef pnrSaldoDisponivelReferencia As Decimal = 0) As Decimal

        Try

            'fran 10/2018 mais solidos i
            Dim maissolidos As New Poupanca
            Dim dsmaissolidos As DataSet
            Dim lnr_tota_central As Decimal = 0
            Dim ldt_maiorreferenciacompedido As String = String.Empty
            Dim lnr_acumulado_maior_referencia As Decimal = 0
            Dim lnr_saldo_disponivel_referencia As Decimal = 0
            Dim lnr_maissolidos_valor_premio As Decimal = 0
            Dim lbmaissolidossaldozero As Boolean = False
            'fran 10/2018 mais solidos f

            '*********************************************************************************
            'BUSCAR MAIOR REFERENCIA JA UTIÇLIZADA NO RESGATE MAIS SOLIDOS
            '**********************************************************************************
            If CInt(ViewState.Item("id_propriedade_titular")) > 0 Then
                maissolidos.id_propriedade_titular = ViewState.Item("id_propriedade_titular")
                maissolidos.id_pessoa = 0
            Else
                maissolidos.id_pessoa = Convert.ToInt32(ViewState.Item("id_produtor"))
                maissolidos.id_propriedade_titular = 0
            End If
            maissolidos.id_poupanca_parametro = ViewState.Item("id_poupanca_parametro")

            'se n ao foi passado o parametro da maior referencia do mais solidos, então busca
            If pbBuscarMaiorReferencia = True Then
                'GUARDA OS VALORES DA MAIOR REFERENCIA JA DESCONTADA DO PREMIO,ou seja, que já utilizou os pedidos para abater o mais solidos
                'Buscar no PREMIO a mior referencia e o valor acumulado da maior referencia que tenha valor de pedido associado  
                dsmaissolidos = maissolidos.getMaisSolidosMaiorReferenciaComPedido
                If dsmaissolidos.Tables(0).Rows.Count > 0 Then
                    With dsmaissolidos.Tables(0).Rows(0)
                        lnr_acumulado_maior_referencia = .Item("nr_valor_acumulado")
                        lnr_tota_central = .Item("nr_total_central")
                        ldt_maiorreferenciacompedido = .Item("dt_maior_referencia")
                    End With
                End If
            Else
                'se foi passado como parametro, ja fez a busca emoutra rotina, assume o que veio do parametro
                lnr_acumulado_maior_referencia = pnrAcumuladoMaiorReferencia
                lnr_tota_central = pnr_valor_central
                ldt_maiorreferenciacompedido = pdtMaiorReferencia
            End If
            '***************************************************************
            'PEGA O SALDO DISPONIVEL DA REFERENCIA
            '**************************************************************
            'busca o saldo ainda disponivel na referencia do pagamento (valor acumulado na referencia subtraindo o total gasto na central ate a referenmcia e subtraindo depois o valor_excedido do mes posterior (para o caso de no mes posterior ter utilizado o saldo da ref atual) 
            maissolidos.dt_referencia = pdt_referencia_pagto.ToString
            lnr_saldo_disponivel_referencia = maissolidos.getMaisSolidosSaldoDisponivelReferencia


            '***********************************************************
            'BUSCAR O VALOR DO PREMIO 
            '**********************************************************
            'se tem maior referencia com pediddo e REF PAGTO DO DESCONTO for menor que a MAIOR REFERENCIA (significa que deve verificadar o saldo anterior para verificar se ainda tem desconto)
            If Not ldt_maiorreferenciacompedido.ToString.Equals(String.Empty) AndAlso CDate(pdt_referencia_pagto) < CDate(ldt_maiorreferenciacompedido) Then
                'se ainda tem saldo para os meses anteriores ao ultimo pedido que utilizou mais solidos
                If lnr_acumulado_maior_referencia - lnr_tota_central > 0 Then
                    'se o saldo sdisponivel na referencia tambem é maior que zero
                    If lnr_saldo_disponivel_referencia > 0 Then
                        'se o saldo disponivel na referencia de pagto for maior que o saldo disponivel para a maior referencia utilizada, nao posso utilizar como base o valor do saldo da referencia devo utilizar o valor do saldo do programa
                        If lnr_saldo_disponivel_referencia > (lnr_acumulado_maior_referencia - lnr_tota_central) Then
                            'se o valor da parcela do desconto ao produtor for menor ou igual ao saldo disponivel da maior referencia
                            If pnr_valor_parcela_pagto <= (lnr_acumulado_maior_referencia - lnr_tota_central) Then
                                'o valor do premio a ser utilizado será o valor da parcela 
                                lnr_maissolidos_valor_premio = pnr_valor_parcela_pagto
                            Else
                                'o valor do premio a ser utilizado será o valor do saldo da referencia 
                                lnr_maissolidos_valor_premio = (lnr_acumulado_maior_referencia - lnr_tota_central)
                            End If
                            'retorna que o saldo disponivel da referencia
                            pnrSaldoDisponivelReferencia = (lnr_acumulado_maior_referencia - lnr_tota_central)
                        Else 'se saldo da referencia é menor ou igual ao saldo da maior referencia, pode utilizar como base o saldo da propria referencia
                            'se o valor da parcela do desconto ao produtor for menor ou igual ao saldo disponivel na referencia
                            If pnr_valor_parcela_pagto <= lnr_saldo_disponivel_referencia Then
                                'o valor do premio a ser utilizado será o valor da parcela 
                                lnr_maissolidos_valor_premio = pnr_valor_parcela_pagto
                            Else
                                'o valor do premio a ser utilizado será o valor do saldo da referencia 
                                lnr_maissolidos_valor_premio = lnr_saldo_disponivel_referencia
                            End If
                            'retorna que o saldo disponivel da referencia
                            pnrSaldoDisponivelReferencia = lnr_saldo_disponivel_referencia

                        End If
                        'atualiza o valor total da central da referencia maior para nao precisar refazer busca no banco
                        lnr_tota_central = lnr_tota_central + lnr_maissolidos_valor_premio
                    Else
                        'saldo zero
                        lbmaissolidossaldozero = True
                    End If

                Else 'se o saldo da maior referencia utilizada é 0... nao pode mais haver descontos nos meses anteriores à maior referencia
                    'atualiza o desconto do produtor para nao pode utilizar saldo mais solidos
                    lbmaissolidossaldozero = True
                End If
            Else 'se nao utilizou referencias para frente 
                'se tem saldo sdisponivel na referencia
                If lnr_saldo_disponivel_referencia > 0 Then
                    'se o valor da parcela do desconto ao produtor for menor ou igual ao saldo disponivel na referencia
                    If pnr_valor_parcela_pagto <= lnr_saldo_disponivel_referencia Then
                        'o valor do premio a ser utilizado será o valor da parcela 
                        lnr_maissolidos_valor_premio = pnr_valor_parcela_pagto
                    Else
                        'o valor do premio a ser utilizado será o valor do saldo da referencia 
                        lnr_maissolidos_valor_premio = lnr_saldo_disponivel_referencia
                    End If
                    'retorna que o saldo disponivel da referencia
                    pnrSaldoDisponivelReferencia = lnr_saldo_disponivel_referencia

                Else
                    'saldo zero
                    lbmaissolidossaldozero = True
                End If
            End If

            If lbmaissolidossaldozero = True Then
                pnrSaldoDisponivelReferencia = 0
                lnr_maissolidos_valor_premio = 0
            End If

            'RETORNA O TOTAL DA CENTRAL
            pnr_valor_central = lnr_tota_central
            'RETORNA O VALOR DO PREMIO, se for saldo zero, retorna 0
            BuscarMaisSolidosValorPremio = lnr_maissolidos_valor_premio



        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try


    End Function

    Protected Sub chk_compras_evento_CheckedChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles chk_compras_evento.CheckedChanged
        Try

            Dim pedido As New Pedido

            pedido.id_modificador = Session("id_login")
            pedido.id_central_pedido = Convert.ToInt32(ViewState.Item("id_central_pedido"))
            If chk_compras_evento.Checked = True Then
                pedido.st_evento_compras = "S"
            Else
                pedido.st_evento_compras = "N"
            End If

            pedido.updateCentralPedidoEventoCompras()



        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub
End Class