Imports Danone.MilkSystem.Business
Imports System.Data
Imports System.Math
Imports System.Net.Mail
Imports System.IO

Partial Class frm_central_pedido_abertura_grupo
    Inherits Page

    Private customPage As RK.PageTools.CustomPage


    Private Sub incluirPropriedade(ByVal pindexrow As Integer)

        Dim dstable As New DataTable
        Dim ilinha As Integer
        Dim rowselected As GridViewRow = Me.gridPropriedades.SelectedRow
        Dim lbl_id_propriedade As Label = CType(rowselected.FindControl("lbl_id_propriedade"), Label)
        Dim lbl_id_propriedade_matriz As Label = CType(rowselected.FindControl("lbl_id_propriedade_matriz"), Label)
        Dim lbl_id_produtor As Label = CType(rowselected.FindControl("lbl_id_produtor"), Label)
        Dim lbl_nr_valor_disponivel As Label = CType(rowselected.FindControl("lbl_nr_valor_disponivel"), Label)
        Dim lbl_id_estado As Label = CType(rowselected.FindControl("lbl_id_estado"), Label)
        Dim lbl_id_cidade As Label = CType(rowselected.FindControl("lbl_id_cidade"), Label)
        Dim lbl_nm_produtor As DataControlFieldCell = CType(rowselected.Cells(2), DataControlFieldCell)

        Try
            dstable.Columns.Add("lbl_descricao")
            dstable.Columns.Add("nr_valor_limite")
            dstable.Columns.Add("ds_cidade")
            dstable.Columns.Add("ds_tipo_medida")
            dstable.Columns.Add("nr_qtde")
            dstable.Columns.Add("st_parcelamento")
            dstable.Columns.Add("nr_parcelas")
            dstable.Columns.Add("id_transportador")
            dstable.Columns.Add("nr_frete")
            dstable.Columns.Add("nm_veiculo_central_compras")
            dstable.Columns.Add("nr_valor_total_item")
            dstable.Columns.Add("nr_valor_total_frete")
            dstable.Columns.Add("nr_valor_total")
            dstable.Columns.Add("id_central_tabela_frete_veiculos")
            dstable.Columns.Add("id_veiculo_central_compras")
            dstable.Columns.Add("inf_frete")
            dstable.Columns.Add("dt_cotacao_frete")
            dstable.Columns.Add("id_cidade_destino")
            dstable.Columns.Add("id_estado_destino")
            dstable.Columns.Add("id_propriedade")
            dstable.Columns.Add("id_propriedade_matriz")
            dstable.Columns.Add("id_produtor")
            dstable.Columns.Add("dt_fim_contrato")

            If (Me.ViewState("gridLinhasAdicionadas") IsNot Nothing) Then
                Me.ViewState("incluirlinha") = "S"

                Dim row As GridViewRow
                Dim lvaloritem As Decimal = 0
                Dim lvalorfrete As Decimal = 0

                ilinha = 0
                For Each row In gridResults.Rows
                    If row.Visible = True Then
                        Dim lbl_descricao As Label = CType(row.FindControl("lbl_descricao"), Label)
                        Dim lbl_limite As Anthem.Label = CType(row.FindControl("lbl_limite"), Anthem.Label)
                        Dim lbl_cidade As Anthem.Label = CType(row.FindControl("lbl_cidade"), Anthem.Label)
                        Dim cbo_tipo_medida As Anthem.DropDownList = CType(row.FindControl("cbo_tipo_medida"), Anthem.DropDownList)
                        Dim ds_tipo_medida As Anthem.Label = CType(row.FindControl("ds_tipo_medida"), Anthem.Label)
                        Dim txt_nr_qtde As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_qtde"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
                        Dim lbl_total_item As Anthem.Label = CType(row.FindControl("lbl_total_item"), Anthem.Label)
                        Dim cbo_vai_parcelar As Anthem.DropDownList = CType(row.FindControl("cbo_vai_parcelar"), Anthem.DropDownList)
                        Dim txt_nr_parcelas As RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox = CType(row.FindControl("txt_nr_parcelas"), RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox)
                        Dim lbl_st_parcelamento As Anthem.Label = CType(row.FindControl("st_parcelamento"), Anthem.Label)
                        Dim cbo_transportador As Anthem.DropDownList = CType(row.FindControl("cbo_transportador"), Anthem.DropDownList)
                        Dim id_transportador As Anthem.Label = CType(row.FindControl("id_transportador"), Anthem.Label)
                        Dim lbl_tipo_caminhao As Anthem.Label = CType(row.FindControl("lbl_tipo_caminhao"), Anthem.Label)
                        Dim txt_nr_frete As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_frete"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
                        Dim lbl_total_frete As Anthem.Label = CType(row.FindControl("lbl_total_frete"), Anthem.Label)
                        Dim lbl_valor_total As Anthem.Label = CType(row.FindControl("lbl_valor_total"), Anthem.Label)
                        Dim lbl_id_central_tabela_frete_veiculos As Label = CType(row.FindControl("lbl_id_central_tabela_frete_veiculos"), Label)
                        Dim lbl_id_veiculo_central_compras As Label = CType(row.FindControl("lbl_id_veiculo_central_compras"), Label)
                        Dim lbl_inf_frete As Anthem.Label = CType(row.FindControl("lbl_inf_frete"), Anthem.Label)
                        Dim lbl_dt_cotacao_frete As Anthem.Label = CType(row.FindControl("lbl_dt_cotacao_frete"), Anthem.Label)
                        Dim lbl_id_cidade_destino As Label = CType(row.FindControl("lbl_id_cidade_destino"), Label)
                        Dim lbl_id_estado_destino As Label = CType(row.FindControl("lbl_id_estado_destino"), Label)
                        Dim lbl_id_propriedade_grid As Label = CType(row.FindControl("lbl_id_propriedade_grid"), Label)
                        Dim lbl_id_propriedade_matriz_grid As Label = CType(row.FindControl("lbl_id_propriedade_matriz_grid"), Label)
                        Dim lbl_id_produtor_grid As Label = CType(row.FindControl("lbl_id_produtor_grid"), Label)
                        Dim lbl_dt_fim_contrato_produtor As Label = CType(row.FindControl("lbl_dt_fim_contrato"), Label)

                        dstable.Rows.InsertAt(dstable.NewRow(), ilinha)

                        lvaloritem = 0
                        lvalorfrete = 0
                        With dstable.Rows.Item(ilinha)

                            .Item(0) = lbl_descricao.Text
                            .Item(1) = lbl_limite.Text
                            .Item(2) = lbl_cidade.Text
                            .Item(3) = cbo_tipo_medida.SelectedValue
                            .Item(4) = txt_nr_qtde.Text
                            .Item(5) = cbo_vai_parcelar.SelectedValue
                            .Item(6) = txt_nr_parcelas.Text

                            If IsNumeric(txt_nr_qtde.Text) AndAlso IsNumeric(txt_nr_valor_unitario.Text) Then
                                If cbo_tipo_medida.SelectedValue.Equals("S") AndAlso IsNumeric(txt_nr_sacaria.Text) Then
                                    lvaloritem = (CDec(txt_nr_valor_unitario.Text) + CDec(txt_nr_sacaria.Text)) * CDec(txt_nr_qtde.Text)
                                Else
                                    lvaloritem = CDec(txt_nr_valor_unitario.Text) * CDec(txt_nr_qtde.Text)
                                End If
                                .Item(10) = lvaloritem.ToString
                            Else
                                .Item(10) = "0"
                            End If

                            'se tipo de frete é fob d
                            If cbo_tipo_frete.SelectedValue = "D" Then
                                .Item(7) = cbo_transportador.SelectedValue
                                .Item(8) = txt_nr_frete.Text
                                .Item(9) = lbl_tipo_caminhao.Text

                                If IsNumeric(txt_nr_qtde.Text) AndAlso IsNumeric(txt_nr_frete.Text) Then
                                    lvalorfrete = CDec(txt_nr_frete.Text) * CDec(txt_nr_qtde.Text)
                                    .Item(11) = lvalorfrete.ToString
                                Else
                                    .Item(11) = "0"
                                End If
                                .Item(13) = lbl_id_central_tabela_frete_veiculos.Text
                                .Item(14) = lbl_id_veiculo_central_compras.Text
                                .Item(15) = lbl_inf_frete.Text
                                '.Item(16) = lbl_dt_cotacao_frete.Text
                                .Item(16) = String.Empty
                            Else
                                .Item(7) = String.Empty
                                .Item(8) = String.Empty
                                .Item(9) = String.Empty
                                .Item(11) = String.Empty
                                .Item(13) = "0"
                                .Item(14) = "0"
                                .Item(15) = String.Empty
                                .Item(16) = String.Empty
                            End If


                            .Item(12) = (lvaloritem + lvalorfrete).ToString
                            .Item(17) = lbl_id_cidade_destino.Text
                            .Item(18) = lbl_id_estado_destino.Text
                            .Item(19) = lbl_id_propriedade_grid.Text
                            .Item(20) = lbl_id_propriedade_matriz_grid.Text
                            .Item(21) = lbl_id_produtor_grid.Text
                            .Item(22) = lbl_dt_fim_contrato_produtor.Text
                        End With

                        ilinha = ilinha + 1
                    End If
                Next

                ViewState.Item("gridtable") = dstable

            Else
                Me.ViewState("gridLinhasAdicionadas") = "S"
                ilinha = 0
            End If

            dstable.Rows.InsertAt(dstable.NewRow(), ilinha)
            Dim rownova As DataRow = dstable.Rows(ilinha)
            Dim laux As String

            If lbl_id_propriedade_matriz.Text.Equals(String.Empty) Then
                laux = "N"
            Else
                laux = "S"
            End If
            rownova(0) = String.Concat(CType(rowselected.Cells(2), DataControlFieldCell).Text, " Prop. ", lbl_id_propriedade.Text, " Matriz: ", laux)
            rownova(1) = lbl_nr_valor_disponivel.Text
            rownova(2) = String.Concat(CType(rowselected.Cells(4), DataControlFieldCell).Text, " - ", CType(rowselected.Cells(5), DataControlFieldCell).Text)
            rownova(3) = String.Empty
            rownova(5) = "N"
            rownova(6) = "1"
            rownova(17) = lbl_id_cidade.Text
            rownova(18) = lbl_id_estado.Text
            rownova(19) = lbl_id_propriedade.Text
            rownova(20) = lbl_id_propriedade_matriz.Text
            rownova(21) = lbl_id_produtor.Text
            rownova(22) = lbl_dt_fim_contrato.Text

            Me.ViewState("gridtable") = dstable
            Me.gridResults.Visible = True
            Me.gridResults.DataSource = Helper.getDataView(dstable, Me.ViewState.Item("sortExpression"))
            Me.gridResults.DataBind()

            Me.ViewState("incluirlinha") = "N"

        Catch ex As Exception
            Me.messageControl.Alert(ex.Message)
        End Try
    End Sub

    Private Sub carregarCamposProdutor()
        Try
            Me.lbl_nm_pessoa.Text = String.Empty
            Me.lbl_ds_telefone.Text = String.Empty
            Me.lbl_acordo_aquisicao_insumos.Text = String.Empty
            Me.lbl_cluster.Text = String.Empty
            Me.lbl_ds_email.Text = String.Empty
            Me.lbl_contrato.Text = String.Empty
            Me.lbl_dt_ini_contrato.Text = String.Empty
            Me.lbl_dt_fim_contrato.Text = String.Empty
            Me.lbl_dt_rescisao_contrato.Text = String.Empty
            Me.lk_gerar_pedido.Enabled = False
            If (Not Me.customPage.getFilterValue("lupa_produtor", "nm_pessoa").Equals(String.Empty)) Then
                Me.lbl_nm_pessoa.Text = Me.customPage.getFilterValue("lupa_produtor", "nm_pessoa").ToString()
            End If
            If (Me.customPage.getFilterValue("lupa_produtor", "cd_pessoa").Equals(String.Empty)) Then
                Dim pessoa As New Pessoa
                pessoa.id_pessoa = -1
                Dim dspropriedades As DataSet = pessoa.getPropriedadesProdutoresEGrupo()
                Dim dr As DataRow = dspropriedades.Tables(0).NewRow()
                dspropriedades.Tables(0).Rows.InsertAt(dr, 0)
                gridPropriedades.Visible = True
                gridPropriedades.DataSource = Helper.getDataView(dspropriedades.Tables(0), "")
                gridPropriedades.DataBind()
                gridPropriedades.Rows(0).Cells.Clear()
                gridPropriedades.Rows(0).Cells.Add(New TableCell())
                gridPropriedades.Rows(0).Attributes.CssStyle.Add("text-align", "center")
                gridPropriedades.Rows(0).Cells(0).ColumnSpan = 10
                gridPropriedades.Rows(0).Cells(0).Text = "Informe um produtor para visualizar suas propriedades!"

                Me.ViewState("gridpropriedadeslinhas") = 0
            Else
                Me.txt_cd_pessoa.Text = Me.customPage.getFilterValue("lupa_produtor", "cd_pessoa").ToString()
                If (Convert.ToInt32(Me.hf_id_produtor.Value.ToString()) > 0) Then
                    Me.loadDadosProdutor(Convert.ToInt32(Me.hf_id_produtor.Value))
                End If
            End If
            Me.customPage.clearFilters("lupa_produtor")
        Catch ex As Exception
            Me.messageControl.Alert(ex.Message)
        End Try
    End Sub


    'Protected Sub cv_cotacao_ServerValidate(ByVal source As Object, ByVal args As ServerValidateEventArgs)
    '    Try
    '        args.IsValid = True
    '        Dim namingContainer As GridViewRow = DirectCast(DirectCast(source, WebControl).NamingContainer, GridViewRow)
    '        Dim label As System.Web.UI.WebControls.Label = DirectCast(namingContainer.FindControl("lbl_id_central_cotacao_fornecedor"), System.Web.UI.WebControls.Label)
    '        If (DirectCast(namingContainer.FindControl("chk_st_selecionado"), System.Web.UI.WebControls.CheckBox).Checked) Then
    'Dim cotacaoFornecedor As Danone.MilkSystem.Business.CotacaoFornecedor = New Danone.MilkSystem.Business.CotacaoFornecedor() With
    '{
    '	.id_central_cotacao_item = Convert.ToInt32(Me.ViewState("id_central_cotacao_item").ToString()),
    '            .st_selecionado = "S"
    '}
    '            If (CotacaoFornecedor.getCotacaoFornecedorByFilters().Tables(0).Rows.Count > 0) Then
    '                If (Not Microsoft.VisualBasic.CompilerServices.Operators.ConditionalCompareObjectEqual(Me.ViewState("incluirlinhacotacao"), "S", False)) Then
    '                    CotacaoFornecedor.id_central_cotacao_fornecedor = Convert.ToInt32(label.Text)
    '                    If (CotacaoFornecedor.getCotacaoFornecedorByFilters().Tables(0).Rows.Count <= 0) Then
    '                        args.IsValid = False
    '                    Else
    '                        args.IsValid = True
    '                    End If
    '                Else
    '                    args.IsValid = False
    '                End If
    '            End If
    '        End If
    '        If (Not args.IsValid) Then
    '            Me.messageControl.Alert("Já existe Parceiro selecionado para este item de cotação.")
    '        End If
    '    Catch exception As System.Exception
    '        ProjectData.SetProjectError(exception)
    '        Me.messageControl.Alert(exception.Message)
    '        ProjectData.ClearProjectError()
    '    End Try
    'End Sub

    Protected Sub cv_itens_ServerValidate(ByVal source As Object, ByVal args As ServerValidateEventArgs)
        Dim str As String = Nothing
        Try
            args.IsValid = True
            'If (Me.ValidarItensFornecedores(str)) Then
            '    args.IsValid = True
            'Else
            '    args.IsValid = False
            '    Me.messageControl.Alert(str)
            'End If
        Catch exception As System.Exception
            Me.messageControl.Alert(exception.Message)
        End Try
    End Sub


    Protected Sub cv_pedido_aprovacao_ServerValidate(ByVal source As Object, ByVal args As ServerValidateEventArgs) Handles cv_pedido_aprovacao.ServerValidate
        Dim str As String = Nothing
        Try
            args.IsValid = True
            Select Case (New Cotacao(Convert.ToInt32(Me.ViewState("id_central_cotacao").ToString()))).id_situacao_cotacao
                Case 1
                Case 2
                    If (Not Me.lk_enviar_aprovacao.Enabled) Then
                        Dim saldoDisponivel As Danone.MilkSystem.Business.SaldoDisponivel = New Danone.MilkSystem.Business.SaldoDisponivel()
                        Dim strArrays() As String = {String.Concat("01/", Strings.Format(DateTime.Parse(Convert.ToString(DateAndTime.Now)), "MM/yyyy").ToString())}
                        saldoDisponivel.dt_referencia = String.Concat(strArrays)
                        'saldoDisponivel.id_propriedade = Convert.ToInt32(Me.txt_id_propriedade.Text)
                        'Me.AtualizarTotalizadores()
                        'Me.AtualizarLinkEnviarAprovacao()
                        If (Not Me.lk_enviar_aprovacao.Enabled) Then
                            args.IsValid = True
                            Exit Select
                        Else
                            args.IsValid = False
                            str = "O pedido só poderá ser gerado após 'Enviar Aprovação'."
                            Exit Select
                        End If
                    Else
                        args.IsValid = False
                        str = "O pedido só poderá ser gerado após 'Enviar Aprovação'."
                        Exit Select
                    End If
                Case 3
                    args.IsValid = False
                    str = "O pedido não pode ser gerado no momento pois a cotação está 'Em Aprovação'."
                    Exit Select
                Case 4
                    args.IsValid = False
                    str = "O pedido não pode ser gerado pois todos os itens da cotação foram 'Recusados' pelos aprovadores."
                    Exit Select
                Case 5
                    args.IsValid = True
                    Exit Select
            End Select
            If (Not args.IsValid) Then
                Me.messageControl.Alert(str)
            End If
        Catch exception As System.Exception
            Me.messageControl.Alert(exception.Message)
        End Try
    End Sub


    Protected Sub cv_validar_item_ServerValidate(ByVal source As Object, ByVal args As ServerValidateEventArgs) Handles cv_validar_item.ServerValidate
        Try
            args.IsValid = True

            Dim lmsg As String
            Dim row As GridViewRow

            If ViewState.Item("id_fornecedor").ToString.Trim = "0" Then
                args.IsValid = False
                lmsg = "O parceiro deve ser informado para prosseguir com a inclusão do item."
            Else
                If cbo_tipo_frete.SelectedValue.Equals(String.Empty) Then
                    args.IsValid = False
                    lmsg = "O Tipo do Frete deve ser informado para prosseguir com a inclusão do item."
                Else

                    If ViewState.Item("id_produtor").ToString = "0" Then
                        args.IsValid = False
                        lmsg = "A propriedade deve ser informado para prosseguir com a inclusão do item."

                    Else
                        For Each row In gridResults.Rows
                            If row.Visible = True Then
                                If CInt(CType(row.FindControl("lbl_id_item"), Anthem.Label).Text) = CInt(cbo_item.SelectedValue) Then
                                    args.IsValid = False
                                    lmsg = "O item informado já foi incluído ao Pedido."
                                    Exit For
                                End If
                                If CInt(CType(row.FindControl("lbl_id_categoria"), Label).Text) <> CInt(ViewState.Item("id_categoria_item")) Then
                                    args.IsValid = False
                                    lmsg = "Todos os itens de um pedido devem ser da mesma categoria."
                                    Exit For
                                End If

                            End If
                        Next
                    End If
                End If
            End If

            If args.IsValid = False Then
                Me.messageControl.Alert(lmsg)
            End If

        Catch ex As Exception
            Me.messageControl.Alert(ex.Message)
        End Try
    End Sub


    Private Sub deleteItem(ByVal id_index_row As Integer)
        Try
            gridResults.Rows(id_index_row).Visible = False

        Catch ex As Exception
            Me.messageControl.Alert(ex.Message)
        End Try
    End Sub

    'Private Sub EnviarEmailTecnicoAprovacao()
    '    Try
    '        If (Me.Page.IsValid) Then
    '            Try
    '                Dim notificacao As Danone.MilkSystem.Business.Notificacao = New Danone.MilkSystem.Business.Notificacao()
    '                Dim str As String = String.Concat("Aprovação de Cotações Central de Compras para Propriedade ", Me.txt_id_propriedade.Text.Trim(), " - ", String.Concat(Me.lbl_nm_propriedade.Text.Trim(), "."))
    '                Dim str1 As String = "Existem cotações realizadas pela Central de Compras do Produtor "
    '                str1 = String.Concat(str1, "'", String.Concat(Me.txt_id_propriedade.Text.Trim(), " - ", Me.lbl_nm_propriedade.Text.Trim()), "', ")
    '                str1 = String.Concat(str1, " pendentes para serem aprovadas por você, técnico responsável.")
    '                Dim propriedade As Danone.MilkSystem.Business.Propriedade = New Danone.MilkSystem.Business.Propriedade(Convert.ToInt32(Me.txt_id_propriedade.Text))
    '                Dim dsEmail As String = ""
    '                If (propriedade.id_tecnico > 0) Then
    '                    Dim tecnico As Danone.MilkSystem.Business.Tecnico = New Danone.MilkSystem.Business.Tecnico(Convert.ToInt32(propriedade.id_tecnico))
    '                    dsEmail = tecnico.ds_email
    '                End If
    '                If (dsEmail.Equals(String.Empty)) Then
    '                    Me.messageControl.Alert("A mensagem de solicitação de aprovação para o Técnico Responsável pela propriedade não pode ser enviada. Não há informação de email no cadastro do Técnico desta propriedade.")
    '                    Me.img_notificacao.Visible = True
    '                    Me.lk_notificar_aprovadores.set_Visible(True)
    '                ElseIf (Not notificacao.enviaMensagemEmail(str, str1, "central.compras@danone.com", dsEmail, "", MailPriority.High, False, "", True)) Then
    '                    Me.messageControl.Alert("A mensagem de solicitação de aprovação para o Técnico Responsável pela propriedade não pode ser enviada. Verifique se há destinatários cadastrados para este tipo de notificação.")
    '                    Me.img_notificacao.Visible = True
    '                    Me.lk_notificar_aprovadores.set_Visible(True)
    '                Else
    '                    Me.messageControl.Alert("A mensagem de solicitação de aprovação para o Técnico Responsável pela propriedade foi enviada aos destinatários com sucesso!")
    '                End If
    '            Catch exception As System.Exception
    '                Me.messageControl.Alert(exception.Message)
    '            End Try
    '        End If
    '    Catch exception1 As System.Exception
    '        Me.messageControl.Alert(exception1.Message)
    '    End Try
    'End Sub

    Protected Overrides Sub Finalize()
        MyBase.Finalize()
    End Sub


    Protected Sub gridPropriedades_RowDataBound(ByVal sender As Object, ByVal e As GridViewRowEventArgs) Handles gridPropriedades.RowDataBound
        Try
            If (e.Row.RowType = DataControlRowType.DataRow AndAlso Me.ViewState("gridpropriedadeslinhas") > 0) Then
                If (e.Row.RowState <> (DataControlRowState.Alternate Or DataControlRowState.Edit) AndAlso e.Row.RowState <> DataControlRowState.Edit) Then
                    Dim lbl_nr_valor_disponivel As Anthem.Label = CType(e.Row.FindControl("lbl_nr_valor_disponivel"), Anthem.Label)
                    Dim lbl_id_propriedade As Label = CType(e.Row.FindControl("lbl_id_propriedade"), Label)
                    Dim lbl_nr_valor_mensal_estimado As Anthem.Label = CType(e.Row.FindControl("lbl_nr_valor_mensal_estimado"), Anthem.Label)
                    Dim lbl_nr_total_pedidos_abertos As Anthem.Label = CType(e.Row.FindControl("lbl_nr_total_pedidos_abertos"), Anthem.Label)
                    Dim hl_nr_total_pedidos_abertos As Anthem.HyperLink = CType(e.Row.FindControl("hl_nr_total_pedidos_abertos"), Anthem.HyperLink)
                    Dim lbl_id_propriedade_matriz As Label = CType(e.Row.FindControl("lbl_id_propriedade_matriz"), Label)
                    Dim row_num As Label = CType(e.Row.FindControl("lbl_row_num"), Label)
                    'Dim celcomand As DataControlFieldCell = CType(e.Row.Cells.Item(0), DataControlFieldCell)
                    Dim imgselecionar As Anthem.ImageButton = CType(e.Row.FindControl("imgselecionar"), Anthem.ImageButton)
                    Dim lbl_nr_limite_mes_bruto As Anthem.Label = CType(e.Row.FindControl("lbl_nr_limite_mes_bruto"), Anthem.Label)
                    Dim lbl_nr_valor_desconto As Anthem.Label = CType(e.Row.FindControl("lbl_nr_valor_desconto"), Anthem.Label)


                    'SaldoDisponivel.id_propriedade = lbl_id_propriedade.Text
                    'lbl_nr_valor_disponivel.Text = FormatNumber(saldoDisponivel.getSaldoDisponivel(True), 2).ToString
                    'If saldoDisponivel.st_saldo_romaneio_aberto = True Then
                    '    Me.lbl_informativo.Visible = True
                    'Else
                    '    Me.lbl_informativo.Visible = False
                    'End If
                    'lbl_nr_valor_mensal_estimado.Text = saldoDisponivel.nr_valor_faturamento.ToString
                    If Not lbl_id_propriedade_matriz.Text.Equals(String.Empty) AndAlso CInt(row_num.Text) > 1 Then
                        'CType(celcomand.ContainingField, CommandField).ShowSelectButton = False
                        imgselecionar.Visible = False
                        hl_nr_total_pedidos_abertos.Visible = True
                        hl_nr_total_pedidos_abertos.Text = String.Empty
                        hl_nr_total_pedidos_abertos.NavigateUrl = String.Empty
                        lbl_nr_total_pedidos_abertos.Visible = False

                    Else
                        'CType(celcomand.ContainingField, CommandField).ShowSelectButton = True
                        imgselecionar.Visible = True

                        Dim pedido As New Pedido

                        If Not lbl_id_propriedade_matriz.Text.Equals(String.Empty) Then
                            pedido.id_propriedade_matriz = lbl_id_propriedade_matriz.Text
                        Else
                            pedido.id_propriedade = lbl_id_propriedade.Text
                        End If

                        lbl_nr_total_pedidos_abertos.Text = pedido.getTotalPedidosAbertos().ToString()
                        If (CDec(lbl_nr_total_pedidos_abertos.Text) <= 0) Then
                            lbl_nr_total_pedidos_abertos.Text = FormatCurrency(0, 2).ToString
                            hl_nr_total_pedidos_abertos.Visible = False
                            lbl_nr_total_pedidos_abertos.Visible = True
                        Else
                            hl_nr_total_pedidos_abertos.Visible = True
                            hl_nr_total_pedidos_abertos.Text = FormatCurrency(lbl_nr_total_pedidos_abertos.Text, 2).ToString
                            hl_nr_total_pedidos_abertos.NavigateUrl = String.Format("frm_central_pedidos_abertos.aspx?id_propriedade={0}", lbl_id_propriedade.Text)
                            lbl_nr_total_pedidos_abertos.Visible = False
                        End If

                        Dim saldoDisponivel As New SaldoDisponivel()
                        saldoDisponivel.dt_referencia = String.Concat("01/", DateTime.Now.ToString("MM/yyyy")).ToString
                        If Not lbl_id_propriedade_matriz.Text.Equals(String.Empty) Then
                            saldoDisponivel.id_propriedade = lbl_id_propriedade_matriz.Text
                        Else
                            saldoDisponivel.id_propriedade = lbl_id_propriedade.Text
                        End If

                        lbl_nr_valor_disponivel.Text = FormatNumber(saldoDisponivel.getSaldoDisponivelCentral, 2).ToString
                        lbl_nr_limite_mes_bruto.Text = FormatNumber(saldoDisponivel.nr_limite_bruto, 2).ToString
                        lbl_nr_valor_desconto.Text = FormatNumber(saldoDisponivel.nr_valor_descontos, 2).ToString

                        If saldoDisponivel.nr_limite_bruto = 0 Then
                            Me.lbl_informativo_2.Visible = True
                            lbl_nr_valor_disponivel.Text = String.Empty
                            lbl_nr_limite_mes_bruto.Text = String.Empty
                            lbl_nr_valor_desconto.Text = String.Empty
                        Else
                            If saldoDisponivel.st_saldo_custo_financeiro = True Then
                                Me.lbl_informativo_1.Visible = True
                                lbl_nr_valor_disponivel.ForeColor = Drawing.Color.Blue
                                lbl_nr_limite_mes_bruto.ForeColor = Drawing.Color.Blue
                            End If
                        End If
                    End If

                End If
            End If
        Catch ex As Exception
            Me.messageControl.Alert(ex.Message)
        End Try
    End Sub

    Protected Sub gridPropriedades_SelectedIndexChanged(ByVal sender As Object, ByVal e As EventArgs) Handles gridPropriedades.SelectedIndexChanged
        Dim rowselected As GridViewRow = Me.gridPropriedades.SelectedRow
        incluirPropriedade(rowselected.RowIndex)
    End Sub

    Protected Sub gridResults_RowCommand(ByVal sender As Object, ByVal e As GridViewCommandEventArgs) Handles gridResults.RowCommand
        Select Case e.CommandName.ToString().ToLower()

            Case "delete"
                deleteItem(Convert.ToInt32(e.CommandArgument.ToString()))

                'Case "lupa"
                '    'Me.txt_placa.Text = ""

                '    carregarCamposFreteValor(Convert.ToInt32(e.CommandArgument.ToString()))





        End Select
        'If (Microsoft.VisualBasic.CompilerServices.Operators.CompareString(lower, "cotacoes", False) <> 0) Then
        '    If (Microsoft.VisualBasic.CompilerServices.Operators.CompareString(lower, "delete", False) = 0) Then
        '        Me.deleteItemCotacao(Convert.ToInt32(e.CommandArgument.ToString()))
        '    ElseIf (Microsoft.VisualBasic.CompilerServices.Operators.CompareString(lower, "Insert", False) <> 0) Then
        '        If (Microsoft.VisualBasic.CompilerServices.Operators.CompareString(lower, "delete", False) = 0) Then
        '            Me.deleteCotacaoFornecedor(Convert.ToInt32(e.CommandArgument.ToString()))
        '        ElseIf (Microsoft.VisualBasic.CompilerServices.Operators.CompareString(lower, "Lupa", False) = 0) Then
        '            Me.carregarCamposfretevalor(Convert.ToInt32(e.CommandArgument.ToString()))
        '        ElseIf (Microsoft.VisualBasic.CompilerServices.Operators.CompareString(lower, "LupaTransportador", False) = 0) Then
        '            Me.carregarCamposTransportador(Convert.ToInt32(e.CommandArgument.ToString()))
        '        End If
        '    End If
        'End If
    End Sub

    Protected Sub gridResults_RowCreated(ByVal sender As Object, ByVal e As GridViewRowEventArgs) Handles gridResults.RowCreated
        If (e.Row.RowType = DataControlRowType.DataRow) Then
            Try
                Dim btnexcluir As ImageButton = CType(e.Row.FindControl("btn_delete"), ImageButton)
                Dim btnlupafrete As ImageButton = CType(e.Row.FindControl("btn_lupa_frete_valor"), ImageButton)
                Dim btn_atualizar_totais As ImageButton = CType(e.Row.FindControl("btn_atualizar_totais"), ImageButton)
                Dim trfrete As HtmlTableRow = CType(e.Row.FindControl("tr_frete"), HtmlTableRow)
                Dim cbo_transportador As DropDownList = CType(e.Row.FindControl("cbo_transportador"), DropDownList)
                'Dim label As System.Web.UI.WebControls.Label = DirectCast(e.Row.FindControl("linhanova"), System.Web.UI.WebControls.Label)

                Dim pessoa As New Pessoa()

                btnexcluir.CommandArgument = e.Row.RowIndex.ToString
                btnlupafrete.CommandArgument = e.Row.RowIndex.ToString
                btn_atualizar_totais.CommandArgument = e.Row.RowIndex.ToString

                If (Not Me.cbo_pedido_indireto.SelectedValue.Equals("S")) Then
                    CType(e.Row.FindControl("rf_transportador"), RequiredFieldValidator).Enabled = True
                Else
                    CType(e.Row.FindControl("rf_transportador"), RequiredFieldValidator).Enabled = False
                End If

                'se pedido normal ou frete fob d
                If cbo_pedido_indireto.SelectedValue.Equals("N") AndAlso cbo_tipo_frete.SelectedValue.Equals("D") Then
                    trfrete.Visible = True

                    'transportador central
                    pessoa.id_situacao = 1
                    pessoa.st_transportador_central = "S"
                    cbo_transportador.DataSource = pessoa.getTransportadorCentralByFilters()
                    cbo_transportador.DataTextField = "nm_pessoa"
                    cbo_transportador.DataValueField = "id_pessoa"
                    cbo_transportador.DataBind()
                    cbo_transportador.Items.Insert(0, New ListItem("[Selecione]", 0))

                Else
                    trfrete.Visible = False
                End If


            Catch ex As Exception
                Me.messageControl.Alert(ex.Message)
            End Try
        End If
    End Sub

    Protected Sub gridResults_RowDataBound(ByVal sender As Object, ByVal e As GridViewRowEventArgs) Handles gridResults.RowDataBound
        If (e.Row.RowType = DataControlRowType.DataRow) Then
            Dim lbl_descricao As Label = CType(e.Row.FindControl("lbl_descricao"), Label)
            Dim lbl_limite As Anthem.Label = CType(e.Row.FindControl("lbl_limite"), Anthem.Label)
            Dim cbo_tipo_medida As Anthem.DropDownList = CType(e.Row.FindControl("cbo_tipo_medida"), Anthem.DropDownList)
            Dim txt_nr_qtde As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(e.Row.FindControl("txt_nr_qtde"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
            Dim cbo_vai_parcelar As Anthem.DropDownList = CType(e.Row.FindControl("cbo_vai_parcelar"), Anthem.DropDownList)
            Dim txt_nr_parcelas As RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox = CType(e.Row.FindControl("txt_nr_parcelas"), RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox)
            Dim cbo_transportador As Anthem.DropDownList = CType(e.Row.FindControl("cbo_transportador"), Anthem.DropDownList)
            Dim txt_nr_frete As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(e.Row.FindControl("txt_nr_frete"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
            Dim lbl_tipo_caminhao As Anthem.Label = CType(e.Row.FindControl("lbl_tipo_caminhao"), Anthem.Label)
            Dim lbl_total_item As Anthem.Label = CType(e.Row.FindControl("lbl_total_item"), Anthem.Label)
            Dim lbl_total_frete As Anthem.Label = CType(e.Row.FindControl("lbl_total_frete"), Anthem.Label)
            Dim lbl_valor_total As Anthem.Label = CType(e.Row.FindControl("lbl_valor_total"), Anthem.Label)
            Dim lbl_id_central_tabela_frete_veiculos As Label = CType(e.Row.FindControl("lbl_id_central_tabela_frete_veiculos"), System.Web.UI.WebControls.Label)
            Dim lbl_id_veiculo_central_compras As Label = CType(e.Row.FindControl("lbl_id_veiculo_central_compras"), System.Web.UI.WebControls.Label)
            Dim lbl_inf_frete As Label = CType(e.Row.FindControl("lbl_inf_frete"), Label)


            Dim item As DataRow = CType(Me.ViewState("gridtable"), DataTable).Rows(e.Row.RowIndex)
            Dim btn_lupa_frete As Anthem.ImageButton = CType(e.Row.FindControl("btn_lupa_frete_valor"), Anthem.ImageButton)
            Dim rf_transportador As RequiredFieldValidator = CType(e.Row.FindControl("rf_transportador"), RequiredFieldValidator)
            Dim rf_frete As RequiredFieldValidator = CType(e.Row.FindControl("rf_frete"), RequiredFieldValidator)
            Dim rfv_sacaria As RequiredFieldValidator = CType(e.Row.FindControl("rfv_sacaria"), RequiredFieldValidator)

            Dim lbl_dt_cotacao_frete As Anthem.Label = CType(e.Row.FindControl("lbl_dt_cotacao_frete"), Anthem.Label)
            Dim lbl_id_cidade_destino As Label = CType(e.Row.FindControl("lbl_id_cidade_destino"), Label)
            Dim lbl_id_estado_destino As Label = CType(e.Row.FindControl("lbl_id_estado_destino"), Label)
            Dim lbl_id_propriedade_grid As Label = CType(e.Row.FindControl("lbl_id_propriedade_grid"), Label)
            Dim lbl_id_propriedade_matriz_grid As Label = CType(e.Row.FindControl("lbl_id_propriedade_matriz_grid"), Label)
            Dim lbl_id_produtor_grid As Label = CType(e.Row.FindControl("lbl_id_produtor_grid"), Label)


            If (item IsNot Nothing) Then

                'totalizador
                If txt_nr_qtde.Text <> String.Empty And txt_nr_valor_unitario.Text <> String.Empty Then
                    If IsNumeric(txt_nr_qtde.Text) And IsNumeric(txt_nr_valor_unitario.Text) AndAlso Convert.ToDecimal(txt_nr_qtde.Text) > 0 Then

                        lbl_total_item.Text = Strings.FormatNumber((Convert.ToDecimal(txt_nr_valor_unitario.Text) + Convert.ToDecimal(txt_nr_sacaria.Text)) * Convert.ToDecimal(txt_nr_qtde.Text), 2)
                        lbl_valor_total.Text = lbl_total_item.Text
                    End If
                End If
                If (IsNumeric(txt_nr_qtde.Text) And IsNumeric(txt_nr_frete.Text) AndAlso Convert.ToDecimal(txt_nr_qtde.Text) > 0) Then
                    lbl_total_frete.Text = Strings.FormatCurrency(Convert.ToDecimal(txt_nr_frete.Text) * Convert.ToDecimal(txt_nr_qtde.Text), 2)
                    lbl_valor_total.Text = Strings.FormatNumber(Convert.ToDecimal(lbl_valor_total.Text) + Convert.ToDecimal(lbl_total_frete.Text), 2)
                End If
                If cbo_tipo_frete.SelectedValue = "D" Then
                    txt_nr_frete.Enabled = True
                    cbo_transportador.Enabled = True
                    rf_transportador.Enabled = True
                    rf_frete.Enabled = True
                    'id_transprtador
                    If (Not item(7).ToString().Equals(String.Empty)) AndAlso (Not item(7).ToString().Equals("0")) Then
                        cbo_transportador.SelectedValue = item(7).ToString
                        btn_lupa_frete.Enabled = True
                    Else
                        cbo_transportador.SelectedValue = "0"
                    End If
                End If



            End If
        End If
    End Sub

    Protected Sub gridResults_RowDeleting(ByVal sender As Object, ByVal e As GridViewDeleteEventArgs) Handles gridResults.RowDeleting
        e.Cancel = True
    End Sub

    Private Sub LimparSelecaoGridItens()
        'Try
        '    Me.ViewState("id_central_cotacao_item") = 0
        '    Me.btn_adicionar_cotacao.Enabled = False
        'Catch exception As System.Exception
        '    ProjectData.SetProjectError(exception)
        '    Me.messageControl.Alert(exception.Message)
        '    ProjectData.ClearProjectError()
        'End Try
    End Sub

    Protected Sub lk_enviar_aprovacao_Click(ByVal sender As Object, ByVal e As EventArgs) Handles lk_enviar_aprovacao.Click
        If (Me.Page.IsValid) Then
            '        Try
            'Dim cotacao As Danone.MilkSystem.Business.Cotacao = New Danone.MilkSystem.Business.Cotacao() With
            '{
            '            .id_central_cotacao = Convert.ToInt32(Me.ViewState("id_central_cotacao").ToString())
            '}
            '            Cotacao.updateCotacaoQtdeItensAprovacao()
            '            Cotacao.id_situacao_cotacao = 3
            '            Cotacao.updateCentralCotacaoSituacao()
            'Dim cotacaoItem As Danone.MilkSystem.Business.CotacaoItem = New Danone.MilkSystem.Business.CotacaoItem() With
            '{
            '	.id_central_status_aprovacao = Conversions.ToString(7),
            '            .id_central_cotacao = Cotacao.id_central_cotacao
            '}
            '            CotacaoItem.updateCentralCotacaoItemSituacaobyCotacao()
            '            Me.EnviarEmailTecnicoAprovacao()
            '        Catch exception As System.Exception
            '            ProjectData.SetProjectError(exception)
            '            Me.messageControl.Alert(exception.Message)
            '            ProjectData.ClearProjectError()
            '        End Try
        End If
    End Sub

    Protected Sub lk_gerar_pedido_Click(ByVal sender As Object, ByVal e As EventArgs) Handles lk_gerar_pedido.Click
        If (Me.Page.IsValid) Then
            Try

                If ViewState.Item("id_central_pedido_matriz") = 0 Then

                    'preparar dados do grid de itens
                    Dim dstable As New DataTable
                    Dim ilinha As Integer

                    dstable.Columns.Add("nr_valor_limite")
                    dstable.Columns.Add("ds_tipo_medida")
                    dstable.Columns.Add("nr_qtde")
                    dstable.Columns.Add("st_parcelamento")
                    dstable.Columns.Add("nr_parcelas")
                    dstable.Columns.Add("id_transportador")
                    dstable.Columns.Add("nr_frete")
                    dstable.Columns.Add("nr_valor_total_item")
                    dstable.Columns.Add("nr_valor_total_frete")
                    dstable.Columns.Add("id_central_tabela_frete_veiculos")
                    dstable.Columns.Add("id_veiculo_central_compras")
                    dstable.Columns.Add("id_cidade_destino")
                    dstable.Columns.Add("id_estado_destino")
                    dstable.Columns.Add("id_propriedade")
                    dstable.Columns.Add("id_propriedade_matriz")
                    dstable.Columns.Add("id_produtor")
                    dstable.Columns.Add("dt_fim_contrato")


                    Dim row As GridViewRow
                    Dim lvaloritem As Decimal = 0
                    Dim lvalorfrete As Decimal = 0
                    Dim lvalortotalpedidofornecedor As Decimal = 0
                    Dim lvalortotalpedidotransortador As Decimal = 0

                    ilinha = 0
                    For Each row In gridResults.Rows
                        If row.Visible = True Then
                            Dim cbo_tipo_medida As Anthem.DropDownList = CType(row.FindControl("cbo_tipo_medida"), Anthem.DropDownList)
                            Dim txt_nr_qtde As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_qtde"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
                            Dim cbo_transportador As Anthem.DropDownList = CType(row.FindControl("cbo_transportador"), Anthem.DropDownList)
                            Dim txt_nr_frete As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_frete"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
                            Dim lbl_id_central_tabela_frete_veiculos As Label = CType(row.FindControl("lbl_id_central_tabela_frete_veiculos"), Label)
                            Dim lbl_id_veiculo_central_compras As Label = CType(row.FindControl("lbl_id_veiculo_central_compras"), Label)
                            Dim lbl_limite As Anthem.Label = CType(row.FindControl("lbl_limite"), Anthem.Label)
                            Dim cbo_vai_parcelar As Anthem.DropDownList = CType(row.FindControl("cbo_vai_parcelar"), Anthem.DropDownList)
                            Dim txt_nr_parcelas As RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox = CType(row.FindControl("txt_nr_parcelas"), RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox)
                            Dim lbl_id_cidade_destino As Label = CType(row.FindControl("lbl_id_cidade_destino"), Label)
                            Dim lbl_id_estado_destino As Label = CType(row.FindControl("lbl_id_estado_destino"), Label)
                            Dim lbl_id_propriedade_grid As Label = CType(row.FindControl("lbl_id_propriedade_grid"), Label)
                            Dim lbl_id_propriedade_matriz_grid As Label = CType(row.FindControl("lbl_id_propriedade_matriz_grid"), Label)
                            Dim lbl_id_produtor_grid As Label = CType(row.FindControl("lbl_id_produtor_grid"), Label)
                            Dim lbl_dt_fim_contrato_grid As Label = CType(row.FindControl("lbl_dt_fim_contrato_grid"), Label)

                            dstable.Rows.InsertAt(dstable.NewRow(), ilinha)

                            Dim saldoDisponivel As New SaldoDisponivel()
                            saldoDisponivel.dt_referencia = String.Concat("01/", DateTime.Now.ToString("MM/yyyy")).ToString
                            If Not lbl_id_propriedade_matriz_grid.Text.Equals(String.Empty) Then
                                saldoDisponivel.id_propriedade = lbl_id_propriedade_matriz_grid.Text
                            Else
                                saldoDisponivel.id_propriedade = lbl_id_propriedade_grid.Text
                            End If

                            lvaloritem = 0
                            lvalorfrete = 0
                            With dstable.Rows.Item(ilinha)
                                .Item(0) = Round(saldoDisponivel.getSaldoDisponivelCentral, 2)
                                .Item(1) = cbo_tipo_medida.SelectedValue
                                .Item(2) = txt_nr_qtde.Text
                                .Item(3) = cbo_vai_parcelar.SelectedValue
                                .Item(4) = txt_nr_parcelas.Text

                                If cbo_tipo_medida.SelectedValue = "S" Then
                                    lvaloritem = (CDec(txt_nr_valor_unitario.Text) + CDec(txt_nr_sacaria.Text)) * CDec(txt_nr_qtde.Text)
                                    .Item(7) = lvaloritem.ToString
                                Else
                                    lvaloritem = CDec(txt_nr_valor_unitario.Text) * CDec(txt_nr_qtde.Text)
                                    .Item(7) = lvaloritem.ToString
                                End If

                                'se tipo de frete é fob d
                                If cbo_tipo_frete.SelectedValue = "D" Then
                                    .Item(5) = cbo_transportador.SelectedValue
                                    .Item(6) = txt_nr_frete.Text
                                    lvalorfrete = CDec(txt_nr_frete.Text) * CDec(txt_nr_qtde.Text)
                                    .Item(8) = lvalorfrete.ToString
                                    'se informação sobre tabela de frete for vazia, significa que nao uilizou tabela de frete do cadastro
                                    If lbl_id_central_tabela_frete_veiculos.Text.Equals(String.Empty) Then
                                        .Item(9) = "0"
                                        .Item(10) = "0"
                                    Else
                                        .Item(9) = lbl_id_central_tabela_frete_veiculos.Text
                                        .Item(10) = lbl_id_veiculo_central_compras.Text
                                    End If
                                Else
                                    .Item(5) = "0"
                                    .Item(6) = "0"
                                    .Item(8) = "0"
                                    .Item(9) = "0"
                                    .Item(10) = "0"
                                    lvalorfrete = 0
                                End If

                                .Item(11) = lbl_id_cidade_destino.Text
                                .Item(12) = lbl_id_estado_destino.Text
                                .Item(13) = lbl_id_propriedade_grid.Text
                                .Item(14) = lbl_id_propriedade_matriz_grid.Text
                                .Item(15) = lbl_id_produtor_grid.Text
                                .Item(16) = lbl_dt_fim_contrato.Text
                            End With

                            ilinha = ilinha + 1
                        End If
                    Next

                    Dim pedido As New Pedido

                    pedido.id_estabelecimento = cbo_estabelecimento.SelectedValue
                    pedido.id_fornecedor = ViewState.Item("id_fornecedor").ToString
                    pedido.id_item = cbo_item.SelectedValue
                    pedido.ds_tipofrete = cbo_tipo_frete.SelectedValue
                    pedido.ds_inclusao_pedido = "M"
                    pedido.st_pedido_indireto = cbo_pedido_indireto.SelectedValue
                    If chk_compras_evento.Checked Then
                        pedido.st_evento_compras = "S"
                    Else
                        pedido.st_evento_compras = "N"
                    End If
                    If txt_nr_qtde_total.Text = String.Empty Then
                        pedido.nr_quantidade_total = 0
                    Else
                        pedido.nr_quantidade_total = txt_nr_qtde_total.Text
                    End If
                    pedido.nr_valor_unitario = Convert.ToDecimal(txt_nr_valor_unitario.Text)
                    If txt_nr_sacaria.Text = String.Empty Then
                        pedido.nr_sacaria = 0
                    Else
                        pedido.nr_sacaria = Convert.ToDecimal(txt_nr_sacaria.Text)
                    End If
                    pedido.id_modificador = Session("id_login")

                    pedido.pedidoitens = dstable
                    ViewState.Item("id_central_pedido_matriz") = pedido.gerarPedidoGrupo

                    If ViewState.Item("id_central_pedido_matriz") = 0 Then
                        Me.messageControl.Alert("Ocorreram problemas na geração do Pedido. Contate o administrador do sistema.")
                    Else
                        Me.messageControl.Alert("Pedidos gerados com sucesso!")
                        lk_gerar_pedido.Enabled = False
                        lk_gerar_pedido.ToolTip = "Pedido gerado."

                    End If
                End If
            Catch ex As Exception
                Me.messageControl.Alert(ex.Message)
            End Try
        End If
    End Sub

    Protected Sub lk_notificar_aprovadores_Click(ByVal sender As Object, ByVal e As EventArgs) Handles lk_notificar_aprovadores.Click
        'Try
        '    Me.EnviarEmailTecnicoAprovacao()
        'Catch exception As System.Exception
        '    ProjectData.SetProjectError(exception)
        '    Me.messageControl.Alert(exception.Message)
        '    ProjectData.ClearProjectError()
        'End Try
    End Sub

    Protected Sub lk_novo_Click(ByVal sender As Object, ByVal e As EventArgs) Handles lk_novo.Click
        Me.Response.Redirect("frm_central_pedido_abertura_grupo.aspx")
    End Sub

    Private Sub loadDadosProdutor(ByVal pid_produtor As Integer)
        Me.lbl_nm_pessoa.Text = String.Empty
        Me.lbl_ds_telefone.Text = String.Empty
        Me.lbl_acordo_aquisicao_insumos.Text = String.Empty
        Me.lbl_cluster.Text = String.Empty
        Me.lbl_ds_email.Text = String.Empty
        Me.lbl_contrato.Text = String.Empty
        Me.lbl_dt_ini_contrato.Text = String.Empty
        Me.lbl_dt_fim_contrato.Text = String.Empty
        Me.lbl_dt_rescisao_contrato.Text = String.Empty

        Try
            Dim lidpessoacontrato As Integer = 0
            Dim produtor As New Pessoa
            produtor.id_pessoa = pid_produtor

            Dim dspessoa As DataSet = produtor.getPessoaByFilters

            If (dspessoa.Tables(0).Rows.Count <= 0) Then
                Me.lk_gerar_pedido.Enabled = False
            Else
                With dspessoa.Tables(0).Rows(0)
                    Me.lbl_nm_pessoa.Enabled = True
                    Me.lbl_nm_pessoa.Text = .Item("nm_pessoa").ToString
                    Me.hf_id_produtor.Value = .Item("id_pessoa").ToString
                    Me.lbl_ds_telefone.Text = .Item("ds_celular").ToString
                    Me.lbl_ds_email.Text = .Item("ds_email").ToString
                    If .Item("st_acordo_aquisicao_insumos").ToString.Equals("S") Then
                        Me.lbl_acordo_aquisicao_insumos.Text = "Sim"
                    Else
                        Me.lbl_acordo_aquisicao_insumos.Text = "Não"
                    End If

                    If Not IsDBNull(.Item("id_pessoa_contrato")) Then
                        lidpessoacontrato = .Item("id_pessoa_contrato")
                    End If
                End With

                If lidpessoacontrato = 0 Then
                    Me.lbl_contrato.Text = String.Empty
                    Me.lbl_dt_ini_contrato.Text = String.Empty
                    Me.lbl_dt_fim_contrato.Text = String.Empty
                    Me.lbl_dt_rescisao_contrato.Text = String.Empty
                Else
                    Dim contrato As New PessoaContrato()
                    contrato.id_pessoa_contrato = Convert.ToInt32(lidpessoacontrato)

                    Dim dscontrato As DataSet = contrato.getPessoaContratoByFilters()
                    If (dscontrato.Tables(0).Rows.Count <= 0) Then
                        Me.lbl_contrato.Text = String.Empty
                        Me.lbl_dt_ini_contrato.Text = String.Empty
                        Me.lbl_dt_fim_contrato.Text = String.Empty
                        Me.lbl_dt_rescisao_contrato.Text = String.Empty
                    Else
                        With dscontrato.Tables(0).Rows(0)
                            Me.lbl_contrato.Text = String.Concat(.Item("cd_contrato").ToString, " - ", .Item("nm_contrato").ToString)
                            If Not IsDBNull(.Item("dt_inicio_contrato")) Then
                                lbl_dt_ini_contrato.Text = DateTime.Parse(.Item("dt_inicio_contrato")).ToString("dd/MM/yyyy")
                            Else
                                lbl_dt_ini_contrato.Text = String.Empty
                            End If

                            If Not IsDBNull(.Item("dt_fim_contrato")) Then
                                lbl_dt_fim_contrato.Text = DateTime.Parse(.Item("dt_fim_contrato")).ToString("dd/MM/yyyy")
                            Else
                                lbl_dt_fim_contrato.Text = String.Empty
                            End If

                            If Not IsDBNull(.Item("dt_rescisao")) Then
                                lbl_dt_rescisao_contrato.Text = DateTime.Parse(.Item("dt_rescisao")).ToString("dd/MM/yyyy")
                            Else
                                lbl_dt_rescisao_contrato.Text = String.Empty
                            End If

                            Me.lbl_cluster.Text = .Item("nm_cluster").ToString()

                        End With

                    End If

                End If


                Me.loadGridPropriedades()
            End If
        Catch ex As Exception
            Me.messageControl.Alert(ex.Message)
        End Try
    End Sub

    Private Sub loadDetails()
        Try
            Dim estabel As New Estabelecimento
            estabel.st_recepcao_leite = "S"
            cbo_estabelecimento.DataSource = estabel.getEstabelecimentosByFilters()
            cbo_estabelecimento.DataTextField = "nm_estabelecimento"
            cbo_estabelecimento.DataValueField = "id_estabelecimento"
            cbo_estabelecimento.DataBind()
            cbo_estabelecimento.Items.Insert(0, New ListItem("[Selecione]", "0"))
            ViewState.Item("id_estabelecimento") = "0"
            Me.ViewState.Item("id_propriedade") = 0
            Me.ViewState.Item("id_estado_destino") = 0
            Me.ViewState.Item("id_cidade_destino") = 0
            Me.ViewState.Item("id_produtor") = 0
            ViewState.Item("id_central_pedido_matriz") = 0

            Dim parametro As New Parametro
            ViewState("nr_politica_parcelas") = parametro.nr_politica_parcelas

            'combo fornecedor
            cbo_fornecedor.Items.Insert(0, New ListItem("[Selecione um Estabelecimento]", "0"))
            cbo_fornecedor.SelectedValue = 0
            ViewState.Item("id_fornecedor") = "0"

            'combo item
            cbo_item.Items.Insert(0, New ListItem("[Selecione um Parceiro]", "0"))
            cbo_item.SelectedValue = 0
            gridResults.Visible = False
            lbl_detalhe_item_frete.Text = String.Empty
            gridfrete.Visible = False
            ViewState.Item("id_item") = "0"

            'grid produtores/propriedades
            Dim pessoa As New Pessoa
            pessoa.id_pessoa = -1
            Dim dspropriedades As DataSet = pessoa.getPropriedadesProdutoresEGrupo()
            Dim dr As DataRow = dspropriedades.Tables(0).NewRow()
            dspropriedades.Tables(0).Rows.InsertAt(dr, 0)
            gridPropriedades.Visible = True
            gridPropriedades.DataSource = Helper.getDataView(dspropriedades.Tables(0), "")
            gridPropriedades.DataBind()
            gridPropriedades.Rows(0).Cells.Clear()
            gridPropriedades.Rows(0).Cells.Add(New TableCell())
            gridPropriedades.Rows(0).Attributes.CssStyle.Add("text-align", "center")
            gridPropriedades.Rows(0).Cells(0).ColumnSpan = 10
            gridPropriedades.Rows(0).Cells(0).Text = "Informe um produtor para visualizar suas propriedades!"

        Catch ex As Exception
            messageControl.Alert(ex.Message)

        End Try
    End Sub
    Private Sub loadComboItens(ByVal pFiltroNome As String)
        Try


            Dim lcboitem As String = cbo_item.SelectedValue

            Dim itemparceiro As New ItemParceiro
            itemparceiro.id_fornecedor = ViewState.Item("id_fornecedor").ToString
            itemparceiro.nm_item = pFiltroNome

            cbo_item.DataSource = itemparceiro.getCentralItemParceiro
            cbo_item.DataTextField = "ds_item"
            cbo_item.DataValueField = "id_item"
            cbo_item.DataBind()
            cbo_item.Items.Insert(0, New ListItem("[Selecione]", "0"))

            'se nao tem filtro
            If pFiltroNome.Equals(String.Empty) Then
                cbo_item.SelectedValue = lcboitem
            Else
                lbl_nm_categoria.Text = String.Empty
                cbo_item.Focus()
            End If


        Catch ex As Exception
            messageControl.Alert(ex.Message)

        End Try
    End Sub

    Private Sub loadComboParceiro(ByVal pFiltroNome As String)
        Try


            Dim parceiroitem As New ItemParceiro
            parceiroitem.id_estabelecimento = ViewState.Item("id_estabelecimento").ToString
            parceiroitem.nm_pessoa = pFiltroNome
            parceiroitem.st_acordo_aquisicao_insumos = "S"

            cbo_fornecedor.DataSource = parceiroitem.getCentralParceiroComItens()
            cbo_fornecedor.DataTextField = "ds_abreviado"
            cbo_fornecedor.DataValueField = "id_fornecedor"
            cbo_fornecedor.DataBind()
            cbo_fornecedor.Items.Insert(0, New ListItem("[Selecione]", "0"))

            'se nao tem filtro
            If pFiltroNome.Equals(String.Empty) Then
                txt_nm_fornecedor.Text = "[Filtre Nome Parceiro]"
                If CInt(ViewState.Item("id_fornecedor").ToString) > 0 Then
                    cbo_fornecedor.SelectedValue = ViewState.Item("id_fornecedor").ToString
                Else
                    'cbo_fornecedor.Items.Insert(0, New ListItem("[Selecione]", "0"))
                    cbo_fornecedor.SelectedValue = "0"
                End If
            Else
                cbo_fornecedor.Focus()
            End If


        Catch ex As Exception
            messageControl.Alert(ex.Message)

        End Try
    End Sub
    Private Sub loadGridPropriedades()
        Try
            If (Me.hf_id_produtor.Value.Equals(String.Empty)) Then

                Dim pessoa As New Pessoa
                pessoa.id_pessoa = -1

                Dim dspropriedades As DataSet = pessoa.getPropriedadesProdutoresEGrupo()

                Dim dr As DataRow = dspropriedades.Tables(0).NewRow()
                dspropriedades.Tables(0).Rows.InsertAt(dr, 0)
                Me.ViewState("gridpropriedadeslinhas") = 0
                Me.gridPropriedades.Visible = True
                Me.gridPropriedades.DataSource = Helper.getDataView(dspropriedades.Tables(0), "")
                Me.gridPropriedades.DataBind()
                Me.gridPropriedades.Rows(0).Cells.Clear()
                Me.gridPropriedades.Rows(0).Cells.Add(New TableCell())
                Me.gridPropriedades.Rows(0).Attributes.CssStyle.Add("text-align", "center")
                Me.gridPropriedades.Rows(0).Cells(0).Text = "Selecione um produtor ativo."
                Me.gridPropriedades.Rows(0).Cells(0).ColumnSpan = 10
            Else
                Dim pessoa As New Pessoa
                pessoa.id_pessoa = Convert.ToInt32(Me.hf_id_produtor.Value)

                Dim dspropriedades As DataSet = pessoa.getPropriedadesProdutoresEGrupo()
                If (dspropriedades.Tables(0).Rows.Count <= 0) Then
                    Me.ViewState("gridpropriedadeslinhas") = 0
                    Dim dr As DataRow = dspropriedades.Tables(0).NewRow()
                    dspropriedades.Tables(0).Rows.InsertAt(dr, 0)
                    gridPropriedades.Visible = True
                    gridPropriedades.DataSource = Helper.getDataView(dspropriedades.Tables(0), "")
                    gridPropriedades.DataBind()
                    gridPropriedades.Rows(0).Cells.Clear()
                    gridPropriedades.Rows(0).Cells.Add(New TableCell())
                    gridPropriedades.Rows(0).Attributes.CssStyle.Add("text-align", "center")
                    gridPropriedades.Rows(0).Cells(0).ColumnSpan = 10
                    gridPropriedades.Rows(0).Cells(0).Text = "Não foram encontradas propriedades ativas para o produtor selecionado!"
                Else
                    lk_gerar_pedido.Enabled = True
                    'If (Not Microsoft.VisualBasic.CompilerServices.Operators.ConditionalCompareObjectEqual(DataSet.Tables(0).Rows(0)("id_propriedade_titular"), 0, False)) Then
                    '    Me.lbl_gruporelacionamento.set_Visible(True)
                    'Else
                    '    Me.lbl_gruporelacionamento.set_Visible(False)
                    'End If
                    ViewState("gridpropriedadeslinhas") = 1
                    gridPropriedades.Visible = True
                    gridPropriedades.DataSource = Helper.getDataView(dspropriedades.Tables(0), "")
                    gridPropriedades.DataBind()
                End If
            End If

        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try
    End Sub

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        Me.customPage = MenuTools.getInitialContext(HttpContext.Current, "frm_central_pedido_abertura_grupo.aspx")

        If Not Page.IsPostBack Then
            'FRAN 08/12/2020 i incluir log 
            Dim usuariolog As New UsuarioLog
            usuariolog.id_usuario = Session("id_login")
            usuariolog.ds_id_session = Session.SessionID.ToString()
            usuariolog.id_tipo_log = 2 'ACESSO
            usuariolog.id_menu_item = 233
            usuariolog.insertUsuarioLog()
            'FRAN 08/12/2020  incluir log 

            loadDetails()
        Else
            If (Me.txt_cd_pessoa.Text.Equals(String.Empty)) Then
                Me.gridPropriedades.Rows(0).Cells.Clear()
                Me.gridPropriedades.Rows(0).Cells.Add(New TableCell())
                Me.gridPropriedades.Rows(0).Attributes.CssStyle.Add("text-align", "center")
                Me.gridPropriedades.Rows(0).Cells(0).Text = "Informe um produtor para visualizar suas propriedades!"
                Me.gridPropriedades.Rows(0).Cells(0).ColumnSpan = 10
            End If

            'If ViewState.Item("gridLinhasAdicionadas") Is Nothing Then
            '    gridRomaneioCompartimento.Rows(0).Cells.Clear()
            '    gridRomaneioCompartimento.Rows(0).Cells.Add(New TableCell())
            '    gridRomaneioCompartimento.Rows(0).Attributes.CssStyle.Add("text-align", "center")
            '    gridRomaneioCompartimento.Rows(0).Cells(0).Text = "Não existe nenhuma Placa/Compartimento cadastrados!"
            '    gridRomaneioCompartimento.Rows(0).Cells(0).ColumnSpan = 7
            'End If
        End If
        With btn_lupa_produtor
            .Attributes.Add("onclick", "javascript:ShowDialogProdutor()")
            .ToolTip = "Filtrar Produtores"
        End With

    End Sub


    Protected Sub txt_cd_pessoa_TextChanged(ByVal sender As Object, ByVal e As EventArgs) Handles txt_cd_pessoa.TextChanged
        Me.lbl_nm_pessoa.Text = String.Empty
        Me.hf_id_pessoa.Value = String.Empty
        Me.lbl_ds_telefone.Text = String.Empty
        Me.lbl_acordo_aquisicao_insumos.Text = String.Empty
        Me.lbl_cluster.Text = String.Empty
        Me.lbl_ds_email.Text = String.Empty
        Me.lbl_contrato.Text = String.Empty
        Me.lbl_dt_ini_contrato.Text = String.Empty
        Me.lbl_dt_fim_contrato.Text = String.Empty
        Me.lbl_dt_rescisao_contrato.Text = String.Empty
        Try
            If (Me.txt_cd_pessoa.Text.Equals(String.Empty)) Then
                Me.lk_gerar_pedido.Enabled = False

                Dim pessoa As New Pessoa
                pessoa.id_pessoa = -1
                Dim dspropriedades As DataSet = pessoa.getPropriedadesProdutoresEGrupo()
                Dim dr As DataRow = dspropriedades.Tables(0).NewRow()
                dspropriedades.Tables(0).Rows.InsertAt(dr, 0)
                gridPropriedades.Visible = True
                gridPropriedades.DataSource = Helper.getDataView(dspropriedades.Tables(0), "")
                gridPropriedades.DataBind()
                gridPropriedades.Rows(0).Cells.Clear()
                gridPropriedades.Rows(0).Cells.Add(New TableCell())
                gridPropriedades.Rows(0).Attributes.CssStyle.Add("text-align", "center")
                gridPropriedades.Rows(0).Cells(0).ColumnSpan = 10
                gridPropriedades.Rows(0).Cells(0).Text = "Informe um produtor para visualizar suas propriedades!"
            Else
                Dim pessoa As New Pessoa
                pessoa.cd_pessoa = Me.txt_cd_pessoa.Text.Trim()
                pessoa.id_situacao = 1
                pessoa.id_grupo = 1

                Dim dspessoa As DataSet = pessoa.getPessoaByFilters()
                If (dspessoa.Tables(0).Rows.Count <= 0) Then
                    Me.lbl_nm_pessoa.Enabled = True
                    Me.lbl_nm_pessoa.Text = "Produtor não encontrado!"
                    Me.lk_gerar_pedido.Enabled = False

                    pessoa.id_pessoa = -1
                    Dim dspropriedades As DataSet = pessoa.getPropriedadesProdutoresEGrupo()
                    Dim dr As DataRow = dspropriedades.Tables(0).NewRow()
                    dspropriedades.Tables(0).Rows.InsertAt(dr, 0)
                    gridPropriedades.DataSource = Helper.getDataView(dspropriedades.Tables(0), "")
                    gridPropriedades.DataBind()
                    Me.gridPropriedades.Rows(0).Cells.Clear()
                    Me.gridPropriedades.Rows(0).Cells.Add(New TableCell())
                    Me.gridPropriedades.Rows(0).Attributes.CssStyle.Add("text-align", "center")
                    Me.gridPropriedades.Rows(0).Cells(0).Text = "Informe um produtor para visualizar suas propriedades!"
                    Me.gridPropriedades.Rows(0).Cells(0).ColumnSpan = 10
                Else
                    Me.lbl_nm_pessoa.Enabled = True
                    Me.lbl_nm_pessoa.Text = dspessoa.Tables(0).Rows(0)("nm_pessoa").ToString
                    Me.hf_id_produtor.Value = dspessoa.Tables(0).Rows(0)("id_pessoa").ToString
                    Me.loadDadosProdutor(Convert.ToInt32(Me.hf_id_produtor.Value))
                End If
            End If
        Catch ex As Exception
            Me.messageControl.Alert(ex.Message)
        End Try
    End Sub


    ' Private Function ValidarItensFornecedores(ByRef lmsg As String) As Boolean
    '     Dim flag As Boolean = False
    '     Dim enumerator As IEnumerator = Nothing
    '     Dim enumerator1 As IEnumerator = Nothing
    '     Try
    '         Dim cotacaoItem As Danone.MilkSystem.Business.CotacaoItem = New Danone.MilkSystem.Business.CotacaoItem()
    '         Dim cotacaoFornecedor As Danone.MilkSystem.Business.CotacaoFornecedor = New Danone.MilkSystem.Business.CotacaoFornecedor()
    '         cotacaoItem.id_central_cotacao = Convert.ToInt32(Me.ViewState("id_central_cotacao").ToString())
    '         Dim cotacaoItensByFilters As DataSet = cotacaoItem.getCotacaoItensByFilters()
    '         Dim flag1 As Boolean = False
    '         Dim parametro As Danone.MilkSystem.Business.Parametro = New Danone.MilkSystem.Business.Parametro()
    '         Dim flag2 As Boolean = True
    '         Try
    '             enumerator = cotacaoItensByFilters.Tables(0).Rows.GetEnumerator()
    '             While enumerator.MoveNext()
    '                 Dim current As System.Data.DataRow = DirectCast(enumerator.Current, System.Data.DataRow)
    '                 If (Not Microsoft.VisualBasic.CompilerServices.Operators.ConditionalCompareObjectEqual(current("st_ver_mercado"), "N", False)) Then
    '                     Continue While
    '                 End If
    '                 flag1 = True
    '                 If (Conversions.ToDouble(current("nr_quantidade")) <> 0) Then
    '                     cotacaoFornecedor.id_central_cotacao_item = Convert.ToInt32(RuntimeHelpers.GetObjectValue(current("id_central_cotacao_item")))
    '                     Dim cotacaoFornecedorByFilters As DataSet = cotacaoFornecedor.getCotacaoFornecedorByFilters()
    '                     Try
    '                         enumerator1 = cotacaoFornecedorByFilters.Tables(0).Rows.GetEnumerator()
    '                         While enumerator1.MoveNext()
    '                             Dim dataRow As System.Data.DataRow = DirectCast(enumerator1.Current, System.Data.DataRow)
    '                             If (Conversions.ToDouble(dataRow("nr_valor_unitario")) > 0) Then
    '                                 Continue While
    '                             End If
    '                             flag2 = False
    '                             lmsg = String.Concat("Há cotações para o item ", current("nm_item").ToString(), " cujo cadastro está incompleto!")
    '                             Exit While
    '                         End While
    '                     Finally
    '                         If (TypeOf enumerator1 Is IDisposable) Then
    '                             TryCast(enumerator1, IDisposable).Dispose()
    '                         End If
    '                     End Try
    '                     If (flag2) Then
    '                         If (Microsoft.VisualBasic.CompilerServices.Operators.ConditionalCompareObjectEqual(current("st_parcelamento"), "D", False) AndAlso parametro.nr_politica_parcelas < Conversions.ToInteger(current("nr_parcelas").ToString())) Then
    '                             flag2 = False
    '                             lmsg = String.Concat("O número de parcelas informado para o item ", current("nm_item").ToString(), ", execede o limite cadastrado para Política de Parcelas em Parâmetros do Sistema.")
    '                         End If
    '                         cotacaoFornecedor.st_selecionado = "S"
    '                         cotacaoFornecedor.st_ver_mercado = "N"
    '                         If (cotacaoFornecedor.getCotacaoFornecedorByFilters().Tables(0).Rows.Count <> 0) Then
    '                             Continue While
    '                         End If
    '                         flag2 = False
    '                         lmsg = String.Concat("Não há cotação selecionada para o item ", current("nm_item").ToString(), ".")
    '                         Exit While
    '                     Else
    '                         Exit While
    '                     End If
    '                 Else
    '                     flag2 = False
    '                     lmsg = "Há itens da cotação cujo cadastro está incompleto!"
    '                     Exit While
    '                 End If
    '             End While
    '         Finally
    '             If (TypeOf enumerator Is IDisposable) Then
    '                 TryCast(enumerator, IDisposable).Dispose()
    '             End If
    '         End Try
    '         If (Not flag1) Then
    '             flag2 = False
    '             lmsg = "Todos os itens desta cotação são do tipo 'Ver Mercado'. Este tipo de cotação não pode gerar aprovação ou pedido."
    '         End If
    'flag = If(Not flag2, False, True)
    '     Catch exception As System.Exception
    '         ProjectData.SetProjectError(exception)
    '         Me.messageControl.Alert(exception.Message)
    '         ProjectData.ClearProjectError()
    '     End Try
    '     Return flag
    ' End Function

    Private Function VerificarCotacao() As Boolean
        Dim flag As Boolean = False
        Dim str As String = Nothing
        Dim enumerator As IEnumerator = Nothing
        Dim enumerator1 As IEnumerator = Nothing
        Try
            Dim cotacaoItem As Danone.MilkSystem.Business.CotacaoItem = New Danone.MilkSystem.Business.CotacaoItem()
            Dim cotacaoFornecedor As Danone.MilkSystem.Business.CotacaoFornecedor = New Danone.MilkSystem.Business.CotacaoFornecedor()
            Dim cotacaoItensByFilters As DataSet = cotacaoItem.getCotacaoItensByFilters()
            Dim flag1 As Boolean = True
            Try
                enumerator = cotacaoItensByFilters.Tables(0).Rows.GetEnumerator()
                While enumerator.MoveNext()
                    Dim current As System.Data.DataRow = DirectCast(enumerator.Current, System.Data.DataRow)
                    If (Not Microsoft.VisualBasic.CompilerServices.Operators.ConditionalCompareObjectEqual(current("st_ver_mercado"), "N", False)) Then
                        Continue While
                    End If
                    If (Convert.ToDouble(current("nr_quantidade")) <> 0) Then
                        cotacaoFornecedor.id_central_cotacao_item = Convert.ToInt32((current("id_central_cotacao_item")))
                        Dim cotacaoFornecedorByFilters As DataSet = cotacaoFornecedor.getCotacaoFornecedorByFilters()
                        Try
                            enumerator1 = cotacaoFornecedorByFilters.Tables(0).Rows.GetEnumerator()
                            While enumerator1.MoveNext()
                                Dim dataRow As System.Data.DataRow = DirectCast(enumerator1.Current, System.Data.DataRow)
                                If (Convert.ToDouble(dataRow("nr_valor_unitario")) > 0) Then
                                    Continue While
                                End If
                                flag1 = False
                                str = String.Concat("Há cotações para o item ", current("nm_item").ToString(), " cujo cadastro está incompleto!")
                                Exit While
                            End While
                        Finally
                            If (TypeOf enumerator1 Is IDisposable) Then
                                TryCast(enumerator1, IDisposable).Dispose()
                            End If
                        End Try
                        If (flag1) Then
                            cotacaoFornecedor.st_selecionado = "S"
                            cotacaoFornecedor.st_ver_mercado = "N"
                            If (cotacaoFornecedor.getCotacaoFornecedorByFilters().Tables(0).Rows.Count <> 0) Then
                                Continue While
                            End If
                            flag1 = False
                            str = String.Concat("Não há cotação selecionada para o item ", current("nm_item").ToString(), ".")
                            Exit While
                        Else
                            Exit While
                        End If
                    Else
                        flag1 = False
                        str = "Há itens da cotação cujo cadastro está incompleto!"
                        Exit While
                    End If
                End While
            Finally
                If (TypeOf enumerator Is IDisposable) Then
                    TryCast(enumerator, IDisposable).Dispose()
                End If
            End Try
            If (flag1) Then
                flag = True
            Else
                flag = False
                Me.messageControl.Alert(str)
            End If
        Catch exception As System.Exception
            Me.messageControl.Alert(exception.Message)
        End Try
        Return flag
    End Function
    Protected Sub btn_lupa_produtor_Click(ByVal sender As Object, ByVal e As ImageClickEventArgs) Handles btn_lupa_produtor.Click
        Me.lbl_nm_pessoa.Visible = True
        Me.carregarCamposProdutor()
    End Sub


    Protected Sub cbo_estabelecimento_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles cbo_estabelecimento.SelectedIndexChanged

        Try
            txt_nm_fornecedor.Text = String.Empty
            ViewState.Item("id_fornecedor") = "0"

            If cbo_estabelecimento.SelectedValue > 0 Then
                txt_nm_fornecedor.Enabled = True
                ViewState.Item("id_estabelecimento") = cbo_estabelecimento.SelectedValue
                loadComboParceiro(String.Empty)
            Else
                ViewState.Item("id_estabelecimento") = "0"
                cbo_fornecedor.Items.Clear()
                cbo_fornecedor.Items.Insert(0, New ListItem("[Selecione um Estabelecimento]", "0"))
                cbo_fornecedor.SelectedValue = 0
                txt_nm_fornecedor.Enabled = False

            End If

        Catch ex As Exception
            messageControl.Alert(ex.Message)

        End Try
    End Sub

    Protected Sub cbo_fornecedor_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles cbo_fornecedor.SelectedIndexChanged
        Try

            lbl_detalhe_item_frete.Text = String.Empty
            gridfrete.Visible = False
            ViewState.Item("id_item") = "0"

            If cbo_fornecedor.SelectedValue > 0 Then

                'txt_nm_fornecedor.Text = String.Empty
                'loadComboParceiro(String.Empty, cbo_fornecedor.SelectedValue)

                ViewState.Item("id_fornecedor") = cbo_fornecedor.SelectedValue

                Dim parceiroitem As New ItemParceiro
                parceiroitem.id_fornecedor = cbo_fornecedor.SelectedValue
                parceiroitem.st_acordo_aquisicao_insumos = "S"

                Dim dsparceiro As DataSet = parceiroitem.getCentralParceiroComItens

                If (dsparceiro.Tables(0).Rows.Count > 0) Then
                    With dsparceiro.Tables(0).Rows(0)
                        ViewState.Item("fornecedor_excecao_prazo") = .Item("st_excecao_prazo_pagto").ToString
                        ViewState.Item("fornecedor_cif") = .Item("st_fornecedor_cif").ToString
                        ViewState.Item("fornecedor_parcelas") = .Item("nr_fornecedor_parcelas_central").ToString
                        If .Item("st_fornecedor_cif").ToString.Equals("S") Then
                            lbl_frete_parceiro.Text = "SIM"
                        Else
                            lbl_frete_parceiro.Text = "NÃO"
                        End If
                        lbl_parcelas_parceiro.Text = .Item("nr_fornecedor_parcelas_central").ToString
                    End With
                End If

                If ViewState.Item("fornecedor_cif").ToString = "S" Then
                    cbo_tipo_frete.Items(1).Enabled = False
                    cbo_tipo_frete.Items(2).Enabled = False
                    cbo_tipo_frete.SelectedValue = String.Empty
                Else
                    cbo_tipo_frete.Items(1).Enabled = True
                    cbo_tipo_frete.Items(2).Enabled = True
                    cbo_tipo_frete.SelectedValue = String.Empty

                End If

                txt_nm_item.Text = "[Filtre Nome Item]"
                lbl_nm_categoria.Text = String.Empty

                loadComboItens(String.Empty)
            Else
                ViewState.Item("fornecedor_excecao_prazo") = String.Empty
                ViewState.Item("fornecedor_cif") = String.Empty
                ViewState.Item("fornecedor_parcelas") = String.Empty
                lbl_frete_parceiro.Text = String.Empty
                lbl_parcelas_parceiro.Text = String.Empty

                cbo_item.Items.Clear()
                cbo_item.Items.Insert(0, New ListItem("[Selecione um Parceiro]", "0"))
                cbo_item.SelectedValue = 0
                txt_nm_item.Text = String.Empty
                lbl_nm_categoria.Text = String.Empty
                txt_nm_item.Enabled = False

                'loadComboParceiro(String.Empty)
            End If



        Catch ex As Exception
            messageControl.Alert(ex.Message)

        End Try
    End Sub

    Protected Sub txt_nm_fornecedor_TextChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles txt_nm_fornecedor.TextChanged
        Try
            If cbo_estabelecimento.SelectedValue > 0 Then
                loadComboParceiro(txt_nm_fornecedor.Text)
            Else
                txt_nm_fornecedor.Text = "[Filtre Nome Parceiro]"

            End If

        Catch ex As Exception
            messageControl.Alert(ex.Message)

        End Try
    End Sub

    Protected Sub txt_nm_item_TextChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles txt_nm_item.TextChanged
        Try
            If ViewState.Item("id_fornecedor") > 0 Then
                loadComboItens(txt_nm_item.Text)
            Else
                txt_nm_item.Text = "[Filtre Nome Item]"
            End If
        Catch ex As Exception
            messageControl.Alert(ex.Message)

        End Try
    End Sub

    Protected Sub cbo_item_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles cbo_item.SelectedIndexChanged


        Try

            If CInt(cbo_item.SelectedValue) > 0 Then

                Dim item As New Item
                item.id_item = cbo_item.SelectedValue

                Dim dsitem As DataSet = item.getItensCentralByFilters

                If (dsitem.Tables(0).Rows.Count > 0) Then
                    With dsitem.Tables(0).Rows(0)
                        lbl_nm_categoria.Text = .Item("nm_categoria_item").ToString
                        lbl_nm_categoria_tit.Visible = True
                        ViewState.Item("id_categoria_item") = .Item("id_categoria_item").ToString

                    End With
                End If
            Else
                lbl_nm_categoria.Text = String.Empty
                lbl_nm_categoria_tit.Visible = False
                ViewState.Item("id_categoria_item") = "0"
            End If



        Catch ex As Exception
            messageControl.Alert(ex.Message)

        End Try

    End Sub


    Protected Sub cbo_tipo_medida_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs)
        Dim wc As WebControl = CType(sender, WebControl)
        Dim row As GridViewRow = CType(wc.NamingContainer, GridViewRow)
        Dim txt_nr_qtde As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_qtde"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
        Dim lbl_total_item As Anthem.Label = CType(row.FindControl("lbl_total_item"), Anthem.Label)
        Dim lbl_total_frete As Anthem.Label = CType(row.FindControl("lbl_total_frete"), Anthem.Label)
        Dim lbl_valor_total As Anthem.Label = CType(row.FindControl("lbl_valor_total"), Anthem.Label)

        Dim cbo_tipo_medida As Anthem.DropDownList = CType(row.FindControl("cbo_tipo_medida"), Anthem.DropDownList)

        'se tem tipo de medida
        'se selecione
        If cbo_tipo_medida.SelectedValue.Equals(String.Empty) Then
            'se tem tabela de precos
            lbl_total_item.Text = String.Empty
            lbl_total_frete.Text = String.Empty
            lbl_valor_total.Text = String.Empty
        Else
            'se tem informaçao de valor unitario e qtde 
            If Not txt_nr_valor_unitario.Text.Equals(String.Empty) AndAlso Not txt_nr_qtde.Text.Equals(String.Empty) Then

                atualizarGridRowTotalizadores(row.RowIndex)

            End If

        End If

        txt_nr_qtde.Focus()
    End Sub
    Private Sub atualizarGridRowTotalizadores(ByVal id_index_row As Int32)

        Try

            Dim row As GridViewRow = gridResults.Rows.Item(id_index_row)


            Dim cbo_tipo_medida As Anthem.DropDownList = CType(row.FindControl("cbo_tipo_medida"), Anthem.DropDownList)
            Dim txt_nr_qtde As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_qtde"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
            Dim txt_nr_frete As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_frete"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
            Dim lbl_total_item As Anthem.Label = CType(row.FindControl("lbl_total_item"), Anthem.Label)
            Dim lbl_total_frete As Anthem.Label = CType(row.FindControl("lbl_total_frete"), Anthem.Label)
            Dim lbl_valor_total As Anthem.Label = CType(row.FindControl("lbl_valor_total"), Anthem.Label)
            Dim laux As Decimal

            If cbo_tipo_medida.SelectedValue = "S" Then
                If txt_nr_sacaria.Text = String.Empty Then
                    laux = 0
                Else
                    laux = CDec(txt_nr_sacaria.Text)
                End If
            Else
                laux = 0
            End If

            'se tem quantidade e valor unitario
            If Not txt_nr_qtde.Text.Equals(String.Empty) AndAlso Not txt_nr_valor_unitario.Text.Equals(String.Empty) Then
                lbl_total_item.Text = FormatCurrency(((CDec(txt_nr_valor_unitario.Text) + laux) * CDec(txt_nr_qtde.Text)).ToString, 2).ToString()
            Else
                lbl_total_item.Text = FormatCurrency("0", 2)
            End If
            lbl_valor_total.Text = lbl_total_item.Text

            If cbo_tipo_frete.SelectedValue = "D" Then 'se for fob d
                'se tem quantidade e valor frete
                If Not txt_nr_qtde.Text.Equals(String.Empty) AndAlso Not txt_nr_frete.Text.Equals(String.Empty) Then
                    lbl_total_frete.Text = FormatCurrency((CDec(txt_nr_frete.Text) * CDec(txt_nr_qtde.Text)).ToString, 2).ToString()
                Else
                    lbl_total_frete.Text = FormatCurrency("0", 2).ToString
                End If

                lbl_valor_total.Text = (CDec(lbl_valor_total.Text) + CDec(lbl_total_frete.Text)).ToString
            End If
            lbl_valor_total.Text = FormatCurrency(CDec(lbl_valor_total.Text), 2).ToString



        Catch ex As Exception
            messageControl.Alert(ex.Message)
        End Try

    End Sub
    Private Sub atualizarGridTotalizadores()
        Dim row As GridViewRow

        Dim lnrqtdegrid As Decimal = 0
        Dim lnrvlunitario As Decimal = 0
        Dim lnrsacaria As Decimal = 0
        Dim lnrfretegrid As Decimal = 0
        Dim lnrfretegeral As Decimal = 0
        Dim lnrtotalitem As Decimal = 0
        Dim lnrtotalfrete As Decimal = 0
        Dim lnrtotal As Decimal = 0
        Dim lnrqtdeincluida As Decimal = 0
        Dim lnr_qtde_total As Decimal = 0

        If txt_nr_valor_unitario.Text.Equals(String.Empty) Then
            lnrvlunitario = 0
        Else
            lnrvlunitario = CDec(txt_nr_valor_unitario.Text)
        End If
        If txt_nr_sacaria.Text.Equals(String.Empty) Then
            lnrsacaria = 0
        Else
            lnrsacaria = CDec(txt_nr_sacaria.Text)
        End If
        If txt_nr_frete_geral.Text.Equals(String.Empty) Then
            lnrfretegeral = 0
        Else
            lnrfretegeral = CDec(txt_nr_frete_geral.Text)
        End If
        If txt_nr_qtde_total.Text.Equals(String.Empty) Then
            lnr_qtde_total = 0
        Else
            lnr_qtde_total = CDec(txt_nr_qtde_total.Text)
        End If

        For Each row In gridResults.Rows
            If row.Visible = True Then
                Dim cbo_tipo_medida As Anthem.DropDownList = CType(row.FindControl("cbo_tipo_medida"), Anthem.DropDownList)
                Dim txt_nr_qtde As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_qtde"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
                Dim lbl_total_item As Anthem.Label = CType(row.FindControl("lbl_total_item"), Anthem.Label)
                Dim cbo_transportador As Anthem.DropDownList = CType(row.FindControl("cbo_transportador"), Anthem.DropDownList)
                Dim txt_nr_frete As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_frete"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
                Dim lbl_total_frete As Anthem.Label = CType(row.FindControl("lbl_total_frete"), Anthem.Label)
                Dim lbl_valor_total As Anthem.Label = CType(row.FindControl("lbl_valor_total"), Anthem.Label)

                'inicializa valores do grid
                If txt_nr_qtde.Text.Equals(String.Empty) Then
                    lnrqtdegrid = 0
                Else
                    lnrqtdegrid = CDec(txt_nr_qtde.Text)
                End If

                'se for fob-d tem frete
                If cbo_tipo_frete.SelectedValue = "D" Then
                    If txt_nr_frete.Text.Equals(String.Empty) Then
                        lnrfretegrid = 0
                    Else
                        lnrfretegrid = CDec(txt_nr_frete.Text)
                    End If
                Else
                    lnrfretegrid = 0
                End If

                'Faz somatorio linha a linha da qtde incluida
                lnrqtdeincluida = lnrqtdeincluida + lnrqtdegrid

                If lnrqtdegrid = 0 Then
                    lnrtotalitem = 0
                    lnrtotalfrete = 0
                    lnrtotal = 0
                Else
                    If cbo_tipo_medida.SelectedValue = "S" Then
                        lnrtotalitem = (lnrvlunitario + lnrsacaria) * lnrqtdegrid
                    Else
                        lnrtotalitem = lnrvlunitario * lnrqtdegrid
                    End If

                    'se for fob-d tem frete
                    If cbo_tipo_frete.SelectedValue = "D" Then
                        lnrtotalfrete = lnrvlunitario * lnrqtdegrid
                    Else
                        lnrtotalfrete = 0
                    End If

                    lnrtotal = lnrtotalitem + lnrtotalfrete

                    'atualiza campos da tela
                    lbl_total_item.Text = FormatCurrency(lnrtotalitem, 2).ToString
                    If cbo_tipo_frete.SelectedValue = "D" Then 'se for fob d
                        lbl_total_frete.Text = FormatCurrency(lnrtotalfrete, 2).ToString
                    End If
                    lbl_valor_total.Text = FormatCurrency(lnrtotal, 2).ToString

                End If
            End If
        Next
        'atualiza quantidade incluida da tela
        If lnrqtdeincluida = 0 Then
            lbl_qtde_incluida.Text = String.Empty
        Else
            lbl_qtde_incluida.Text = FormatNumber(lnrqtdeincluida, 4).ToString
            If lnr_qtde_total > lnrqtdeincluida Then
                lbl_qtde_incluida.ForeColor = Drawing.Color.Blue
            End If
            If lnrqtdeincluida > lnr_qtde_total Then
                lbl_qtde_incluida.ForeColor = Drawing.Color.Red
            End If
        End If

 

    End Sub

    Protected Sub btn_lupa_preco_Click(ByVal sender As Object, ByVal e As System.Web.UI.ImageClickEventArgs)

        Dim wc As WebControl = CType(sender, WebControl)
        Dim row As GridViewRow = CType(wc.NamingContainer, GridViewRow)
        Dim txt_nr_qtde As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_qtde"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
        Dim txt_nr_valor_unitario As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_valor_unitario"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
        Dim txt_nr_sacaria As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_sacaria"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
        Dim lbl_total_item As Anthem.Label = CType(row.FindControl("lbl_total_item"), Anthem.Label)
        Dim lbl_total_frete As Anthem.Label = CType(row.FindControl("lbl_total_frete"), Anthem.Label)
        Dim lbl_valor_total As Anthem.Label = CType(row.FindControl("lbl_valor_total"), Anthem.Label)
        Dim lbl_id_central_tabela_precos As Label = CType(row.FindControl("lbl_id_central_tabela_precos"), Label)
        Dim lbl_nr_valor_tab_preco As Label = CType(row.FindControl("lbl_nr_valor_tab_preco"), Label)
        Dim lbl_nr_sacaria_tab_preco As Label = CType(row.FindControl("lbl_nr_sacaria_tab_preco"), Label)
        Dim lbl_inf_preco As Label = CType(row.FindControl("lbl_inf_preco"), Label)
        Dim lbl_dt_cotacao_preco As Label = CType(row.FindControl("lbl_dt_cotacao_preco"), Label)

        Dim cbo_tipo_medida As Anthem.DropDownList = CType(row.FindControl("cbo_tipo_medida"), Anthem.DropDownList)

        'se  tem tabela de preço 
        If Not lbl_id_central_tabela_precos.Text.Equals(String.Empty) Then
            txt_nr_valor_unitario.Text = lbl_nr_valor_tab_preco.Text
            txt_nr_sacaria.Text = lbl_nr_sacaria_tab_preco.Text
            lbl_inf_preco.Text = String.Concat("(Data cotação: ", DateTime.Parse(lbl_dt_cotacao_preco.Text).ToString("dd/MM/yyyy"), ")")

            If cbo_tipo_medida.SelectedValue = "S" Then
                txt_nr_sacaria.Enabled = True
            Else
                txt_nr_sacaria.Enabled = False
                txt_nr_sacaria.Text = String.Empty

            End If

        Else
            txt_nr_valor_unitario.Text = String.Empty
            txt_nr_sacaria.Text = String.Empty
            lbl_inf_preco.Text = String.Empty
        End If

        atualizarGridRowTotalizadores(row.RowIndex)

    End Sub


    Protected Sub btn_lupa_frete_valor_Click(ByVal sender As Object, ByVal e As System.Web.UI.ImageClickEventArgs)
        Dim wc As WebControl = CType(sender, WebControl)
        Dim row As GridViewRow = CType(wc.NamingContainer, GridViewRow)
        Dim cbo_transportador As Anthem.DropDownList = CType(row.FindControl("cbo_transportador"), Anthem.DropDownList)
        Dim lbl_id_propriedade As Label = CType(row.FindControl("lbl_id_propriedade"), System.Web.UI.WebControls.Label)
        Dim lbl_id_estado_destino As Label = CType(row.FindControl("lbl_id_estado_destino"), System.Web.UI.WebControls.Label)
        Dim lbl_id_cidade_destino As Label = CType(row.FindControl("lbl_id_cidade_destino"), System.Web.UI.WebControls.Label)

        pnl_frete.Visible = False

        If cbo_transportador.SelectedValue = "0" Then
            Me.messageControl.Alert("Transportador deve ser selecionado para a busca da tabela de fretes.")
        Else
            If cbo_item.SelectedValue = "0" Then
                Me.messageControl.Alert("Item deve ser selecionado para a busca da tabela de fretes.")
            Else
                pnl_frete.Visible = True
                lbl_detalhe_item_frete.Text = String.Concat("Frete para o ITEM ", cbo_item.SelectedItem.Text, ", Transportador: ", cbo_transportador.SelectedItem.Text.ToUpper, " e Propriedade ", lbl_id_propriedade.Text)

                Dim tabfrete As New TabelaFrete
                tabfrete.id_estabelecimento = ViewState.Item("id_estabelecimento")
                tabfrete.id_fornecedor = cbo_transportador.SelectedValue
                tabfrete.id_item = cbo_item.SelectedValue
                tabfrete.id_estado_propriedade = lbl_id_estado_destino.Text
                tabfrete.id_cidade_propriedade = lbl_id_cidade_destino.Text

                Dim dsfrete As DataSet = tabfrete.getCentralTabelaFreteMax()
                If (dsfrete.Tables(0).Rows.Count <= 0) Then
                    Me.messageControl.Alert("Não foram encontrados valores de frete ativos para o Transportador, item e cidade destino da propriedade!")

                    'Dim dr As DataRow = dsfrete.Tables(0).NewRow()
                    'dsfrete.Tables(0).Rows.InsertAt(dr, 0)
                    'gridfrete.Visible = True
                    'gridfrete.DataSource = Helper.getDataView(dsfrete.Tables(0), "")
                    'gridfrete.DataBind()
                    'gridfrete.Rows(0).Cells.Clear()
                    'gridfrete.Rows(0).Cells.Add(New TableCell())
                    'gridfrete.Rows(0).Attributes.CssStyle.Add("text-align", "center")
                    'gridfrete.Rows(0).Cells(0).ColumnSpan = 10
                    'gridfrete.Rows(0).Cells(0).Text = "Não foram encontrados valores de frete ativos para o Transportador, item e cidade destino da propriedade!"
                Else
                    pnl_frete.Visible = True
                    lbl_detalhe_item_frete.Text = String.Concat("Frete para o ITEM ", cbo_item.SelectedItem.Text, ", Transportador: ", cbo_transportador.SelectedItem.Text.ToUpper, " e Propriedade ", lbl_id_propriedade.Text)

                    ViewState.Item("id_index_item_frete") = row.RowIndex

                    gridfrete.Visible = True
                    gridfrete.DataSource = Helper.getDataView(dsfrete.Tables(0), "")
                    gridfrete.DataBind()
                End If

            End If

        End If
    End Sub
    Protected Sub txt_nr_valor_unitario_TextChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles txt_nr_valor_unitario.TextChanged
        If (Me.ViewState("gridLinhasAdicionadas") IsNot Nothing) Then
            atualizarGridTotalizadores()
        End If
    End Sub


    Protected Sub cbo_vai_parcelar_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs)
        Dim wc As WebControl = CType(sender, WebControl)
        Dim row As GridViewRow = CType(wc.NamingContainer, GridViewRow)
        Dim cbo_vai_parcelar As Anthem.DropDownList = CType(row.FindControl("cbo_vai_parcelar"), Anthem.DropDownList)
        Dim rfv_nr_parcelas As Anthem.RequiredFieldValidator = CType(row.FindControl("rfv_nr_parcelas"), Anthem.RequiredFieldValidator)
        Dim rv_parcelas As Anthem.RangeValidator = CType(row.FindControl("rv_parcelas"), Anthem.RangeValidator)
        Dim cv_nr_parcelas As Anthem.CompareValidator = CType(row.FindControl("cv_nr_parcelas"), Anthem.CompareValidator)
        Dim txt_nr_parcelas As RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox = CType(row.FindControl("txt_nr_parcelas"), RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox)

        Select Case cbo_vai_parcelar.SelectedValue

            Case "N"
                txt_nr_parcelas.Enabled = False
                txt_nr_parcelas.Text = 1
                rfv_nr_parcelas.Enabled = False
                rv_parcelas.Enabled = False
                cv_nr_parcelas.Enabled = False

            Case "P"
                txt_nr_parcelas.Text = String.Empty
                txt_nr_parcelas.Enabled = True
                rfv_nr_parcelas.Enabled = True
                cv_nr_parcelas.Enabled = True
                rv_parcelas.Enabled = False

            Case "D"
                txt_nr_parcelas.Enabled = True
                rfv_nr_parcelas.Enabled = True
                cv_nr_parcelas.Enabled = True
                txt_nr_parcelas.Text = String.Empty
                rv_parcelas.Enabled = True
                rv_parcelas.MaximumValue = Me.ViewState("nr_politica_parcelas").ToString()
                rv_parcelas.ErrorMessage = String.Concat("Para tipo de Pagamento 'Danone' o parcelamento deve ser no máximo de ", Me.ViewState("nr_politica_parcelas").ToString(), " parcelas, de acordo com a Política de Parcelas.")
                rv_parcelas.ToolTip = String.Concat("Para tipo de Pagamento 'Danone' o parcelamento deve ser no máximo de ", Me.ViewState("nr_politica_parcelas").ToString(), " parcelas, de acordo com a Política de Parcelas.")

        End Select

    End Sub
 
    Protected Sub btn_atualizar_totais_Click(ByVal sender As Object, ByVal e As System.Web.UI.ImageClickEventArgs)
        Dim wc As WebControl = CType(sender, WebControl)
        Dim row As GridViewRow = CType(wc.NamingContainer, GridViewRow)


        atualizarGridRowTotalizadores(row.RowIndex)


    End Sub

    Protected Sub img_selecionar_Click(ByVal sender As Object, ByVal e As System.Web.UI.ImageClickEventArgs)

        Dim wc As WebControl = CType(sender, WebControl)
        Dim row As GridViewRow = CType(wc.NamingContainer, GridViewRow)

        Dim rowitem As GridViewRow = gridResults.Rows.Item(ViewState.Item("id_index_item_frete"))
        Dim cbo_transportador As Anthem.DropDownList = CType(rowitem.FindControl("cbo_transportador"), Anthem.DropDownList)
        Dim txt_nr_frete As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(rowitem.FindControl("txt_nr_frete"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
        Dim lbl_tipo_caminhao As Anthem.Label = CType(rowitem.FindControl("lbl_tipo_caminhao"), Anthem.Label)
        Dim lbl_total_item As Anthem.Label = CType(rowitem.FindControl("lbl_total_item"), Anthem.Label)
        Dim lbl_total_frete As Anthem.Label = CType(rowitem.FindControl("lbl_total_frete"), Anthem.Label)
        Dim lbl_valor_total As Anthem.Label = CType(rowitem.FindControl("lbl_valor_total"), Anthem.Label)
        Dim lbl_id_central_tabela_frete_veiculos As Label = CType(rowitem.FindControl("lbl_id_central_tabela_frete_veiculos"), System.Web.UI.WebControls.Label)
        Dim lbl_id_central_tabela_precos As Label = CType(rowitem.FindControl("lbl_id_central_tabela_precos"), System.Web.UI.WebControls.Label)
        Dim lbl_id_veiculo_central_compras As Label = CType(rowitem.FindControl("lbl_id_veiculo_central_compras"), System.Web.UI.WebControls.Label)
        Dim lbl_inf_frete As Label = CType(rowitem.FindControl("lbl_inf_frete"), Label)

        Dim tabelafrete As New TabelaFreteVeiculos
        tabelafrete.id_central_tabela_frete_veiculos = gridfrete.DataKeys(row.RowIndex).Value.ToString()

        Dim dsfrete As DataSet = tabelafrete.getCentralTabelaFreteVeiculos
        With dsfrete.Tables(0).Rows(0)
            txt_nr_frete.Text = .Item("nr_valor_frete").ToString
            lbl_inf_frete.Text = String.Concat("(Data cotação: ", DateTime.Parse(.Item("dt_modificacao").ToString).ToString("dd/MM/yyyy"), ")")
            lbl_tipo_caminhao.Text = .Item("nm_veiculocentralcompras").ToString
            lbl_id_central_tabela_frete_veiculos.Text = .Item("id_central_tabela_frete_veiculos").ToString
            lbl_id_veiculo_central_compras.Text = .Item("id_veiculocentralcompras").ToString
        End With

        gridfrete.Visible = False
        pnl_frete.Visible = False

    End Sub

    Protected Sub btn_fechar_Click(ByVal sender As Object, ByVal e As System.Web.UI.ImageClickEventArgs) Handles btn_fechar.Click
        Me.pnl_frete.Visible = False

        ViewState.Item("id_index_item_frete") = String.Empty

    End Sub

    Protected Sub cv_pedido_itens_ServerValidate(ByVal source As Object, ByVal args As System.Web.UI.WebControls.ServerValidateEventArgs) Handles cv_pedido_itens.ServerValidate
        Try
            args.IsValid = True

            Dim lmsg As String
            Dim row As GridViewRow



            If ViewState.Item("id_fornecedor").ToString.Trim = "0" Then
                args.IsValid = False
                lmsg = "O parceiro deve ser informado para prosseguir com a inclusão do pedido."
            Else
                If cbo_tipo_frete.SelectedValue.Equals(String.Empty) Then
                    args.IsValid = False
                    lmsg = "O Tipo do Frete deve ser informado para prosseguir com a inclusão do pedido."
                Else
                    If cbo_item.SelectedValue.Equals("0") Then
                        lmsg = "O item de insumo deve ser informado para prosseguir com a inclusão do pedido."
                        args.IsValid = False
                    Else
                        'verifica se o item esta associado ao parceiro
                        Dim itemparceiro As New ItemParceiro
                        itemparceiro.id_item = cbo_item.SelectedValue
                        itemparceiro.id_fornecedor = ViewState.Item("id_fornecedor")

                        If itemparceiro.getCentralItemParceiro.Tables(0).Rows.Count = 0 Then
                            lmsg = "O Fornecedor informado não está associado ao Item " + cbo_item.SelectedItem.Text + "."
                            args.IsValid = False
                        End If

                    End If
                End If
            End If

            If args.IsValid Then

                If txt_nr_valor_unitario.Text.Equals(String.Empty) OrElse CDec(txt_nr_valor_unitario.Text) = 0 Then
                    lmsg = "O valor unitário deve ser informado para o Itemprosseguir com a inclusão do pedido."
                    args.IsValid = False
                End If

            End If
            Dim bitemincluido As Boolean = False

            If args.IsValid = True Then

                For Each row In gridResults.Rows
                    'se linha visivel
                    If row.Visible = True Then
                        Dim txt_nr_frete As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_frete"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
                        Dim txt_nr_qtde As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_qtde"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
                        Dim lbl_id_propriedade As Label = CType(row.FindControl("lbl_id_propriedade_grid"), System.Web.UI.WebControls.Label)
                        Dim cbo_vai_parcelar As Anthem.DropDownList = CType(row.FindControl("cbo_vai_parcelar"), Anthem.DropDownList)
                        Dim txt_nr_parcelas As RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox = CType(row.FindControl("txt_nr_parcelas"), RK.TextBox.AjaxOnlyNumbers.OnlyNumbersTextBox)

                        bitemincluido = True
                        If cbo_vai_parcelar.SelectedValue = "D" AndAlso CInt(ViewState.Item("nr_politica_parcelas")) < txt_nr_parcelas.Text Then
                            lmsg = String.Concat("O número de parcelas informado para a Propriedade ", lbl_id_propriedade.Text, " execede o limite cadastrado para Política de Parcelas em Parâmetros do Sistema.")
                            args.IsValid = False
                        End If

                        If cbo_tipo_frete.SelectedValue = "D" Then 'se for fob-d tem frete
                            If CInt(CType(row.FindControl("cbo_transportador"), Anthem.DropDownList).SelectedValue) = 0 Then
                                lmsg = "O Transportador deve ser informado para o tipo de frete FOB-D " + " da Propriedade " + lbl_id_propriedade.Text + "."
                                args.IsValid = False
                            End If

                            If txt_nr_frete.Text.Equals(String.Empty) OrElse CDec(txt_nr_frete.Text) = 0 Then
                                lmsg = "O Valor do Frete deve ser informado para o tipo de frete FOB-D " + " da Propriedade " + lbl_id_propriedade.Text + "."
                                args.IsValid = False
                            End If
                        End If
                        If CType(row.FindControl("cbo_tipo_medida"), Anthem.DropDownList).SelectedValue = "S" Then
                            If txt_nr_sacaria.Text.Equals(String.Empty) OrElse CDec(txt_nr_sacaria.Text) = 0 Then
                                lmsg = "O valor da Sacaria deve ser informado para Embalagem Sacaria " + " da Propriedade " + lbl_id_propriedade.Text + "."
                                args.IsValid = False
                            End If

                        End If
                        If txt_nr_qtde.Text.Equals(String.Empty) OrElse CDec(txt_nr_qtde.Text) = 0 Then
                            lmsg = "A quantidade deve ser informada para a Propriedade " + lbl_id_propriedade.Text + "."
                            args.IsValid = False
                        End If

                    End If

                Next

            End If

            If bitemincluido = False Then
                lmsg = "Adicione item ao pedido para prosseguir com a inclusão do pedido."
                args.IsValid = False

            End If


            If args.IsValid = False Then
                Me.messageControl.Alert(lmsg)


            End If

        Catch ex As Exception
            Me.messageControl.Alert(ex.Message)
        End Try

    End Sub

    Protected Sub txt_nr_frete_TextChanged(ByVal sender As Object, ByVal e As System.EventArgs)
        Dim wc As WebControl = CType(sender, WebControl)
        Dim row As GridViewRow = CType(wc.NamingContainer, GridViewRow)
        Dim cbo_transportador As Anthem.DropDownList = CType(row.FindControl("cbo_transportador"), Anthem.DropDownList)
        Dim txt_nr_frete As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_frete"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
        Dim lbl_tipo_caminhao As Anthem.Label = CType(row.FindControl("lbl_tipo_caminhao"), Anthem.Label)
        Dim lbl_total_item As Anthem.Label = CType(row.FindControl("lbl_total_item"), Anthem.Label)
        Dim lbl_total_frete As Anthem.Label = CType(row.FindControl("lbl_total_frete"), Anthem.Label)
        Dim lbl_valor_total As Anthem.Label = CType(row.FindControl("lbl_valor_total"), Anthem.Label)
        Dim lbl_id_central_tabela_frete_veiculos As Label = CType(row.FindControl("lbl_id_central_tabela_frete_veiculos"), System.Web.UI.WebControls.Label)
        Dim lbl_id_veiculo_central_compras As Label = CType(row.FindControl("lbl_id_veiculo_central_compras"), System.Web.UI.WebControls.Label)
        Dim lbl_inf_frete As Label = CType(row.FindControl("lbl_inf_frete"), Label)
        Dim btn_lupa_frete As Anthem.ImageButton = CType(row.FindControl("btn_lupa_frete_valor"), Anthem.ImageButton)

        'limpa o que veio da lupa
        lbl_inf_frete.Text = String.Empty
        lbl_tipo_caminhao.Text = String.Empty
        lbl_id_central_tabela_frete_veiculos.Text = String.Empty
        lbl_id_veiculo_central_compras.Text = String.Empty
        atualizarGridRowTotalizadores(row.RowIndex)
    End Sub

    Protected Sub cbo_transportador_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs)
        Dim wc As WebControl = CType(sender, WebControl)
        Dim row As GridViewRow = CType(wc.NamingContainer, GridViewRow)

        Dim cbo_transportador As Anthem.DropDownList = CType(row.FindControl("cbo_transportador"), Anthem.DropDownList)
        Dim txt_nr_frete As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_frete"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
        Dim lbl_tipo_caminhao As Anthem.Label = CType(row.FindControl("lbl_tipo_caminhao"), Anthem.Label)
        Dim lbl_total_item As Anthem.Label = CType(row.FindControl("lbl_total_item"), Anthem.Label)
        Dim lbl_total_frete As Anthem.Label = CType(row.FindControl("lbl_total_frete"), Anthem.Label)
        Dim lbl_valor_total As Anthem.Label = CType(row.FindControl("lbl_valor_total"), Anthem.Label)
        Dim lbl_id_central_tabela_frete_veiculos As Label = CType(row.FindControl("lbl_id_central_tabela_frete_veiculos"), System.Web.UI.WebControls.Label)
        Dim lbl_id_veiculo_central_compras As Label = CType(row.FindControl("lbl_id_veiculo_central_compras"), System.Web.UI.WebControls.Label)
        Dim lbl_inf_frete As Label = CType(row.FindControl("lbl_inf_frete"), Label)
        Dim btn_lupa_frete As Anthem.ImageButton = CType(row.FindControl("btn_lupa_frete_valor"), Anthem.ImageButton)

        txt_nr_frete.Text = String.Empty
        lbl_inf_frete.Text = String.Empty
        lbl_tipo_caminhao.Text = String.Empty
        lbl_id_central_tabela_frete_veiculos.Text = String.Empty
        lbl_id_veiculo_central_compras.Text = String.Empty
        lbl_valor_total.Text = lbl_total_item.Text
        lbl_total_frete.Text = String.Empty
        If CInt(cbo_transportador.SelectedValue) = 0 Then
            btn_lupa_frete.Enabled = False
            txt_nr_frete.Enabled = False
        Else
            btn_lupa_frete.Enabled = True
            txt_nr_frete.Enabled = True

            If Not txt_nr_frete_geral.Text.Equals(String.Empty) Then
                txt_nr_frete.Text = txt_nr_frete_geral.Text

                atualizarGridRowTotalizadores(row.RowIndex)
            End If

        End If


    End Sub

    Protected Sub cbo_tipo_frete_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles cbo_tipo_frete.SelectedIndexChanged

        If cbo_tipo_frete.SelectedValue = "D" Then
            txt_nr_frete_geral.Enabled = True
        Else
            txt_nr_frete_geral.Enabled = False
            txt_nr_frete_geral.Text = String.Empty
        End If
        If (Me.ViewState("gridLinhasAdicionadas") IsNot Nothing) Then

            Dim pessoa As New Pessoa
            pessoa.id_situacao = 1
            pessoa.st_transportador_central = "S"
            Dim dstransportador As DataSet = pessoa.getTransportadorCentralByFilters()

            Dim row As GridViewRow
            For Each row In gridResults.Rows
                If row.Visible = True Then
                    Dim lbl_total_item As Anthem.Label = CType(row.FindControl("lbl_total_item"), Anthem.Label)
                    Dim cbo_transportador As Anthem.DropDownList = CType(row.FindControl("cbo_transportador"), Anthem.DropDownList)
                    Dim id_transportador As Anthem.Label = CType(row.FindControl("id_transportador"), Anthem.Label)
                    Dim lbl_tipo_caminhao As Anthem.Label = CType(row.FindControl("lbl_tipo_caminhao"), Anthem.Label)
                    Dim txt_nr_frete As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_frete"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
                    Dim lbl_total_frete As Anthem.Label = CType(row.FindControl("lbl_total_frete"), Anthem.Label)
                    Dim lbl_valor_total As Anthem.Label = CType(row.FindControl("lbl_valor_total"), Anthem.Label)
                    Dim lbl_id_central_tabela_frete_veiculos As Anthem.Label = CType(row.FindControl("lbl_id_central_tabela_frete_veiculos"), Anthem.Label)
                    Dim lbl_id_veiculo_central_compras As Anthem.Label = CType(row.FindControl("lbl_id_veiculo_central_compras"), Anthem.Label)
                    Dim lbl_inf_frete As Anthem.Label = CType(row.FindControl("lbl_inf_frete"), Anthem.Label)
                    Dim trfrete As HtmlTableRow = CType(row.FindControl("tr_frete"), HtmlTableRow)

                    txt_nr_frete.Text = String.Empty
                    lbl_inf_frete.Text = String.Empty
                    lbl_tipo_caminhao.Text = String.Empty
                    lbl_id_central_tabela_frete_veiculos.Text = String.Empty
                    lbl_id_veiculo_central_compras.Text = String.Empty
                    lbl_valor_total.Text = lbl_total_item.Text
                    lbl_total_frete.Text = String.Empty
                    id_transportador.Text = String.Empty

                    If cbo_pedido_indireto.SelectedValue.Equals("N") AndAlso cbo_tipo_frete.SelectedValue.Equals("D") Then
                        trfrete.Visible = True

                        'transportador central
                        cbo_transportador.DataSource = dstransportador
                        cbo_transportador.DataTextField = "nm_pessoa"
                        cbo_transportador.DataValueField = "id_pessoa"
                        cbo_transportador.DataBind()
                        cbo_transportador.Items.Insert(0, New ListItem("[Selecione]", 0))
                        cbo_transportador.SelectedValue = "0"

                    Else
                        trfrete.Visible = False
                    End If

                End If
            Next

        End If


    End Sub


    Protected Sub txt_nr_sacaria_TextChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles txt_nr_sacaria.TextChanged

    End Sub

  
    Protected Sub btn_atualizar_frete_Click(ByVal sender As Object, ByVal e As System.Web.UI.ImageClickEventArgs) Handles btn_atualizar_frete.Click
        'Varrer o grid atualizado valor do frete para quem nao selecionou tabela de frete
    End Sub


    Protected Sub txt_nr_qtde_TextChanged(ByVal sender As Object, ByVal e As System.EventArgs)
        Dim wc As WebControl = CType(sender, WebControl)
        Dim row As GridViewRow = CType(wc.NamingContainer, GridViewRow)
        Dim txt_nr_qtde As RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox = CType(row.FindControl("txt_nr_qtde"), RK.TextBox.AjaxOnlyDecimal.OnlyDecimalTextBox)
        Dim lbl_qtde As Label = CType(row.FindControl("lbl_qtde"), Label)

        'pega a quantidade anteior
        Dim lnr_qtde_ant As Decimal = 0
        Dim lnr_qtde_incluida As Decimal = 0
        Dim lnr_qtde_total As Decimal = 0
        If lbl_qtde.Text.Equals(String.Empty) Then
            lnr_qtde_ant = 0
        Else
            lnr_qtde_ant = CDec(lbl_qtde.Text)
        End If
        If txt_nr_qtde_total.Text = String.Empty Then
            lnr_qtde_total = 0
        Else
            lnr_qtde_total = CDec(txt_nr_qtde_total.Text)
        End If

        If lbl_qtde_incluida.Text = String.Empty Then
            lnr_qtde_incluida = 0
        Else
            lnr_qtde_incluida = CDec(lbl_qtde_incluida.Text)
        End If

        'se esta mudando qtde para zero ou vazio, não precio somar valor à qtde incluidas apenas subtrair
        If txt_nr_qtde.Text.Equals(String.Empty) OrElse CDec(txt_nr_qtde.Text).Equals(0) Then
            lnr_qtde_incluida = lnr_qtde_incluida - lnr_qtde_ant
            lbl_qtde.Text = "0"
        Else
            lnr_qtde_incluida = lnr_qtde_incluida - lnr_qtde_ant + CDec(txt_nr_qtde.Text)
            lbl_qtde.Text = txt_nr_qtde.Text 'atualiza a quatidade do grid escondida para o novo valor da qtde
        End If
        If lnr_qtde_incluida = 0 Then
            lbl_qtde_incluida.Text = String.Empty
        Else
            lbl_qtde_incluida.Text = FormatNumber(lnr_qtde_incluida, 4).ToString

            If lnr_qtde_total > lnr_qtde_incluida Then
                lbl_qtde_incluida.ForeColor = Drawing.Color.Blue
            End If
            If lnr_qtde_incluida > lnr_qtde_total Then
                lbl_qtde_incluida.ForeColor = Drawing.Color.Red
            End If

        End If

        atualizarGridRowTotalizadores(row.RowIndex)

    End Sub

    Protected Sub txt_nr_qtde_total_TextChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles txt_nr_qtde_total.TextChanged

    End Sub
End Class